

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>analysator.plot.plot_threeslice &mdash; analysator  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=9edc463e" />

  
      <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../_static/documentation_options.js?v=187304be"></script>
      <script src="../../../../_static/doctools.js?v=fd6eb6e6"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=6ffebe34"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="author" title="About these documents" href="../../../../about/" />
    <link rel="index" title="Index" href="../../../../genindex/" />
    <link rel="search" title="Search" href="../../../../search/" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../" class="icon icon-home">
            analysator
              <img src="../../../../_static/logo_color.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search/" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../analysator/">Introduction to Analysator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../analysator_exercises/">Analysator exercises</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../analysator_supported/">Analysator supported data reducers and vlasiator variables</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Analysator reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../plot/">plot</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../calculations/">calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../vlsvfile/">vlsvfile</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../miscellaneous/">miscellaneous</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../scripts/">scripts</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contribution guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../contribution_code/">Contributing code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contribution_doc/">Contributing to documentation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">About</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../about/">Credits</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../">analysator</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../">analysator</a></li>
          <li class="breadcrumb-item"><a href="../">analysator.plot</a></li>
      <li class="breadcrumb-item active">analysator.plot.plot_threeslice</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for analysator.plot.plot_threeslice</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">analysator</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span><span class="o">,</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">glob</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mpl_toolkits.axes_grid1</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_axes_locatable</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="kn">import</span> <span class="n">BoundaryNorm</span><span class="p">,</span><span class="n">LogNorm</span><span class="p">,</span><span class="n">SymLogNorm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="kn">import</span> <span class="n">LightSource</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.ticker</span><span class="w"> </span><span class="kn">import</span> <span class="n">MaxNLocator</span><span class="p">,</span> <span class="n">MultipleLocator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.ticker</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogLocator</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.ticker</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mtick</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">colormaps</span> <span class="k">as</span> <span class="n">cmaps</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.cbook</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_sample_data</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mpl_toolkits.axes_grid1.inset_locator</span><span class="w"> </span><span class="kn">import</span> <span class="n">inset_axes</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">packaging.version</span><span class="w"> </span><span class="kn">import</span> <span class="n">Version</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">..calculations</span><span class="w"> </span><span class="kn">import</span> <span class="n">ids3d</span>
<span class="c1">#from mpl_toolkits.mplot3d import axes3d</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">cm</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">mpl_toolkits.mplot3d.art3d</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">art3d</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>


<span class="c1"># Create the 3d axes and the coordinate axes for the 3d plot</span>
<span class="k">def</span><span class="w"> </span><span class="nf">axes3d</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">reflevel</span><span class="p">,</span> <span class="n">cutpoint</span><span class="p">,</span> <span class="n">boxcoords</span><span class="p">,</span> <span class="n">axisunit</span><span class="p">,</span> <span class="n">axisunituse</span><span class="p">,</span> <span class="n">tickinterval</span><span class="p">,</span> <span class="n">fixedticks</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span>
           <span class="n">thick</span><span class="p">,</span> <span class="n">axiscolor</span><span class="p">,</span> <span class="n">viewangle</span><span class="p">,</span> <span class="n">halfaxes</span><span class="p">,</span> <span class="n">slices</span><span class="p">,</span> <span class="n">drawEarth</span><span class="p">):</span>

    <span class="n">Re</span> <span class="o">=</span> <span class="mf">6371e3</span>
    <span class="n">deg2rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.</span>
    <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">8</span><span class="o">*</span><span class="n">scale</span>
    <span class="n">maxextent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">([</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">-</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">4</span><span class="p">]])</span>
    <span class="n">axextents</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">boxcoords</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.1</span><span class="o">*</span><span class="n">maxextent</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="p">(</span><span class="n">xr</span><span class="p">,</span><span class="n">yr</span><span class="p">,</span><span class="n">zr</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="n">cutpoint</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">axisunituse</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)]</span>

    <span class="c1"># Create 3d axes</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">.1</span><span class="p">,</span><span class="mf">.1</span><span class="p">,</span><span class="mf">.64</span><span class="p">,</span><span class="mf">.8</span><span class="p">],</span><span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>

    <span class="c1"># Thickness</span>
    <span class="n">linewidth3d</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">thick</span>
    <span class="n">tickwidth3d</span><span class="o">=</span><span class="mf">0.25</span><span class="o">*</span><span class="n">thick</span>
    <span class="c1"># Arrow size</span>
    <span class="n">axisarrowscale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cbrt</span><span class="p">((</span><span class="n">axextents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">axextents</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">axextents</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">axextents</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">axextents</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">-</span><span class="n">axextents</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span><span class="o">*</span><span class="mf">0.015</span>
    <span class="c1"># Tick size</span>
    <span class="n">ticklength</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cbrt</span><span class="p">((</span><span class="n">axextents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">axextents</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">axextents</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">axextents</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">axextents</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">-</span><span class="n">axextents</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span><span class="o">*</span><span class="mf">0.012</span>

    <span class="c1"># Dealing with the plot orientation</span>
    <span class="n">azi</span><span class="p">,</span><span class="n">ele</span> <span class="o">=</span> <span class="n">viewangle</span>
    <span class="k">if</span> <span class="n">azi</span> <span class="o">&gt;</span> <span class="mf">180.</span><span class="p">:</span> <span class="c1"># Make sure azimuths are within ]-180.,180]</span>
        <span class="n">azi</span> <span class="o">=</span> <span class="n">azi</span> <span class="o">-</span> <span class="mf">360.</span>
    <span class="k">if</span> <span class="n">azi</span><span class="o">%</span><span class="mf">90.</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">:</span> <span class="c1"># Dirty hack to avoid potential division by zero later</span>
        <span class="n">azi</span> <span class="o">=</span> <span class="n">azi</span> <span class="o">+</span> <span class="mf">1e-15</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">azim</span> <span class="o">=</span> <span class="n">azi</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">elev</span> <span class="o">=</span> <span class="n">ele</span>

    <span class="c1"># Near-Earth break distances if an axis line goes through the Earth</span>
    <span class="n">RePerAxUnit</span> <span class="o">=</span> <span class="n">Re</span><span class="o">/</span><span class="n">axisunituse</span>
    <span class="p">(</span><span class="n">cXm</span><span class="p">,</span> <span class="n">cXp</span><span class="p">,</span> <span class="n">cYm</span><span class="p">,</span> <span class="n">cYp</span><span class="p">,</span> <span class="n">cZm</span><span class="p">,</span> <span class="n">cZp</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">RePerAxUnit</span><span class="p">,</span><span class="n">RePerAxUnit</span><span class="p">,</span><span class="n">RePerAxUnit</span><span class="p">,</span><span class="n">RePerAxUnit</span><span class="p">,</span><span class="n">RePerAxUnit</span><span class="p">,</span><span class="n">RePerAxUnit</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">azi</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">90.</span><span class="p">:</span>
        <span class="n">cXm</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ele</span><span class="o">*</span><span class="n">deg2rad</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">azi</span><span class="o">*</span><span class="n">deg2rad</span><span class="p">)))</span><span class="o">*</span><span class="n">RePerAxUnit</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cXp</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ele</span><span class="o">*</span><span class="n">deg2rad</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">azi</span><span class="o">*</span><span class="n">deg2rad</span><span class="p">)))</span><span class="o">*</span><span class="n">RePerAxUnit</span>
    <span class="k">if</span> <span class="n">azi</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="n">cYm</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ele</span><span class="o">*</span><span class="n">deg2rad</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">azi</span><span class="o">*</span><span class="n">deg2rad</span><span class="p">)))</span><span class="o">*</span><span class="n">RePerAxUnit</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cYp</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ele</span><span class="o">*</span><span class="n">deg2rad</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">azi</span><span class="o">*</span><span class="n">deg2rad</span><span class="p">)))</span><span class="o">*</span><span class="n">RePerAxUnit</span>
    <span class="k">if</span> <span class="n">ele</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="n">cZm</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ele</span><span class="o">*</span><span class="n">deg2rad</span><span class="p">))</span><span class="o">*</span><span class="n">RePerAxUnit</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cZp</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ele</span><span class="o">*</span><span class="n">deg2rad</span><span class="p">))</span><span class="o">*</span><span class="n">RePerAxUnit</span>

    <span class="c1"># Earth-breaking conditions</span>
    <span class="n">earthbreak_x</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">yr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">RePerAxUnit</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">zr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">RePerAxUnit</span> <span class="ow">and</span> <span class="n">axextents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">axextents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.</span>
    <span class="n">earthbreak_y</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">xr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">RePerAxUnit</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">zr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">RePerAxUnit</span> <span class="ow">and</span> <span class="n">axextents</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">axextents</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.</span>
    <span class="n">earthbreak_z</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">xr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">RePerAxUnit</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">yr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">RePerAxUnit</span> <span class="ow">and</span> <span class="n">axextents</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">axextents</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.</span>
    <span class="n">earthvisible</span> <span class="o">=</span> <span class="n">drawEarth</span>
    <span class="c1"># Adapting line styles for axes and near-Earth break distances to the viewing angle</span>
    <span class="n">frontaxisstyle</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">halfaxes</span><span class="p">:</span>
        <span class="n">backaxisstyle</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">backaxisstyle</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">ele</span> <span class="o">&gt;=</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="n">styleZp</span> <span class="o">=</span> <span class="n">frontaxisstyle</span>
        <span class="k">if</span> <span class="s1">&#39;z&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span>
            <span class="n">styleZm</span> <span class="o">=</span> <span class="n">backaxisstyle</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">styleZm</span> <span class="o">=</span> <span class="n">frontaxisstyle</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;z&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span>
            <span class="n">styleZp</span> <span class="o">=</span> <span class="n">backaxisstyle</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">styleZp</span> <span class="o">=</span> <span class="n">frontaxisstyle</span>
        <span class="n">styleZm</span> <span class="o">=</span> <span class="n">frontaxisstyle</span>
    <span class="k">if</span> <span class="n">azi</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">styleYp</span> <span class="o">=</span> <span class="n">frontaxisstyle</span>
        <span class="k">if</span> <span class="s1">&#39;y&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span>
            <span class="n">styleYm</span> <span class="o">=</span> <span class="n">backaxisstyle</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">styleYm</span> <span class="o">=</span> <span class="n">frontaxisstyle</span>
        <span class="n">cYp</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;y&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span>
            <span class="n">styleYp</span> <span class="o">=</span> <span class="n">backaxisstyle</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">styleYp</span> <span class="o">=</span> <span class="n">frontaxisstyle</span>
        <span class="n">styleYm</span> <span class="o">=</span> <span class="n">frontaxisstyle</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">azi</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">90</span><span class="p">:</span>
        <span class="n">styleXp</span> <span class="o">=</span> <span class="n">frontaxisstyle</span>
        <span class="k">if</span> <span class="s1">&#39;x&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span>
            <span class="n">styleXm</span> <span class="o">=</span> <span class="n">backaxisstyle</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">styleXm</span> <span class="o">=</span> <span class="n">frontaxisstyle</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;x&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span>
            <span class="n">styleXp</span> <span class="o">=</span> <span class="n">backaxisstyle</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">styleXp</span> <span class="o">=</span> <span class="n">frontaxisstyle</span>
        <span class="n">styleXm</span> <span class="o">=</span> <span class="n">frontaxisstyle</span>

    <span class="c1"># Coefficients for axis label placement</span>
    <span class="n">labposscale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cbrt</span><span class="p">((</span><span class="n">axextents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">axextents</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">axextents</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">axextents</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">axextents</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">-</span><span class="n">axextents</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span><span class="o">*</span><span class="mf">0.02</span>
    <span class="n">cXlabel</span> <span class="o">=</span> <span class="n">labposscale</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">azi</span><span class="o">*</span><span class="n">deg2rad</span><span class="p">))</span><span class="o">+</span><span class="mf">2.</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">azi</span><span class="o">*</span><span class="n">deg2rad</span><span class="p">)))</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ele</span><span class="o">*</span><span class="n">deg2rad</span><span class="p">)))</span>
    <span class="n">cYlabel</span> <span class="o">=</span> <span class="n">labposscale</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">azi</span><span class="o">*</span><span class="n">deg2rad</span><span class="p">))</span><span class="o">+</span><span class="mf">2.</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">azi</span><span class="o">*</span><span class="n">deg2rad</span><span class="p">)))</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ele</span><span class="o">*</span><span class="n">deg2rad</span><span class="p">)))</span>
    <span class="n">cZlabel</span> <span class="o">=</span> <span class="n">labposscale</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="mf">1.5</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">ele</span><span class="o">*</span><span class="n">deg2rad</span><span class="p">)))</span>

    <span class="c1"># Axes and units (default R_E)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">axisunituse</span><span class="p">,</span><span class="n">Re</span><span class="p">):</span>
        <span class="n">axisunitstr</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">rmstring</span><span class="p">(</span><span class="s1">&#39;R&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">rmstring</span><span class="p">(</span><span class="s1">&#39;E&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">axisunituse</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">axisunitstr</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">rmstring</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">axisunituse</span><span class="p">,</span><span class="mi">1000</span><span class="p">):</span>
        <span class="n">axisunitstr</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">rmstring</span><span class="p">(</span><span class="s1">&#39;km&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axisunitstr</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;10^{&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">axisunit</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;} &#39;</span><span class="o">+</span><span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">rmstring</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">)</span>

    <span class="c1"># Create axis lines intersecting at (xr,yr,zr)</span>
    <span class="c1"># -- x-axis --</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">earthbreak_x</span><span class="p">:</span>
        <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">axextents</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">),</span> <span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">)),</span>
                          <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleXm</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="c1"># this goes from the lowest X to the Earth or the cut point</span>

        <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">),</span> <span class="p">(</span><span class="n">axextents</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">)),</span>
                          <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleXp</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="c1"># this goes from the Earth or the cut point to the highest X</span>

    <span class="k">else</span><span class="p">:</span> <span class="c1"># Special treatment of cases when the x-axis goes through the Earth</span>
        <span class="c1"># Distinguish four cases to avoid overlaying the Earth, based on the earthbreak condition and azi</span>
        <span class="k">if</span> <span class="n">xr</span> <span class="o">&lt;=</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">azi</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">90.</span><span class="p">:</span> <span class="c1"># looking from the dayside, cut point on the nightside</span>
            <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">axextents</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">),</span> <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">xr</span><span class="p">,</span><span class="o">-</span><span class="n">cXm</span><span class="p">),</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">)),</span>
                              <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleXm</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">xr</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">RePerAxUnit</span><span class="p">:</span>
                <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="n">cXm</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">)),</span>
                                  <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleXp</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

            <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">cXp</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">),</span> <span class="p">(</span><span class="n">axextents</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">)),</span>
                              <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleXp</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">xr</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">azi</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">90.</span><span class="p">:</span> <span class="c1"># looking from the dayside, cut point also on the dayside</span>
            <span class="k">if</span> <span class="s1">&#39;x&#39;</span> <span class="ow">in</span> <span class="n">slices</span> <span class="ow">and</span> <span class="n">xr</span> <span class="o">&gt;</span> <span class="n">RePerAxUnit</span><span class="p">:</span> <span class="c1"># Earth effectively hidden by the X slice, no need to break the axis</span>
                <span class="n">earthvisible</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">axextents</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">),</span> <span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">)),</span>
                                  <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleXm</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

                <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">),</span> <span class="p">(</span><span class="n">axextents</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">)),</span>
                                  <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleXp</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">axextents</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="n">cXm</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">)),</span>
                                  <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleXm</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">xr</span> <span class="o">&gt;</span> <span class="n">RePerAxUnit</span><span class="p">:</span>
                    <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">cXp</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">),</span> <span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">)),</span>
                                      <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleXm</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

                <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="nb">max</span><span class="p">(</span><span class="n">xr</span><span class="p">,</span><span class="n">cXp</span><span class="p">),</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">),</span> <span class="p">(</span><span class="n">axextents</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">)),</span>
                                  <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleXp</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">xr</span> <span class="o">&lt;=</span> <span class="mf">0.</span><span class="p">:</span> <span class="c1"># looking from the nightside, cut point also on the nightside</span>
            <span class="k">if</span> <span class="s1">&#39;x&#39;</span> <span class="ow">in</span> <span class="n">slices</span> <span class="ow">and</span> <span class="n">xr</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">RePerAxUnit</span><span class="p">:</span> <span class="c1"># Earth effectively hidden by the X slice, no need to break the axis</span>
                <span class="n">earthvisible</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">axextents</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">),</span> <span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">)),</span>
                                  <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleXm</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

                <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">),</span> <span class="p">(</span><span class="n">axextents</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">)),</span>
                                  <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleXp</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">axextents</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">),</span> <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">xr</span><span class="p">,</span><span class="o">-</span><span class="n">cXm</span><span class="p">),</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">)),</span>
                                  <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleXm</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">xr</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">RePerAxUnit</span><span class="p">:</span>
                    <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="n">cXm</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">)),</span>
                                      <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleXp</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

                <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">cXp</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">),</span> <span class="p">(</span><span class="n">axextents</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">)),</span>
                                  <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleXp</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># looking from the nightside, cut point on the dayside</span>
            <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">axextents</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="n">cXm</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">)),</span>
                              <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleXm</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">xr</span> <span class="o">&gt;</span> <span class="n">RePerAxUnit</span><span class="p">:</span>
                <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">cXp</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">),</span> <span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">)),</span>
                                  <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleXm</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

            <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="nb">max</span><span class="p">(</span><span class="n">xr</span><span class="p">,</span><span class="n">cXp</span><span class="p">),</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">),</span> <span class="p">(</span><span class="n">axextents</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">)),</span>
                              <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleXp</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="c1"># Make an arrow at the end of the axis</span>
    <span class="k">if</span> <span class="n">halfaxes</span> <span class="ow">and</span> <span class="n">styleXp</span> <span class="o">==</span> <span class="n">backaxisstyle</span><span class="p">:</span>
        <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">xr</span><span class="o">-</span><span class="mf">1.7</span><span class="o">*</span><span class="n">axisarrowscale</span><span class="p">,</span> <span class="n">yr</span><span class="o">-</span><span class="n">axisarrowscale</span><span class="p">,</span> <span class="n">zr</span><span class="p">),</span> <span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">),</span>
                               <span class="p">(</span><span class="n">xr</span><span class="o">-</span><span class="mf">1.7</span><span class="o">*</span><span class="n">axisarrowscale</span><span class="p">,</span> <span class="n">yr</span><span class="o">+</span><span class="n">axisarrowscale</span><span class="p">,</span> <span class="n">zr</span><span class="p">)),</span> <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">axextents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mf">1.7</span><span class="o">*</span><span class="n">axisarrowscale</span><span class="p">,</span> <span class="n">yr</span><span class="o">-</span><span class="n">axisarrowscale</span><span class="p">,</span> <span class="n">zr</span><span class="p">),</span> <span class="p">(</span><span class="n">axextents</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">),</span>
                               <span class="p">(</span><span class="n">axextents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mf">1.7</span><span class="o">*</span><span class="n">axisarrowscale</span><span class="p">,</span> <span class="n">yr</span><span class="o">+</span><span class="n">axisarrowscale</span><span class="p">,</span> <span class="n">zr</span><span class="p">)),</span> <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="c1"># -- y-axis --</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">earthbreak_y</span><span class="p">:</span>
        <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">xr</span><span class="p">,</span> <span class="n">axextents</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">zr</span><span class="p">),</span> <span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">)),</span>
                          <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleYm</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="c1"># this goes from the lowest Y to the cut point</span>

        <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">),</span> <span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="n">axextents</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">zr</span><span class="p">)),</span>
                          <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleYp</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="c1"># this goes from the cut point to the highest Y</span>

    <span class="k">else</span><span class="p">:</span> <span class="c1"># Special treatment of cases when the y-axis goes through the Earth</span>
        <span class="c1"># Distinguish four cases to avoid overlaying the Earth, based on the earthbreak condition and azi</span>
        <span class="k">if</span> <span class="n">yr</span> <span class="o">&lt;=</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="n">azi</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span> <span class="c1"># looking from the dawnside, cut point on the duskside</span>
            <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">xr</span><span class="p">,</span> <span class="n">axextents</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">zr</span><span class="p">),</span> <span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">yr</span><span class="p">,</span><span class="o">-</span><span class="n">cYm</span><span class="p">),</span> <span class="n">zr</span><span class="p">)),</span>
                              <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleYm</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">yr</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">RePerAxUnit</span><span class="p">:</span>
                <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">),</span> <span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="o">-</span><span class="n">cYm</span><span class="p">,</span> <span class="n">zr</span><span class="p">)),</span>
                                  <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleYp</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

            <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">xr</span><span class="p">,</span> <span class="n">cYp</span><span class="p">,</span> <span class="n">zr</span><span class="p">),</span> <span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="n">axextents</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">zr</span><span class="p">)),</span>
                              <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleYp</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">yr</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="n">azi</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span> <span class="c1"># looking from the dawnside, cut point also on the dawnside</span>
            <span class="k">if</span> <span class="s1">&#39;y&#39;</span> <span class="ow">in</span> <span class="n">slices</span> <span class="ow">and</span> <span class="n">yr</span> <span class="o">&gt;</span> <span class="n">RePerAxUnit</span><span class="p">:</span> <span class="c1"># Earth effectively hidden by the Y slice, no need to break the axis</span>
                <span class="n">earthvisible</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">xr</span><span class="p">,</span> <span class="n">axextents</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">zr</span><span class="p">),</span> <span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">)),</span>
                                  <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleYm</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

                <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">),</span> <span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="n">axextents</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">zr</span><span class="p">)),</span>
                                  <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleYp</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">xr</span><span class="p">,</span> <span class="n">axextents</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">zr</span><span class="p">),</span> <span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="o">-</span><span class="n">cYm</span><span class="p">,</span> <span class="n">zr</span><span class="p">)),</span>
                                  <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleYm</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">yr</span> <span class="o">&gt;</span> <span class="n">RePerAxUnit</span><span class="p">:</span>
                    <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">xr</span><span class="p">,</span> <span class="n">cYp</span><span class="p">,</span> <span class="n">zr</span><span class="p">),</span> <span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">)),</span>
                                      <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleYm</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

                <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">xr</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">yr</span><span class="p">,</span><span class="n">cYp</span><span class="p">),</span> <span class="n">zr</span><span class="p">),</span> <span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="n">axextents</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">zr</span><span class="p">)),</span>
                                  <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleYp</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">yr</span> <span class="o">&lt;=</span> <span class="mf">0.</span><span class="p">:</span> <span class="c1"># looking from the duskside, cut point also on the duskside</span>
            <span class="k">if</span> <span class="s1">&#39;y&#39;</span> <span class="ow">in</span> <span class="n">slices</span> <span class="ow">and</span> <span class="n">yr</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">RePerAxUnit</span><span class="p">:</span> <span class="c1"># Earth effectively hidden by the Y slice, no need to break the axis</span>
                <span class="n">earthvisible</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">xr</span><span class="p">,</span> <span class="n">axextents</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">zr</span><span class="p">),</span> <span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">)),</span>
                                  <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleYm</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

                <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">),</span> <span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="n">axextents</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">zr</span><span class="p">)),</span>
                                  <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleYp</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">xr</span><span class="p">,</span> <span class="n">axextents</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">zr</span><span class="p">),</span> <span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">yr</span><span class="p">,</span><span class="o">-</span><span class="n">cYm</span><span class="p">),</span> <span class="n">zr</span><span class="p">)),</span>
                                  <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleYm</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">yr</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">RePerAxUnit</span><span class="p">:</span>
                    <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">),</span> <span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="o">-</span><span class="n">cYm</span><span class="p">,</span> <span class="n">zr</span><span class="p">)),</span>
                                      <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleYp</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

                <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">xr</span><span class="p">,</span> <span class="n">cYp</span><span class="p">,</span> <span class="n">zr</span><span class="p">),</span> <span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="n">axextents</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">zr</span><span class="p">)),</span>
                                  <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleYp</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># looking from the duskside, cut point on the dawnside</span>
            <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">xr</span><span class="p">,</span> <span class="n">axextents</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">zr</span><span class="p">),</span> <span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="o">-</span><span class="n">cYm</span><span class="p">,</span> <span class="n">zr</span><span class="p">)),</span>
                              <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleYm</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">yr</span> <span class="o">&gt;</span> <span class="n">RePerAxUnit</span><span class="p">:</span>
                <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">xr</span><span class="p">,</span> <span class="n">cYp</span><span class="p">,</span> <span class="n">zr</span><span class="p">),</span> <span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">)),</span>
                                  <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleYm</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

            <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">xr</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">yr</span><span class="p">,</span><span class="n">cYp</span><span class="p">),</span> <span class="n">zr</span><span class="p">),</span> <span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="n">axextents</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">zr</span><span class="p">)),</span>
                              <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleYp</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="c1"># Make an arrow at the end of the axis</span>
    <span class="k">if</span> <span class="n">halfaxes</span> <span class="ow">and</span> <span class="n">styleYp</span> <span class="o">==</span> <span class="n">backaxisstyle</span><span class="p">:</span>
        <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">xr</span><span class="o">-</span><span class="n">axisarrowscale</span><span class="p">,</span> <span class="n">yr</span><span class="o">-</span><span class="mf">1.7</span><span class="o">*</span><span class="n">axisarrowscale</span><span class="p">,</span> <span class="n">zr</span><span class="p">),</span> <span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">),</span>
                               <span class="p">(</span><span class="n">xr</span><span class="o">+</span><span class="n">axisarrowscale</span><span class="p">,</span> <span class="n">yr</span><span class="o">-</span><span class="mf">1.7</span><span class="o">*</span><span class="n">axisarrowscale</span><span class="p">,</span> <span class="n">zr</span><span class="p">)),</span> <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">xr</span><span class="o">-</span><span class="n">axisarrowscale</span><span class="p">,</span> <span class="n">axextents</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="mf">1.7</span><span class="o">*</span><span class="n">axisarrowscale</span><span class="p">,</span> <span class="n">zr</span><span class="p">),</span> <span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="n">axextents</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">zr</span><span class="p">),</span>
                               <span class="p">(</span><span class="n">xr</span><span class="o">+</span><span class="n">axisarrowscale</span><span class="p">,</span> <span class="n">axextents</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="mf">1.7</span><span class="o">*</span><span class="n">axisarrowscale</span><span class="p">,</span> <span class="n">zr</span><span class="p">)),</span> <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="c1"># -- z-axis --</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">earthbreak_z</span><span class="p">:</span>
        <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">axextents</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span> <span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">)),</span>
                          <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleZm</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="c1"># this goes from the lowest Z to the cut point</span>

        <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">),</span> <span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">axextents</span><span class="p">[</span><span class="mi">5</span><span class="p">])),</span>
                          <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleZp</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="c1"># this goes from the cut point to the highest Z</span>

    <span class="k">else</span><span class="p">:</span> <span class="c1"># Special treatment of cases when the z-axis goes through the Earth</span>
        <span class="c1"># Distinguish four cases to avoid overlaying the Earth, based on the earthbreak condition and ele</span>
        <span class="k">if</span> <span class="n">zr</span> <span class="o">&lt;=</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="n">ele</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span> <span class="c1"># looking from the north, cut point south from the Earth</span>
            <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">axextents</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span> <span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span><span class="o">-</span><span class="n">cZm</span><span class="p">))),</span>
                              <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleZm</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">zr</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">RePerAxUnit</span><span class="p">:</span>
                <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">),</span> <span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="o">-</span><span class="n">cZm</span><span class="p">)),</span>
                                  <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleZp</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

            <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">cZp</span><span class="p">),</span> <span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">axextents</span><span class="p">[</span><span class="mi">5</span><span class="p">])),</span>
                              <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleZp</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">zr</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="n">ele</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span> <span class="c1"># looking from the north, cut point also north from the Earth</span>
            <span class="k">if</span> <span class="s1">&#39;z&#39;</span> <span class="ow">in</span> <span class="n">slices</span> <span class="ow">and</span> <span class="n">zr</span> <span class="o">&gt;</span> <span class="n">RePerAxUnit</span><span class="p">:</span> <span class="c1"># Earth effectively hidden by the Z slice, no need to break the axis</span>
                <span class="n">earthvisible</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">axextents</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span> <span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">)),</span>
                                  <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleZm</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

                <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">),</span> <span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">axextents</span><span class="p">[</span><span class="mi">5</span><span class="p">])),</span>
                                  <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleZp</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">axextents</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span> <span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="o">-</span><span class="n">cZm</span><span class="p">)),</span>
                                  <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleZm</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">zr</span> <span class="o">&gt;</span> <span class="n">RePerAxUnit</span><span class="p">:</span>
                    <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">cZp</span><span class="p">),</span> <span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">)),</span>
                                      <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleZm</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

                <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span><span class="n">cZp</span><span class="p">)),</span> <span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">axextents</span><span class="p">[</span><span class="mi">5</span><span class="p">])),</span>
                                  <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleZp</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">zr</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">:</span> <span class="c1"># looking from the south, cut point also south from the Earth</span>
            <span class="k">if</span> <span class="s1">&#39;z&#39;</span> <span class="ow">in</span> <span class="n">slices</span> <span class="ow">and</span> <span class="n">zr</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">RePerAxUnit</span><span class="p">:</span> <span class="c1"># Earth effectively hidden by the Z slice, no need to break the axis</span>
                <span class="n">earthvisible</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">axextents</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span> <span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">)),</span>
                                  <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleZm</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

                <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">),</span> <span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">axextents</span><span class="p">[</span><span class="mi">5</span><span class="p">])),</span>
                                  <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleZp</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">axextents</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span> <span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span><span class="o">-</span><span class="n">cZm</span><span class="p">))),</span>
                                  <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleZm</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">zr</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">RePerAxUnit</span><span class="p">:</span>
                    <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">),</span> <span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="o">-</span><span class="n">cZm</span><span class="p">)),</span>
                                      <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleZp</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

                <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">cZp</span><span class="p">),</span> <span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">axextents</span><span class="p">[</span><span class="mi">5</span><span class="p">])),</span>
                                  <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleZp</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># looking from the south, cut point north from the Earth</span>
            <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">axextents</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span> <span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="o">-</span><span class="n">cZm</span><span class="p">)),</span>
                              <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleZm</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">zr</span> <span class="o">&gt;</span> <span class="n">RePerAxUnit</span><span class="p">:</span>
                <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">cZp</span><span class="p">),</span> <span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">)),</span>
                                  <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleZm</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

            <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span><span class="n">cZp</span><span class="p">)),</span> <span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">axextents</span><span class="p">[</span><span class="mi">5</span><span class="p">])),</span>
                              <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styleZp</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

 <span class="c1"># Make an arrow at the end of the axis</span>
    <span class="k">if</span> <span class="n">halfaxes</span> <span class="ow">and</span> <span class="n">styleZp</span> <span class="o">==</span> <span class="n">backaxisstyle</span><span class="p">:</span>
        <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">xr</span><span class="o">-</span><span class="n">axisarrowscale</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="o">-</span><span class="mf">1.7</span><span class="o">*</span><span class="n">axisarrowscale</span><span class="p">),</span> <span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">),</span>
                               <span class="p">(</span><span class="n">xr</span><span class="o">+</span><span class="n">axisarrowscale</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="o">-</span><span class="mf">1.7</span><span class="o">*</span><span class="n">axisarrowscale</span><span class="p">)),</span> <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">line</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">xr</span><span class="o">-</span><span class="n">axisarrowscale</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">axextents</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">-</span><span class="mf">1.7</span><span class="o">*</span><span class="n">axisarrowscale</span><span class="p">),</span> <span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">axextents</span><span class="p">[</span><span class="mi">5</span><span class="p">]),</span>
                               <span class="p">(</span><span class="n">xr</span><span class="o">+</span><span class="n">axisarrowscale</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">axextents</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">-</span><span class="mf">1.7</span><span class="o">*</span><span class="n">axisarrowscale</span><span class="p">)),</span> <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="n">xlabelstr</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">mathmode</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bfstring</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;X\,[&#39;</span><span class="o">+</span><span class="n">axisunitstr</span><span class="o">+</span><span class="s1">&#39;]&#39;</span><span class="p">))</span>
    <span class="n">ylabelstr</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">mathmode</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bfstring</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Y\,[&#39;</span><span class="o">+</span><span class="n">axisunitstr</span><span class="o">+</span><span class="s1">&#39;]&#39;</span><span class="p">))</span>
    <span class="n">zlabelstr</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">mathmode</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bfstring</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Z\,[&#39;</span><span class="o">+</span><span class="n">axisunitstr</span><span class="o">+</span><span class="s1">&#39;]&#39;</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">halfaxes</span> <span class="ow">and</span> <span class="n">styleXp</span> <span class="o">==</span> <span class="n">backaxisstyle</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">axextents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">cXlabel</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">,</span><span class="n">xlabelstr</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span><span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">axextents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">cXlabel</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">,</span><span class="n">xlabelstr</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span><span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">halfaxes</span> <span class="ow">and</span> <span class="n">styleYp</span> <span class="o">==</span> <span class="n">backaxisstyle</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="n">axextents</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">cYlabel</span><span class="p">,</span> <span class="n">zr</span><span class="p">,</span><span class="n">ylabelstr</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span><span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="n">axextents</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">cYlabel</span><span class="p">,</span> <span class="n">zr</span><span class="p">,</span><span class="n">ylabelstr</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span><span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">halfaxes</span> <span class="ow">and</span> <span class="n">styleZp</span> <span class="o">==</span> <span class="n">backaxisstyle</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">axextents</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">-</span><span class="n">cZlabel</span><span class="p">,</span><span class="n">zlabelstr</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span><span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">axextents</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">+</span><span class="n">cZlabel</span><span class="p">,</span><span class="n">zlabelstr</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span><span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>

    <span class="c1"># Addition of the Earth at the origin of the domain</span>
    <span class="k">if</span> <span class="n">earthvisible</span><span class="p">:</span>
        <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">:</span><span class="mi">40</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">:</span><span class="mi">20</span><span class="n">j</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">RePerAxUnit</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">RePerAxUnit</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">RePerAxUnit</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">albedo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">albedo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="o">-</span><span class="mf">50.</span><span class="o">*</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">+</span><span class="mf">0.5</span>
        <span class="n">levels</span> <span class="o">=</span> <span class="n">MaxNLocator</span><span class="p">(</span><span class="n">nbins</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">tick_values</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">BoundaryNorm</span><span class="p">(</span><span class="n">levels</span><span class="p">,</span> <span class="n">ncolors</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">scalarmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys&#39;</span><span class="p">,</span><span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">facecolors</span><span class="o">=</span><span class="n">scalarmap</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">albedo</span><span class="p">),</span><span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">3</span><span class="p">]])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_zlim</span><span class="p">([</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">5</span><span class="p">]])</span>

    <span class="c1"># ex.axis(&#39;equal&#39;) is broken and either does not work at all or produces incorrect output.</span>
    <span class="c1"># these are possible alternative approaches</span>
    <span class="c1"># ax.auto_scale_xyz([minbound, maxbound], [minbound, maxbound], [minbound, maxbound])</span>
    <span class="c1">#  or </span>
    <span class="c1"># limits = np.array([getattr(self.ax, f&#39;get_{axis}lim&#39;)() for axis in &#39;xyz&#39;])</span>
    <span class="c1"># ax.set_box_aspect(np.ptp(limits, axis = 1))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">limits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="s1">&#39;get_</span><span class="si">{}</span><span class="s1">lim&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">axis</span><span class="p">))()</span> <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="s1">&#39;xyz&#39;</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_box_aspect</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">limits</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;ax.set_box_aspect() failed (not supported by this version of matplotlib?).&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">auto_scale_xyz</span><span class="p">([</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">1</span><span class="p">]],[</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">3</span><span class="p">]],[</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">5</span><span class="p">]])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;ax.auto_scale_xyz() failed (not supported by this version of matplotlib?).&quot;</span><span class="p">)</span>

    <span class="c1"># Draw ticks</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">fixedticks</span><span class="p">:</span> <span class="c1"># Ticks are relative to the triple point</span>
        <span class="n">txm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">xr</span><span class="p">,</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span><span class="o">-</span><span class="n">tickinterval</span><span class="o">/</span><span class="n">axisunituse</span><span class="p">)</span>
        <span class="n">txp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">xr</span><span class="p">,</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mf">0.1</span><span class="p">,</span><span class="n">tickinterval</span><span class="o">/</span><span class="n">axisunituse</span><span class="p">)</span>
        <span class="n">ticks_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">txm</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span><span class="n">txp</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>

        <span class="n">tym</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">yr</span><span class="p">,</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span><span class="o">-</span><span class="n">tickinterval</span><span class="o">/</span><span class="n">axisunituse</span><span class="p">)</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">yr</span><span class="p">,</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="mf">0.1</span><span class="p">,</span><span class="n">tickinterval</span><span class="o">/</span><span class="n">axisunituse</span><span class="p">)</span>
        <span class="n">ticks_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">tym</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span><span class="n">typ</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>

        <span class="n">tzm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span><span class="o">-</span><span class="n">tickinterval</span><span class="o">/</span><span class="n">axisunituse</span><span class="p">)</span>
        <span class="n">tzp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">+</span><span class="mf">0.1</span><span class="p">,</span><span class="n">tickinterval</span><span class="o">/</span><span class="n">axisunituse</span><span class="p">)</span>
        <span class="n">ticks_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">tzm</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span><span class="n">tzp</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1"># Ticks are relative to (0,0,0)</span>
        <span class="n">txm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span><span class="o">-</span><span class="n">tickinterval</span><span class="o">/</span><span class="n">axisunituse</span><span class="p">)</span>
        <span class="n">txp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mf">0.1</span><span class="p">,</span><span class="n">tickinterval</span><span class="o">/</span><span class="n">axisunituse</span><span class="p">)</span>
        <span class="n">ticks_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">txm</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span><span class="n">txp</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>

        <span class="n">tym</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span><span class="o">-</span><span class="n">tickinterval</span><span class="o">/</span><span class="n">axisunituse</span><span class="p">)</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="mf">0.1</span><span class="p">,</span><span class="n">tickinterval</span><span class="o">/</span><span class="n">axisunituse</span><span class="p">)</span>
        <span class="n">ticks_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">tym</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span><span class="n">typ</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>

        <span class="n">tzm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span><span class="o">-</span><span class="n">tickinterval</span><span class="o">/</span><span class="n">axisunituse</span><span class="p">)</span>
        <span class="n">tzp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">+</span><span class="mf">0.1</span><span class="p">,</span><span class="n">tickinterval</span><span class="o">/</span><span class="n">axisunituse</span><span class="p">)</span>
        <span class="n">ticks_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">tzm</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span><span class="n">tzp</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>

    <span class="c1"># Avoid placing a tick on the Earth if it is visible in the plot</span>
    <span class="k">if</span> <span class="n">earthbreak_x</span> <span class="ow">and</span> <span class="n">earthvisible</span><span class="p">:</span>
        <span class="n">ticks_x</span> <span class="o">=</span> <span class="n">ticks_x</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">ticks_x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">RePerAxUnit</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">earthbreak_y</span> <span class="ow">and</span> <span class="n">earthvisible</span><span class="p">:</span>
        <span class="n">ticks_y</span> <span class="o">=</span> <span class="n">ticks_y</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">ticks_y</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">RePerAxUnit</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">earthbreak_z</span> <span class="ow">and</span> <span class="n">earthvisible</span><span class="p">:</span>
        <span class="n">ticks_z</span> <span class="o">=</span> <span class="n">ticks_z</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">ticks_z</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">RePerAxUnit</span><span class="p">]</span>

    <span class="c1"># Remove possible ticks outside of the specified box</span>
    <span class="n">ticks_x</span> <span class="o">=</span> <span class="n">ticks_x</span><span class="p">[</span><span class="n">ticks_x</span> <span class="o">&gt;=</span> <span class="n">axextents</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">ticks_x</span> <span class="o">=</span> <span class="n">ticks_x</span><span class="p">[</span><span class="n">ticks_x</span> <span class="o">&lt;=</span> <span class="n">axextents</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">ticks_y</span> <span class="o">=</span> <span class="n">ticks_y</span><span class="p">[</span><span class="n">ticks_y</span> <span class="o">&gt;=</span> <span class="n">axextents</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
    <span class="n">ticks_y</span> <span class="o">=</span> <span class="n">ticks_y</span><span class="p">[</span><span class="n">ticks_y</span> <span class="o">&lt;=</span> <span class="n">axextents</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
    <span class="n">ticks_z</span> <span class="o">=</span> <span class="n">ticks_z</span><span class="p">[</span><span class="n">ticks_z</span> <span class="o">&gt;=</span> <span class="n">axextents</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span>
    <span class="n">ticks_z</span> <span class="o">=</span> <span class="n">ticks_z</span><span class="p">[</span><span class="n">ticks_z</span> <span class="o">&lt;=</span> <span class="n">axextents</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span>


    <span class="k">if</span> <span class="n">halfaxes</span><span class="p">:</span> <span class="c1"># do not create ticks if back axes are not shown</span>
        <span class="k">if</span> <span class="n">styleXp</span> <span class="o">==</span> <span class="n">backaxisstyle</span><span class="p">:</span>
            <span class="n">ticks_x</span> <span class="o">=</span> <span class="n">ticks_x</span><span class="p">[</span><span class="n">ticks_x</span> <span class="o">&lt;=</span> <span class="n">xr</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ticks_x</span> <span class="o">=</span> <span class="n">ticks_x</span><span class="p">[</span><span class="n">ticks_x</span> <span class="o">&gt;=</span> <span class="n">xr</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">itick</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">ticks_x</span><span class="p">)):</span>
        <span class="n">tick</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">ticks_x</span><span class="p">[</span><span class="n">itick</span><span class="p">],</span><span class="n">yr</span><span class="o">-</span><span class="n">ticklength</span><span class="p">,</span><span class="n">zr</span><span class="p">),(</span><span class="n">ticks_x</span><span class="p">[</span><span class="n">itick</span><span class="p">],</span><span class="n">yr</span><span class="o">+</span><span class="n">ticklength</span><span class="p">,</span><span class="n">zr</span><span class="p">)),</span>
                          <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">tickwidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">tick</span><span class="p">)</span>

        <span class="n">tick</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">ticks_x</span><span class="p">[</span><span class="n">itick</span><span class="p">],</span><span class="n">yr</span><span class="p">,</span><span class="n">zr</span><span class="o">-</span><span class="n">ticklength</span><span class="p">),(</span><span class="n">ticks_x</span><span class="p">[</span><span class="n">itick</span><span class="p">],</span><span class="n">yr</span><span class="p">,</span><span class="n">zr</span><span class="o">+</span><span class="n">ticklength</span><span class="p">)),</span>
                          <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">tickwidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">tick</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">xr</span> <span class="o">&lt;</span> <span class="n">RePerAxUnit</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">yr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">RePerAxUnit</span><span class="p">:</span> <span class="c1"># avoid placing a tick on the Earth if it is visible in the plot</span>
        <span class="n">ticks_y</span> <span class="o">=</span> <span class="n">ticks_y</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">ticks_y</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">RePerAxUnit</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">halfaxes</span><span class="p">:</span> <span class="c1"># do not create ticks if back axes are not shown</span>
        <span class="k">if</span> <span class="n">styleYp</span> <span class="o">==</span> <span class="n">backaxisstyle</span><span class="p">:</span>
            <span class="n">ticks_y</span> <span class="o">=</span> <span class="n">ticks_y</span><span class="p">[</span><span class="n">ticks_y</span> <span class="o">&lt;=</span> <span class="n">yr</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ticks_y</span> <span class="o">=</span> <span class="n">ticks_y</span><span class="p">[</span><span class="n">ticks_y</span> <span class="o">&gt;=</span> <span class="n">yr</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">itick</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">ticks_y</span><span class="p">)):</span>
        <span class="n">tick</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">xr</span><span class="o">-</span><span class="n">ticklength</span><span class="p">,</span><span class="n">ticks_y</span><span class="p">[</span><span class="n">itick</span><span class="p">],</span><span class="n">zr</span><span class="p">),(</span><span class="n">xr</span><span class="o">+</span><span class="n">ticklength</span><span class="p">,</span><span class="n">ticks_y</span><span class="p">[</span><span class="n">itick</span><span class="p">],</span><span class="n">zr</span><span class="p">)),</span>
                          <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">tickwidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">tick</span><span class="p">)</span>

        <span class="n">tick</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">xr</span><span class="p">,</span><span class="n">ticks_y</span><span class="p">[</span><span class="n">itick</span><span class="p">],</span><span class="n">zr</span><span class="o">-</span><span class="n">ticklength</span><span class="p">),(</span><span class="n">xr</span><span class="p">,</span><span class="n">ticks_y</span><span class="p">[</span><span class="n">itick</span><span class="p">],</span><span class="n">zr</span><span class="o">+</span><span class="n">ticklength</span><span class="p">)),</span>
                          <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">tickwidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">tick</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">xr</span> <span class="o">&lt;</span> <span class="n">RePerAxUnit</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">zr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">RePerAxUnit</span><span class="p">:</span> <span class="c1"># avoid placing a tick on the Earth if it is visible in the plot</span>
        <span class="n">ticks_z</span> <span class="o">=</span> <span class="n">ticks_z</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">ticks_z</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">RePerAxUnit</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">halfaxes</span><span class="p">:</span> <span class="c1"># do not create ticks if back axes are not shown</span>
        <span class="k">if</span> <span class="n">styleZp</span> <span class="o">==</span> <span class="n">backaxisstyle</span><span class="p">:</span>
            <span class="n">ticks_z</span> <span class="o">=</span> <span class="n">ticks_z</span><span class="p">[</span><span class="n">ticks_z</span> <span class="o">&lt;=</span> <span class="n">zr</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ticks_z</span> <span class="o">=</span> <span class="n">ticks_z</span><span class="p">[</span><span class="n">ticks_z</span> <span class="o">&gt;=</span> <span class="n">zr</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">itick</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">ticks_z</span><span class="p">)):</span>
        <span class="n">tick</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">xr</span><span class="o">-</span><span class="n">ticklength</span><span class="p">,</span><span class="n">yr</span><span class="p">,</span><span class="n">ticks_z</span><span class="p">[</span><span class="n">itick</span><span class="p">]),(</span><span class="n">xr</span><span class="o">+</span><span class="n">ticklength</span><span class="p">,</span><span class="n">yr</span><span class="p">,</span><span class="n">ticks_z</span><span class="p">[</span><span class="n">itick</span><span class="p">])),</span>
                          <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">tickwidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">tick</span><span class="p">)</span>

        <span class="n">tick</span><span class="o">=</span><span class="n">art3d</span><span class="o">.</span><span class="n">Line3D</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">((</span><span class="n">xr</span><span class="p">,</span><span class="n">yr</span><span class="o">-</span><span class="n">ticklength</span><span class="p">,</span><span class="n">ticks_z</span><span class="p">[</span><span class="n">itick</span><span class="p">]),(</span><span class="n">xr</span><span class="p">,</span><span class="n">yr</span><span class="o">+</span><span class="n">ticklength</span><span class="p">,</span><span class="n">ticks_z</span><span class="p">[</span><span class="n">itick</span><span class="p">])),</span>
                          <span class="n">color</span><span class="o">=</span><span class="n">axiscolor</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">tickwidth3d</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">tick</span><span class="p">)</span>

    <span class="c1"># set the basic 3d coordinate axes off</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>

    <span class="c1"># return axes</span>
    <span class="k">return</span> <span class="n">ax</span>




<div class="viewcode-block" id="plot_threeslice">
<a class="viewcode-back" href="../../../../plot/#analysator.plot.plot_threeslice">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_threeslice</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">vlsvobj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">filedir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">outputdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outputfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">nooverwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">var</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">operator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">boxm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">boxre</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">colormap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">symmetric</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">absolute</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">lin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">symlog</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nocb</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">cbtitle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">halfaxes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">usesci</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axisunit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">axiscolor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">shadings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">tickinterval</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fixedticks</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">pass_full</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">wmark</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">wmarkb</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">nomask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">Earth</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                  <span class="n">thick</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                  <span class="n">expression</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">vscale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">viewangle</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">60.</span><span class="p">,</span><span class="mf">30.</span><span class="p">),</span>
                  <span class="n">cutpointm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">cutpointre</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">slices</span><span class="o">=</span><span class="kc">None</span>
                  <span class="p">):</span>

<span class="w">    </span><span class="sd">&#39;&#39;&#39; Plots a 3d plot constructed of three 2d cut throughs.</span>

<span class="sd">    :kwarg filename:    path to .vlsv file to use for input. Assumes a bulk file.</span>
<span class="sd">    :kwarg vlsvobj:     Optionally provide a python vlsvfile object instead</span>
<span class="sd">    :kwarg filedir:     Optionally provide directory where files are located and use step for bulk file name</span>
<span class="sd">    :kwarg step:        output step index, used for constructing output (and possibly input) filename</span>
<span class="sd">    :kwarg run:         run identifier, used for constructing output filename</span>
<span class="sd">    :kwarg outputdir:   path to directory where output files are created (default: $HOME/Plots/ or override with PTOUTPUTDIR)</span>
<span class="sd">                        If directory does not exist, it will be created. If the string does not end in a</span>
<span class="sd">                        forward slash, the final part will be used as a prefix for the files.</span>
<span class="sd">    :kwarg outputfile:  Singular output file name</span>
<span class="sd">    :kwarg draw:        Set to anything but None or False in order to draw image on-screen instead of saving to file (requires x-windowing)</span>

<span class="sd">    :kwarg nooverwrite: Set to only perform actions if the target output file does not yet exist                    </span>

<span class="sd">    :kwarg var:         variable to plot, e.g. rho, RhoBackstream, beta, Temperature, MA, Mms, va, vms,</span>
<span class="sd">                        E, B, v, V or others. Accepts any variable known by analysator.</span>
<span class="sd">                        Per-population variables are simply given as &quot;proton/rho&quot; etc</span>
<span class="sd">    :kwarg operator:    Operator to apply to variable: None, x, y, or z. Vector variables return either</span>
<span class="sd">                        the queried component, or otherwise the magnitude. </span>
<span class="sd">    :kwarg op:          duplicate of operator</span>

<span class="sd">    :kwarg boxm:        zoom box extents [x0,x1,y0,y1,z0,z1] in metres (default and truncate to: whole simulation box)</span>
<span class="sd">    :kwarg boxre:       zoom box extents [x0,x1,y0,y1,z0,z1] in Earth radii (default and truncate to: whole simulation box)</span>

<span class="sd">    :kwarg colormap:    colour scale for plot, use e.g. hot_desaturated, jet, viridis, plasma, inferno,</span>
<span class="sd">                        magma, parula, nipy_spectral, RdBu, bwr</span>
<span class="sd">    :kwarg vmin,vmax:   min and max values for colour scale and colour bar. If no values are given,</span>
<span class="sd">                        min and max values for whole plot (non-zero rho regions only) are used.</span>
<span class="sd">    :kwarg symmetric:   Set the absolute value of vmin and vmax to the greater of the two</span>
<span class="sd">    :kwarg absolute:    Plot the absolute of the evaluated variable</span>
<span class="sd">    :kwarg lin:         Flag for using linear colour scaling instead of log</span>
<span class="sd">    :kwarg symlog:      Use logarithmic scaling, but linear when abs(value) is below the value given to symlog.</span>
<span class="sd">                        Allows symmetric quasi-logarithmic plots of e.g. transverse field components.</span>
<span class="sd">                        A given of 0 translates to a threshold of max(abs(vmin),abs(vmax)) * 1.e-2, but this can</span>
<span class="sd">                        result in the innermost tick marks overlapping. In this case, using a larger value for </span>
<span class="sd">                        symlog is suggested.</span>
<span class="sd">    :kwarg nocb:        Set to suppress drawing of colourbar</span>
<span class="sd">    :kwarg title:       string to use as plot title instead of time.</span>
<span class="sd">                        Special case: Set to &quot;msec&quot; to plot time with millisecond accuracy or &quot;musec&quot;</span>
<span class="sd">                        for microsecond accuracy. &quot;sec&quot; is integer second accuracy.</span>
<span class="sd">    :kwarg cbtitle:     string to use as colorbar title instead of map name</span>
<span class="sd">    :kwarg halfaxes:    Flag to prevent plotting the hidden half of the axes, otherwise shown as dashed lines</span>
<span class="sd">                        (default: False)</span>
<span class="sd">    :kwarg usesci:      Use scientific notation for colorbar ticks? (default: True)</span>
<span class="sd">    :kwarg axisunit:    Plot axes using 10^{axisunit} m (default: Earth radius R_E)</span>
<span class="sd">    :kwarg axiscolor:   Color for drawing axes (default black)</span>
<span class="sd">    :kwarg shadings:    Dimming values for the surfaces normal to the X, Y, Z directions, respectively,</span>
<span class="sd">                        to better distinguish the slices, e.g. &quot;(0.6,0.8,1.0). Default using the angles between</span>
<span class="sd">                        the surface normal directions and the viewing angle.</span>
<span class="sd">    :kwarg tickinterval:Axis tick interval, expressed in 10^{axisunit} (default: 10 Earth radii)</span>
<span class="sd">    :kwarg fixedticks:  Set ticks at fixed locations instead of relative to the triple cut point (default: False)</span>

<span class="sd">    :kwarg pass_full:   Set to anything but None in order to pass the full arrays instead of a zoomed-in section</span>

<span class="sd">    :kwarg wmark:       If set to non-zero, will plot a Vlasiator watermark in the top left corner. If set to a text</span>
<span class="sd">                        string, tries to use that as the location, e.g. &quot;NW&quot;,&quot;NE&quot;,&quot;SW&quot;,&quot;SW&quot;</span>
<span class="sd">    :kwarg wmarkb:      As for wmark, but uses an all-black Vlasiator logo.</span>
<span class="sd">    :kwarg nomask:      Do not mask plotting based on proton density</span>
<span class="sd">    :kwarg Earth:       Draw Earth at origin (default True)</span>

<span class="sd">    :kwarg scale:       Scale text size (default=1.0)</span>
<span class="sd">    :kwarg thick:       line and axis thickness, default=1.0</span>

<span class="sd">    :kwarg expression:  Optional function which calculates a custom expression to plot. The function</span>
<span class="sd">                        receives the same dictionary of numpy arrays as external, as an argument pass_maps,</span>
<span class="sd">                        the contents of which are maps of variables. Each is either of size [ysize,xsize]</span>
<span class="sd">                        or for multi-dimensional variables (vectors, tensors) it&#39;s [ysize,xsize,dim].</span>
<span class="sd">                        If the function accepts a second variable, if set to true, it is expected to </span>
<span class="sd">                        return a list of required variables for pass_maps.</span>
<span class="sd">                        **Important note:** the dictionaries of arrays passed to `expression` are of shape [ysize,xzize], so</span>
<span class="sd">                        for some analysis transposing them is necessary. For pre-existing functions to use and to base new functions</span>
<span class="sd">                        on, see the plot_helpers.py file.</span>

<span class="sd">    :kwarg vscale:      Scale all values with this before plotting. Useful for going from e.g. m^-3 to cm^-3</span>
<span class="sd">                        or from tesla to nanotesla. Guesses correct units for colourbar for some known</span>
<span class="sd">                        variables. Set to None to search for a default scaling.</span>
<span class="sd">    :kwarg viewangle:   Azimuth and elevation angles giving the point of view on the 3D axes, in degrees.</span>
<span class="sd">                        (default=(-60.,30.); corresponds to dayside, morningside, northern hemisphere)</span>

<span class="sd">    :kwarg cutpointm:    Coordinates of the point through which all three 2D cuts must pass [m]</span>
<span class="sd">    :kwarg cutpointre:  Coordinates of the point through which all three 2D cuts must pass [rE]</span>
<span class="sd">    :kwarg slices:      Normal directions of the slices to plot, default=&#39;xyz&#39;</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># Verify the location of this watermark image</span>
    <span class="n">watermarkimage</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;logo_color.png&#39;</span><span class="p">)</span>
    <span class="n">watermarkimageblack</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;logo_black.png&#39;</span><span class="p">)</span>

    <span class="c1"># Switch None-keywords to empty lists (this way subsequent calls get correct empty default values</span>
    <span class="k">if</span> <span class="n">boxm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">boxm</span><span class="o">=</span><span class="p">[],</span>
    <span class="k">if</span> <span class="n">boxre</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">boxre</span><span class="o">=</span><span class="p">[]</span>
<span class="c1">#    if pass_vars is None:    # Not yet implemented</span>
<span class="c1">#        pass_vars=[]</span>

    <span class="c1"># Change certain falsy values:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">lin</span> <span class="ow">and</span> <span class="n">lin</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">lin</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">symlog</span> <span class="ow">and</span> <span class="n">symlog</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">symlog</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">symlog</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">symlog</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">filedir</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="n">filedir</span> <span class="o">=</span> <span class="s1">&#39;./&#39;</span>

    <span class="c1"># Input file or object</span>
    <span class="k">if</span> <span class="n">filename</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
        <span class="n">f</span><span class="o">=</span><span class="n">pt</span><span class="o">.</span><span class="n">vlsvfile</span><span class="o">.</span><span class="n">VlsvReader</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">((</span><span class="n">filedir</span><span class="o">!=</span><span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">step</span><span class="o">!=</span><span class="kc">None</span><span class="p">)):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">filedir</span><span class="o">+</span><span class="s1">&#39;bulk*&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">step</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="s1">&#39;0&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.vlsv&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">f</span><span class="o">=</span><span class="n">pt</span><span class="o">.</span><span class="n">vlsvfile</span><span class="o">.</span><span class="n">VlsvReader</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">vlsvobj</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
        <span class="n">f</span><span class="o">=</span><span class="n">vlsvobj</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;needs a .vlsv file name, python object, or dictionary and step&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">operator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">op</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">operator</span><span class="o">=</span><span class="n">op</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">colormap</span><span class="p">:</span>
        <span class="c1"># Default values</span>
        <span class="n">colormap</span><span class="o">=</span><span class="s2">&quot;hot_desaturated&quot;</span>
        <span class="k">if</span> <span class="n">operator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">operator</span> <span class="ow">in</span> <span class="s1">&#39;xyz&#39;</span><span class="p">:</span>
            <span class="n">colormap</span><span class="o">=</span><span class="s2">&quot;bwr&quot;</span>

    <span class="n">cmapuse</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">colormap</span><span class="p">)</span>

    <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="o">*</span><span class="n">scale</span> <span class="c1"># Most text</span>
    <span class="n">fontsize2</span><span class="o">=</span><span class="mi">10</span><span class="o">*</span><span class="n">scale</span> <span class="c1"># Time title</span>
    <span class="n">fontsize3</span><span class="o">=</span><span class="mi">8</span><span class="o">*</span><span class="n">scale</span> <span class="c1"># Colour bar ticks and title</span>

    <span class="k">if</span> <span class="n">axiscolor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">axiscolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span>

    <span class="c1"># Plot title with time</span>
    <span class="n">timeval</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">read_parameter</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>

    <span class="c1"># Plot title with time</span>
    <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">title</span><span class="o">==</span><span class="s2">&quot;msec&quot;</span> <span class="ow">or</span> <span class="n">title</span><span class="o">==</span><span class="s2">&quot;musec&quot;</span><span class="p">:</span>        
        <span class="k">if</span> <span class="n">timeval</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>    
            <span class="n">plot_title</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">timeformat</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{:4.1f}</span><span class="s1">&#39;</span>
            <span class="k">if</span> <span class="n">title</span><span class="o">==</span><span class="s2">&quot;sec&quot;</span><span class="p">:</span> <span class="n">timeformat</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{:4.0f}</span><span class="s1">&#39;</span>
            <span class="k">if</span> <span class="n">title</span><span class="o">==</span><span class="s2">&quot;msec&quot;</span><span class="p">:</span> <span class="n">timeformat</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{:4.3f}</span><span class="s1">&#39;</span>
            <span class="k">if</span> <span class="n">title</span><span class="o">==</span><span class="s2">&quot;musec&quot;</span><span class="p">:</span> <span class="n">timeformat</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{:4.6f}</span><span class="s1">&#39;</span>
            <span class="n">plot_title</span> <span class="o">=</span> <span class="s2">&quot;t=&quot;</span><span class="o">+</span><span class="n">timeformat</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">timeval</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; s &#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plot_title</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">+</span><span class="n">title</span>

    <span class="c1"># step, used for file name</span>
    <span class="k">if</span> <span class="n">step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">stepstr</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">step</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">filename</span><span class="p">:</span>
            <span class="n">stepstr</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">filename</span><span class="p">[</span><span class="o">-</span><span class="mi">12</span><span class="p">:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stepstr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="c1"># If run name isn&#39;t given, just put &quot;plot&quot; in the output file name</span>
    <span class="k">if</span> <span class="n">run</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">run</span><span class="o">=</span><span class="s1">&#39;plot&#39;</span>
        <span class="k">if</span> <span class="n">filename</span><span class="p">:</span>
            <span class="c1"># If working within CSC filesystem, make a guess:</span>
            <span class="k">if</span> <span class="n">filename</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">16</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;/proj/vlasov/3D/&quot;</span><span class="p">:</span>
                <span class="n">run</span> <span class="o">=</span> <span class="n">filename</span><span class="p">[</span><span class="mi">16</span><span class="p">:</span><span class="mi">19</span><span class="p">]</span>

    <span class="c1"># Verify validity of operator</span>
    <span class="n">operatorstr</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="n">operatorfilestr</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">operator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># .isdigit checks if the operator is an integer (for taking an element from a vector)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">operator</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
            <span class="n">operator</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">operator</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">operator</span> <span class="ow">in</span> <span class="s1">&#39;xyz&#39;</span> <span class="ow">and</span> <span class="n">operator</span> <span class="o">!=</span> <span class="s1">&#39;magnitude&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">operator</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Unknown operator &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">operator</span><span class="p">))</span>
            <span class="n">operator</span><span class="o">=</span><span class="kc">None</span>
            <span class="n">operatorstr</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">operator</span> <span class="ow">in</span> <span class="s1">&#39;xyz&#39;</span><span class="p">:</span>
            <span class="c1"># For components, always use linear scale, unless symlog is set</span>
            <span class="n">operatorstr</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">operator</span>
            <span class="n">operatorfilestr</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">operator</span>
            <span class="k">if</span> <span class="n">symlog</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">lin</span><span class="o">=</span><span class="kc">True</span>
        <span class="c1"># index a vector</span>
        <span class="k">if</span> <span class="n">operator</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="n">operator</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">operator</span><span class="p">)</span>
            <span class="n">operatorstr</span><span class="o">=</span><span class="s1">&#39;_{&#39;</span><span class="o">+</span><span class="n">operator</span><span class="o">+</span><span class="s1">&#39;}&#39;</span>
            <span class="n">operatorfilestr</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">operator</span>
        <span class="c1"># Note: operator magnitude gets operatorstr=&#39;&#39;</span>

    <span class="c1"># Output file name</span>
    <span class="k">if</span> <span class="n">expression</span><span class="p">:</span>
        <span class="n">varstr</span><span class="o">=</span><span class="n">expression</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">var</span><span class="p">:</span>
            <span class="c1"># If no expression or variable given, defaults to rhom</span>
            <span class="n">var</span><span class="o">=</span><span class="s1">&#39;vg_rhom&#39;</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">check_variable</span><span class="p">(</span><span class="s2">&quot;proton/vg_rho&quot;</span><span class="p">):</span> <span class="c1"># multipop v5</span>
                <span class="n">var</span> <span class="o">=</span> <span class="s1">&#39;proton/vg_rho&#39;</span>
            <span class="k">elif</span> <span class="n">f</span><span class="o">.</span><span class="n">check_variable</span><span class="p">(</span><span class="s2">&quot;moments&quot;</span><span class="p">):</span> <span class="c1"># restart</span>
                <span class="n">var</span> <span class="o">=</span> <span class="s1">&#39;vg_restart_rhom&#39;</span>
        <span class="n">varstr</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>


    <span class="c1"># The plot will be saved in a new figure (&#39;draw&#39; and &#39;axes&#39; keywords not implemented yet)</span>
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">get_backend</span><span class="p">())</span> <span class="o">!=</span> <span class="n">pt</span><span class="o">.</span><span class="n">backend_noninteractive</span><span class="p">:</span> <span class="c1">#&#39;Agg&#39;:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">switch_backend</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">backend_noninteractive</span><span class="p">)</span>

    <span class="c1"># Select plotting back-end based on on-screen plotting or direct to file without requiring x-windowing</span>
    <span class="k">if</span> <span class="n">draw</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">get_backend</span><span class="p">())</span> <span class="o">!=</span> <span class="n">pt</span><span class="o">.</span><span class="n">backend_interactive</span><span class="p">:</span> <span class="c1">#&#39;TkAgg&#39;: </span>
            <span class="n">plt</span><span class="o">.</span><span class="n">switch_backend</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">backend_interactive</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">get_backend</span><span class="p">())</span> <span class="o">!=</span> <span class="n">pt</span><span class="o">.</span><span class="n">backend_noninteractive</span><span class="p">:</span> <span class="c1">#&#39;Agg&#39;:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">switch_backend</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">backend_noninteractive</span><span class="p">)</span>  

    <span class="n">Re</span> <span class="o">=</span> <span class="mf">6.371e+6</span> <span class="c1"># Earth radius in m</span>
    <span class="c1"># read in mesh size and cells in ordinary space</span>
    <span class="p">[</span><span class="n">xsize</span><span class="p">,</span> <span class="n">ysize</span><span class="p">,</span> <span class="n">zsize</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get_spatial_mesh_size</span><span class="p">()</span>
    <span class="n">xsize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">xsize</span><span class="p">)</span>
    <span class="n">ysize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ysize</span><span class="p">)</span>
    <span class="n">zsize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">zsize</span><span class="p">)</span>
    <span class="p">[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">zmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">zmax</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get_spatial_mesh_extent</span><span class="p">()</span>
    <span class="n">cellsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmax</span><span class="o">-</span><span class="n">xmin</span><span class="p">)</span><span class="o">/</span><span class="n">xsize</span>
    <span class="n">cellids</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read_variable</span><span class="p">(</span><span class="s2">&quot;CellID&quot;</span><span class="p">)</span>
    <span class="n">sizes</span> <span class="o">=</span> <span class="p">[</span><span class="n">xsize</span><span class="p">,</span><span class="n">ysize</span><span class="p">,</span><span class="n">zsize</span><span class="p">]</span>

    <span class="c1"># Read the FSgrid mesh</span>
    <span class="p">[</span><span class="n">xsizefg</span><span class="p">,</span> <span class="n">ysizefg</span><span class="p">,</span> <span class="n">zsizefg</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get_fsgrid_mesh_size</span><span class="p">()</span>
    <span class="n">xsizefg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">xsizefg</span><span class="p">)</span>
    <span class="n">ysizefg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ysizefg</span><span class="p">)</span>
    <span class="n">zsizefg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">zsizefg</span><span class="p">)</span>
    <span class="p">[</span><span class="n">xminfg</span><span class="p">,</span> <span class="n">yminfg</span><span class="p">,</span> <span class="n">zminfg</span><span class="p">,</span> <span class="n">xmaxfg</span><span class="p">,</span> <span class="n">ymaxfg</span><span class="p">,</span> <span class="n">zmaxfg</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get_fsgrid_mesh_extent</span><span class="p">()</span>
    <span class="n">cellsizefg</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmaxfg</span><span class="o">-</span><span class="n">xminfg</span><span class="p">)</span><span class="o">/</span><span class="n">xsizefg</span>
    <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">plot_helpers</span><span class="o">.</span><span class="n">CELLSIZE</span> <span class="o">=</span> <span class="n">cellsizefg</span>
    
    <span class="c1"># sort the cellid and the datamap list</span>
    <span class="n">indexids</span> <span class="o">=</span> <span class="n">cellids</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
    <span class="n">cellids</span> <span class="o">=</span> <span class="n">cellids</span><span class="p">[</span><span class="n">indexids</span><span class="p">]</span>

    <span class="c1"># find the highest refiment level</span>
    <span class="n">reflevel</span> <span class="o">=</span> <span class="n">ids3d</span><span class="o">.</span><span class="n">refinement_level</span><span class="p">(</span><span class="n">xsize</span><span class="p">,</span> <span class="n">ysize</span><span class="p">,</span> <span class="n">zsize</span><span class="p">,</span> <span class="n">cellids</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span> <span class="c1"># Check if Vlasov grid doesn&#39;t reach maximum (fsgrid) refinement</span>
        <span class="k">if</span> <span class="n">xsize</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="n">reflevel</span> <span class="o">+</span> <span class="n">i</span><span class="p">))</span> <span class="o">==</span> <span class="n">xsizefg</span><span class="p">:</span>
            <span class="n">reflevel</span> <span class="o">+=</span> <span class="n">i</span>
            <span class="k">break</span>

    <span class="c1"># Verify that FSgrid and spatial grid agree</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">xmin</span><span class="o">!=</span><span class="n">xminfg</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">xmax</span><span class="o">!=</span><span class="n">xmaxfg</span><span class="p">)</span> <span class="ow">or</span>
        <span class="p">(</span><span class="n">ymin</span><span class="o">!=</span><span class="n">yminfg</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">ymax</span><span class="o">!=</span><span class="n">ymaxfg</span><span class="p">)</span> <span class="ow">or</span>
        <span class="p">(</span><span class="n">zmin</span><span class="o">!=</span><span class="n">zminfg</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">zmax</span><span class="o">!=</span><span class="n">zmaxfg</span><span class="p">)</span> <span class="ow">or</span>
        <span class="p">(</span><span class="n">xsize</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">reflevel</span><span class="p">)</span> <span class="o">!=</span><span class="n">xsizefg</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">ysize</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">reflevel</span><span class="p">)</span> <span class="o">!=</span><span class="n">ysizefg</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">zsize</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">reflevel</span><span class="p">)</span> <span class="o">!=</span><span class="n">zsizefg</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;FSgrid and vlasov grid disagreement!&quot;</span><span class="p">)</span>


    <span class="c1"># Simulation domain outer boundaries</span>
    <span class="n">simext</span><span class="o">=</span><span class="p">[</span><span class="n">xmin</span><span class="p">,</span><span class="n">xmax</span><span class="p">,</span><span class="n">ymin</span><span class="p">,</span><span class="n">ymax</span><span class="p">,</span><span class="n">zmin</span><span class="p">,</span><span class="n">zmax</span><span class="p">]</span>

    <span class="c1"># Coordinates of the point through which the three slices pass</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cutpointm</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cutpointre</span><span class="p">:</span>
            <span class="n">cutpoint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">cutpointre</span><span class="p">)</span> <span class="o">*</span> <span class="n">Re</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># default to [0,0,0]</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No cut point coordinates given, defaulting to origin&#39;</span><span class="p">)</span>
            <span class="n">cutpoint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cutpoint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">cutpointm</span><span class="p">)</span>
    <span class="c1"># Slices to be plotted (defined by their normal direction)</span>
    <span class="k">if</span> <span class="n">slices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">slices</span> <span class="o">=</span> <span class="s1">&#39;xyz&#39;</span>

    <span class="c1"># Select window to draw</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">boxm</span><span class="p">)</span><span class="o">==</span><span class="mi">6</span><span class="p">:</span>
        <span class="n">boxcoords</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">boxm</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">boxre</span><span class="p">)</span><span class="o">==</span><span class="mi">6</span><span class="p">:</span>
        <span class="n">boxcoords</span><span class="o">=</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">Re</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">boxre</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">boxcoords</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">simext</span><span class="p">)</span>

    <span class="c1"># Truncate to simulation extents</span>
    <span class="n">boxcoords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">simext</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">boxcoords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">simext</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">boxcoords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">simext</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">boxcoords</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">simext</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">boxcoords</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">simext</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
    <span class="n">boxcoords</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="n">simext</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>

    <span class="c1"># If cutpoint is outside box coordinates, turn off that slice</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cutpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="p">(</span><span class="n">cutpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">slices</span> <span class="o">=</span> <span class="n">slices</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Note: adjusting box extents to include cut point (x)&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cutpoint</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="ow">or</span> <span class="p">(</span><span class="n">cutpoint</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
        <span class="n">slices</span> <span class="o">=</span> <span class="n">slices</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Note: adjusting box extents to include cut point (y)&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cutpoint</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&lt;</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="ow">or</span> <span class="p">(</span><span class="n">cutpoint</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&gt;</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">5</span><span class="p">]):</span>
        <span class="n">slices</span> <span class="o">=</span> <span class="n">slices</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Note: adjusting box extents to include cut point (z)&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">slices</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;no active slices at cutpoint within box domain&quot;</span><span class="p">)</span>

    <span class="c1"># Also, if necessary, adjust box coordinates to extend a bit beyond the cutpoint.</span>
    <span class="c1"># This is preferable to moving the cutpoint, and required by the quadrant-drawing method.</span>
    <span class="n">boxcoords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">cutpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">cellsizefg</span><span class="p">)</span>
    <span class="n">boxcoords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">cutpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">cellsizefg</span><span class="p">)</span>
    <span class="n">boxcoords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">cutpoint</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">cellsizefg</span><span class="p">)</span>
    <span class="n">boxcoords</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">cutpoint</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">cellsizefg</span><span class="p">)</span>
    <span class="n">boxcoords</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">cutpoint</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">cellsizefg</span><span class="p">)</span>
    <span class="n">boxcoords</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="n">cutpoint</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">cellsizefg</span><span class="p">)</span>

    <span class="c1"># Re-truncate to simulation extents</span>
    <span class="n">boxcoords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">simext</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">boxcoords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">simext</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">boxcoords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">simext</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">boxcoords</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">simext</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">boxcoords</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">simext</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
    <span class="n">boxcoords</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="n">simext</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>

    <span class="c1"># Move cutpoint inwards if it too close to simulation outer extent.</span>
    <span class="n">cutpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">cutpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">simext</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">cellsizefg</span><span class="p">)</span>
    <span class="n">cutpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">cutpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">simext</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">cellsizefg</span><span class="p">)</span>
    <span class="n">cutpoint</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">cutpoint</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">simext</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">cellsizefg</span><span class="p">)</span>
    <span class="n">cutpoint</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">cutpoint</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">simext</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">cellsizefg</span><span class="p">)</span>
    <span class="n">cutpoint</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">cutpoint</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">simext</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">cellsizefg</span><span class="p">)</span>
    <span class="n">cutpoint</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">cutpoint</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">simext</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">cellsizefg</span><span class="p">)</span>

    <span class="c1"># Axes and units (default R_E)</span>
    <span class="k">if</span> <span class="n">axisunit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># Use m or km or other</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">axisunit</span><span class="p">,</span><span class="mi">0</span><span class="p">):</span>
            <span class="n">axisunitstr</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">rmstring</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">axisunit</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">axisunitstr</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">rmstring</span><span class="p">(</span><span class="s1">&#39;km&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">axisunitstr</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$10^{&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">axisunit</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;} &#39;</span><span class="o">+</span><span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">rmstring</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">)</span>
        <span class="n">axisunituse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">axisunit</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axisunitstr</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">rmstring</span><span class="p">(</span><span class="s1">&#39;R&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">rmstring</span><span class="p">(</span><span class="s1">&#39;E&#39;</span><span class="p">)</span>
        <span class="n">axisunituse</span> <span class="o">=</span> <span class="n">Re</span>

    <span class="c1"># Scale data extent and plot box</span>
    <span class="n">simext</span><span class="o">=</span><span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="n">axisunituse</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">simext</span><span class="p">]</span>
    <span class="n">boxcoords</span><span class="o">=</span><span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="n">axisunituse</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">boxcoords</span><span class="p">]</span>

    <span class="c1"># Axis tick interval (default 10 R_E)</span>
    <span class="k">if</span> <span class="n">tickinterval</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tickinterval</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">*</span><span class="n">Re</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tickinterval</span> <span class="o">=</span> <span class="n">tickinterval</span> <span class="o">*</span> <span class="n">axisunituse</span>


    <span class="c1">###################################################</span>
    <span class="c1"># Find the cellids corresponding to the 3 slices #</span>
    <span class="c1">###################################################</span>

    <span class="c1"># {X = x0} slice</span>
    <span class="n">sliceoffset</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">xmin</span><span class="p">)</span> <span class="o">+</span> <span class="n">cutpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">fgslice_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sliceoffset</span><span class="o">/</span><span class="n">cellsizefg</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;x&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span> <span class="n">idlist_x</span><span class="p">,</span> <span class="n">indexlist_x</span> <span class="o">=</span> <span class="n">ids3d</span><span class="o">.</span><span class="n">ids3d</span><span class="p">(</span><span class="n">cellids</span><span class="p">,</span> <span class="n">sliceoffset</span><span class="p">,</span> <span class="n">reflevel</span><span class="p">,</span> <span class="n">xsize</span><span class="p">,</span> <span class="n">ysize</span><span class="p">,</span> <span class="n">zsize</span><span class="p">,</span> <span class="n">xmin</span><span class="o">=</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="n">xmax</span><span class="p">)</span>

    <span class="c1"># {Y = y0} slice</span>
    <span class="n">sliceoffset</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ymin</span><span class="p">)</span> <span class="o">+</span> <span class="n">cutpoint</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">fgslice_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sliceoffset</span><span class="o">/</span><span class="n">cellsizefg</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;y&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span> <span class="n">idlist_y</span><span class="p">,</span> <span class="n">indexlist_y</span> <span class="o">=</span> <span class="n">ids3d</span><span class="o">.</span><span class="n">ids3d</span><span class="p">(</span><span class="n">cellids</span><span class="p">,</span> <span class="n">sliceoffset</span><span class="p">,</span> <span class="n">reflevel</span><span class="p">,</span> <span class="n">xsize</span><span class="p">,</span> <span class="n">ysize</span><span class="p">,</span> <span class="n">zsize</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="n">ymax</span><span class="p">)</span>

    <span class="c1"># {Z = z0} slice</span>
    <span class="n">sliceoffset</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">zmin</span><span class="p">)</span> <span class="o">+</span> <span class="n">cutpoint</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">fgslice_z</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sliceoffset</span><span class="o">/</span><span class="n">cellsizefg</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;z&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span> <span class="n">idlist_z</span><span class="p">,</span> <span class="n">indexlist_z</span> <span class="o">=</span> <span class="n">ids3d</span><span class="o">.</span><span class="n">ids3d</span><span class="p">(</span><span class="n">cellids</span><span class="p">,</span> <span class="n">sliceoffset</span><span class="p">,</span> <span class="n">reflevel</span><span class="p">,</span> <span class="n">xsize</span><span class="p">,</span> <span class="n">ysize</span><span class="p">,</span> <span class="n">zsize</span><span class="p">,</span> <span class="n">zmin</span><span class="o">=</span><span class="n">zmin</span><span class="p">,</span> <span class="n">zmax</span><span class="o">=</span><span class="n">zmax</span><span class="p">)</span>

    <span class="c1">#################################################</span>
    <span class="c1"># Find rhom map for use in masking out ionosphere</span>
    <span class="c1">#################################################</span>
    <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">check_variable</span><span class="p">(</span><span class="s2">&quot;moments&quot;</span><span class="p">):</span>
        <span class="n">rhomap</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read_variable</span><span class="p">(</span><span class="s2">&quot;vg_restart_rhom&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">f</span><span class="o">.</span><span class="n">check_variable</span><span class="p">(</span><span class="s2">&quot;proton/vg_rho&quot;</span><span class="p">):</span>
        <span class="n">rhomap</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read_variable</span><span class="p">(</span><span class="s2">&quot;proton/vg_rho&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">f</span><span class="o">.</span><span class="n">check_variable</span><span class="p">(</span><span class="s2">&quot;vg_rhom&quot;</span><span class="p">):</span>
        <span class="n">rhomap</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read_variable</span><span class="p">(</span><span class="s2">&quot;vg_rhom&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># No rhomap found - do not perform any masking.</span>
        <span class="n">nomask</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">nomask</span><span class="p">:</span>
        <span class="n">rhomap</span> <span class="o">=</span> <span class="n">rhomap</span><span class="p">[</span><span class="n">indexids</span><span class="p">]</span>  <span class="c1"># sort</span>
        <span class="k">if</span> <span class="s1">&#39;x&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span>
            <span class="n">rhomap_x</span> <span class="o">=</span> <span class="n">rhomap</span><span class="p">[</span><span class="n">indexlist_x</span><span class="p">]</span> <span class="c1"># find required cells (X cut)</span>
            <span class="n">rhomap_x</span> <span class="o">=</span> <span class="n">ids3d</span><span class="o">.</span><span class="n">idmesh3d</span><span class="p">(</span><span class="n">idlist_x</span><span class="p">,</span> <span class="n">rhomap_x</span><span class="p">,</span> <span class="n">reflevel</span><span class="p">,</span> <span class="n">xsize</span><span class="p">,</span> <span class="n">ysize</span><span class="p">,</span> <span class="n">zsize</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;y&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span>
            <span class="n">rhomap_y</span> <span class="o">=</span> <span class="n">rhomap</span><span class="p">[</span><span class="n">indexlist_y</span><span class="p">]</span> <span class="c1"># find required cells (Y cut)</span>
            <span class="n">rhomap_y</span> <span class="o">=</span> <span class="n">ids3d</span><span class="o">.</span><span class="n">idmesh3d</span><span class="p">(</span><span class="n">idlist_y</span><span class="p">,</span> <span class="n">rhomap_y</span><span class="p">,</span> <span class="n">reflevel</span><span class="p">,</span> <span class="n">xsize</span><span class="p">,</span> <span class="n">ysize</span><span class="p">,</span> <span class="n">zsize</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;z&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span>
            <span class="n">rhomap_z</span> <span class="o">=</span> <span class="n">rhomap</span><span class="p">[</span><span class="n">indexlist_z</span><span class="p">]</span> <span class="c1"># find required cells (Z cut)</span>
            <span class="n">rhomap_z</span> <span class="o">=</span> <span class="n">ids3d</span><span class="o">.</span><span class="n">idmesh3d</span><span class="p">(</span><span class="n">idlist_z</span><span class="p">,</span> <span class="n">rhomap_z</span><span class="p">,</span> <span class="n">reflevel</span><span class="p">,</span> <span class="n">xsize</span><span class="p">,</span> <span class="n">ysize</span><span class="p">,</span> <span class="n">zsize</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1">############################################</span>
    <span class="c1"># Read data and calculate required variables</span>
    <span class="c1">############################################</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">expression</span><span class="p">:</span>
        <span class="c1"># Read data from file</span>
        <span class="k">if</span> <span class="n">operator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">operator</span><span class="o">=</span><span class="s2">&quot;pass&quot;</span>
        <span class="n">datamap_info</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read_variable_info</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">operator</span><span class="o">=</span><span class="n">operator</span><span class="p">)</span>

        <span class="n">cb_title_use</span> <span class="o">=</span> <span class="n">datamap_info</span><span class="o">.</span><span class="n">latex</span>
        <span class="c1"># Check if vscale results in standard unit</span>
        <span class="n">vscale</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">datamap_unit_latex</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">get_scaled_units</span><span class="p">(</span><span class="n">vscale</span><span class="o">=</span><span class="n">vscale</span><span class="p">,</span><span class="n">variable_info</span><span class="o">=</span><span class="n">datamap_info</span><span class="p">)</span>

        <span class="c1"># Add unit to colorbar title</span>
        <span class="k">if</span> <span class="n">datamap_unit_latex</span><span class="p">:</span>
            <span class="n">cb_title_use</span> <span class="o">=</span> <span class="n">cb_title_use</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;\,[&quot;</span><span class="o">+</span><span class="n">datamap_unit_latex</span><span class="o">+</span><span class="s2">&quot;]&quot;</span>

        <span class="n">datamap</span> <span class="o">=</span> <span class="n">datamap_info</span><span class="o">.</span><span class="n">data</span>
        <span class="c1"># Dummy variables</span>
        <span class="n">datamap_x</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">datamap_y</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">datamap_z</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Verify data shape</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">datamap</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="s2">&quot;read only single value from vlsv file! datamap.shape being &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">datamap</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;fg_&#39;</span><span class="p">):</span>
            <span class="c1"># fsgrid reader returns array in correct shape but needs to be sliced and transposed</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">datamap</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span> <span class="c1"># scalar variable</span>
                <span class="n">datamap_x</span> <span class="o">=</span> <span class="n">datamap</span><span class="p">[</span><span class="n">fgslice_x</span><span class="p">,:,:]</span>
                <span class="n">datamap_y</span> <span class="o">=</span> <span class="n">datamap</span><span class="p">[:,</span><span class="n">fgslice_y</span><span class="p">,:]</span>
                <span class="n">datamap_z</span> <span class="o">=</span> <span class="n">datamap</span><span class="p">[:,:,</span><span class="n">fgslice_z</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">datamap</span><span class="p">)</span><span class="o">==</span><span class="mi">4</span><span class="p">:</span> <span class="c1"># vector variable</span>
                <span class="n">datamap_x</span> <span class="o">=</span> <span class="n">datamap</span><span class="p">[</span><span class="n">fgslice_x</span><span class="p">,:,:,:]</span>
                <span class="n">datamap_y</span> <span class="o">=</span> <span class="n">datamap</span><span class="p">[:,</span><span class="n">fgslice_y</span><span class="p">,:,:]</span>
                <span class="n">datamap_z</span> <span class="o">=</span> <span class="n">datamap</span><span class="p">[:,:,</span><span class="n">fgslice_z</span><span class="p">,:]</span>
            <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">datamap</span><span class="p">)</span><span class="o">==</span><span class="mi">5</span><span class="p">:</span>  <span class="c1"># tensor variable</span>
                <span class="n">datamap_x</span> <span class="o">=</span> <span class="n">datamap</span><span class="p">[</span><span class="n">fgslice_x</span><span class="p">,:,:,:,:]</span>
                <span class="n">datamap_y</span> <span class="o">=</span> <span class="n">datamap</span><span class="p">[:,</span><span class="n">fgslice_y</span><span class="p">,:,:,:]</span>
                <span class="n">datamap_z</span> <span class="o">=</span> <span class="n">datamap</span><span class="p">[:,:,</span><span class="n">fgslice_z</span><span class="p">,:,:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;could not reshape fsgrid datamap!&quot;</span><span class="p">)</span>
            <span class="n">datamap_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">datamap_x</span><span class="p">)</span>
            <span class="n">datamap_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">datamap_x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">datamap_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">datamap_y</span><span class="p">)</span>
            <span class="n">datamap_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">datamap_y</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">datamap_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">datamap_z</span><span class="p">)</span>
            <span class="n">datamap_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">datamap_z</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># vlasov grid, AMR</span>
            <span class="n">datamap</span> <span class="o">=</span> <span class="n">datamap</span><span class="p">[</span><span class="n">indexids</span><span class="p">]</span>      <span class="c1"># sort</span>
            <span class="k">if</span> <span class="s1">&#39;x&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span> <span class="n">datamap_x</span> <span class="o">=</span> <span class="n">datamap</span><span class="p">[</span><span class="n">indexlist_x</span><span class="p">]</span> <span class="c1"># find required cells (X cut)</span>
            <span class="k">if</span> <span class="s1">&#39;y&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span> <span class="n">datamap_y</span> <span class="o">=</span> <span class="n">datamap</span><span class="p">[</span><span class="n">indexlist_y</span><span class="p">]</span> <span class="c1"># find required cells (Y cut)</span>
            <span class="k">if</span> <span class="s1">&#39;z&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span> <span class="n">datamap_z</span> <span class="o">=</span> <span class="n">datamap</span><span class="p">[</span><span class="n">indexlist_z</span><span class="p">]</span> <span class="c1"># find required cells (Z cut)</span>
            <span class="c1"># Create the plotting grid</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">datamap</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>   <span class="c1"># scalar variable</span>
                <span class="k">if</span> <span class="s1">&#39;x&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span> <span class="n">datamap_x</span> <span class="o">=</span> <span class="n">ids3d</span><span class="o">.</span><span class="n">idmesh3d</span><span class="p">(</span><span class="n">idlist_x</span><span class="p">,</span> <span class="n">datamap_x</span><span class="p">,</span> <span class="n">reflevel</span><span class="p">,</span> <span class="n">xsize</span><span class="p">,</span> <span class="n">ysize</span><span class="p">,</span> <span class="n">zsize</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;y&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span> <span class="n">datamap_y</span> <span class="o">=</span> <span class="n">ids3d</span><span class="o">.</span><span class="n">idmesh3d</span><span class="p">(</span><span class="n">idlist_y</span><span class="p">,</span> <span class="n">datamap_y</span><span class="p">,</span> <span class="n">reflevel</span><span class="p">,</span> <span class="n">xsize</span><span class="p">,</span> <span class="n">ysize</span><span class="p">,</span> <span class="n">zsize</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;z&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span> <span class="n">datamap_z</span> <span class="o">=</span> <span class="n">ids3d</span><span class="o">.</span><span class="n">idmesh3d</span><span class="p">(</span><span class="n">idlist_z</span><span class="p">,</span> <span class="n">datamap_z</span><span class="p">,</span> <span class="n">reflevel</span><span class="p">,</span> <span class="n">xsize</span><span class="p">,</span> <span class="n">ysize</span><span class="p">,</span> <span class="n">zsize</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">datamap</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span> <span class="c1"># vector variable</span>
                <span class="k">if</span> <span class="s1">&#39;x&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span> <span class="n">datamap_x</span> <span class="o">=</span> <span class="n">ids3d</span><span class="o">.</span><span class="n">idmesh3d</span><span class="p">(</span><span class="n">idlist_x</span><span class="p">,</span> <span class="n">datamap_x</span><span class="p">,</span> <span class="n">reflevel</span><span class="p">,</span> <span class="n">xsize</span><span class="p">,</span> <span class="n">ysize</span><span class="p">,</span> <span class="n">zsize</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">datamap</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="s1">&#39;y&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span> <span class="n">datamap_y</span> <span class="o">=</span> <span class="n">ids3d</span><span class="o">.</span><span class="n">idmesh3d</span><span class="p">(</span><span class="n">idlist_y</span><span class="p">,</span> <span class="n">datamap_y</span><span class="p">,</span> <span class="n">reflevel</span><span class="p">,</span> <span class="n">xsize</span><span class="p">,</span> <span class="n">ysize</span><span class="p">,</span> <span class="n">zsize</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">datamap</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="s1">&#39;z&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span> <span class="n">datamap_z</span> <span class="o">=</span> <span class="n">ids3d</span><span class="o">.</span><span class="n">idmesh3d</span><span class="p">(</span><span class="n">idlist_z</span><span class="p">,</span> <span class="n">datamap_z</span><span class="p">,</span> <span class="n">reflevel</span><span class="p">,</span> <span class="n">xsize</span><span class="p">,</span> <span class="n">ysize</span><span class="p">,</span> <span class="n">zsize</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">datamap</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">datamap</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span> <span class="c1"># tensor variable</span>
                <span class="k">if</span> <span class="s1">&#39;x&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span> <span class="n">datamap_x</span> <span class="o">=</span> <span class="n">ids3d</span><span class="o">.</span><span class="n">idmesh3d</span><span class="p">(</span><span class="n">idlist_x</span><span class="p">,</span> <span class="n">datamap_x</span><span class="p">,</span> <span class="n">reflevel</span><span class="p">,</span> <span class="n">xsize</span><span class="p">,</span> <span class="n">ysize</span><span class="p">,</span> <span class="n">zsize</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">datamap</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">datamap</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                <span class="k">if</span> <span class="s1">&#39;y&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span> <span class="n">datamap_y</span> <span class="o">=</span> <span class="n">ids3d</span><span class="o">.</span><span class="n">idmesh3d</span><span class="p">(</span><span class="n">idlist_y</span><span class="p">,</span> <span class="n">datamap_y</span><span class="p">,</span> <span class="n">reflevel</span><span class="p">,</span> <span class="n">xsize</span><span class="p">,</span> <span class="n">ysize</span><span class="p">,</span> <span class="n">zsize</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">datamap</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">datamap</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                <span class="k">if</span> <span class="s1">&#39;z&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span> <span class="n">datamap_z</span> <span class="o">=</span> <span class="n">ids3d</span><span class="o">.</span><span class="n">idmesh3d</span><span class="p">(</span><span class="n">idlist_z</span><span class="p">,</span> <span class="n">datamap_z</span><span class="p">,</span> <span class="n">reflevel</span><span class="p">,</span> <span class="n">xsize</span><span class="p">,</span> <span class="n">ysize</span><span class="p">,</span> <span class="n">zsize</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">datamap</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">datamap</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Dimension error in constructing 2D AMR slice!&quot;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Expression set, use generated or provided colorbar title</span>
        <span class="n">cb_title_use</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="n">operatorstr</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Expressions have not been implemented yet&#39;</span><span class="p">)</span>

    <span class="c1"># Now, if map is a vector or tensor, reduce it down</span>
    <span class="k">if</span> <span class="s1">&#39;x&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">datamap_x</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span> <span class="c1"># vector</span>
            <span class="k">if</span> <span class="n">datamap_x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">!=</span><span class="mi">3</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot; expected array of 3-element vectors, found array of shape &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">datamap_x</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
            <span class="n">datamap_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">datamap_x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">datamap_x</span><span class="p">)</span><span class="o">==</span><span class="mi">4</span><span class="p">:</span> <span class="c1"># tensor</span>
            <span class="k">if</span> <span class="n">datamap_x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">!=</span><span class="mi">3</span> <span class="ow">or</span> <span class="n">datamap_x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">!=</span><span class="mi">3</span><span class="p">:</span>
                <span class="c1"># This may also catch 3D simulation fsgrid variables</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot; expected array of 3x3 tensors, found array of shape &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">datamap_x</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
            <span class="n">datamap_x</span> <span class="o">=</span> <span class="n">datamap_x</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">datamap_x</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">datamap_x</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">datamap_x</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">5</span><span class="p">:</span> <span class="c1"># Too many dimensions</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot; too many dimensions in datamap, found array of shape &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">datamap_x</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">datamap_x</span><span class="p">)</span><span class="o">!=</span><span class="mi">2</span><span class="p">:</span> <span class="c1"># Too many dimensions</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot; too many dimensions in datamap, found array of shape &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">datamap_x</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>


        <span class="c1"># Scale final generated datamap if requested</span>
        <span class="n">datamap_x</span> <span class="o">=</span> <span class="n">datamap_x</span> <span class="o">*</span> <span class="n">vscale</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">absolute</span><span class="p">):</span>
            <span class="n">datamap_x</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">datamap_x</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;y&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">datamap_y</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span> <span class="c1"># vector</span>
            <span class="k">if</span> <span class="n">datamap_y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">!=</span><span class="mi">3</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;expected array of 3-element vectors, found array of shape &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">datamap_y</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

            <span class="n">datamap_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">datamap_y</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">datamap_y</span><span class="p">)</span><span class="o">==</span><span class="mi">4</span><span class="p">:</span> <span class="c1"># tensor</span>
            <span class="k">if</span> <span class="n">datamap_y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">!=</span><span class="mi">3</span> <span class="ow">or</span> <span class="n">datamap_y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">!=</span><span class="mi">3</span><span class="p">:</span>
                <span class="c1"># This may also catch 3D simulation fsgrid variables</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;expected array of 3x3 tensors, found array of shape &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">datamap_y</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

            <span class="n">datamap_y</span> <span class="o">=</span> <span class="n">datamap_y</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">datamap_y</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">datamap_y</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">datamap_y</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">5</span><span class="p">:</span> <span class="c1"># Too many dimensions</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;too many dimensions in datamap, found array of shape &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">datamap_y</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">datamap_y</span><span class="p">)</span><span class="o">!=</span><span class="mi">2</span><span class="p">:</span> <span class="c1"># Too many dimensions</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;too many dimensions in datamap, found array of shape &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">datamap_y</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>


        <span class="c1"># Scale final generated datamap if requested</span>
        <span class="n">datamap_y</span> <span class="o">=</span> <span class="n">datamap_y</span> <span class="o">*</span> <span class="n">vscale</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">absolute</span><span class="p">):</span>
            <span class="n">datamap_y</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">datamap_y</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;z&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">datamap_z</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span> <span class="c1"># vector</span>
            <span class="k">if</span> <span class="n">datamap_z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">!=</span><span class="mi">3</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot; expected array of 3-element vectors, found array of shape &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">datamap_z</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
            <span class="n">datamap_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">datamap_z</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">datamap_z</span><span class="p">)</span><span class="o">==</span><span class="mi">4</span><span class="p">:</span> <span class="c1"># tensor</span>
            <span class="k">if</span> <span class="n">datamap_z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">!=</span><span class="mi">3</span> <span class="ow">or</span> <span class="n">datamap_z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">!=</span><span class="mi">3</span><span class="p">:</span>
                <span class="c1"># This may also catch 3D simulation fsgrid variables</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;expected array of 3x3 tensors, found array of shape &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">datamap_z</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
            <span class="n">datamap_z</span> <span class="o">=</span> <span class="n">datamap_z</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">datamap_z</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">datamap_z</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">datamap_z</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">5</span><span class="p">:</span> <span class="c1"># Too many dimensions</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot; too many dimensions in datamap, found array of shape &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">datamap_z</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">datamap_z</span><span class="p">)</span><span class="o">!=</span><span class="mi">2</span><span class="p">:</span> <span class="c1"># Too many dimensions</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot; too many dimensions in datamap, found array of shape &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">datamap_z</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>


        <span class="c1"># Scale final generated datamap if requested</span>
        <span class="n">datamap_z</span> <span class="o">=</span> <span class="n">datamap_z</span> <span class="o">*</span> <span class="n">vscale</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">absolute</span><span class="p">):</span>
            <span class="n">datamap_z</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">datamap_z</span><span class="p">)</span>

    <span class="c1"># scale the sizes to the heighest refinement level because</span>
    <span class="c1"># plotting is done at that level</span>
    <span class="n">sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="o">**</span><span class="n">reflevel</span><span class="p">)</span>
    <span class="n">sizes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sizes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="o">**</span><span class="n">reflevel</span><span class="p">)</span>
    <span class="n">sizes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sizes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="o">**</span><span class="n">reflevel</span><span class="p">)</span>
    <span class="n">finecellsize</span> <span class="o">=</span> <span class="n">cellsize</span> <span class="o">/</span> <span class="mi">2</span><span class="o">**</span><span class="n">reflevel</span>

    <span class="c1"># Allow title override</span>
    <span class="k">if</span> <span class="n">cbtitle</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Here allow underscores for manual math mode</span>
        <span class="n">cb_title_use</span> <span class="o">=</span> <span class="n">cbtitle</span>

    <span class="c1"># If automatic range finding is required, find min and max of array</span>
    <span class="c1"># Performs range-finding on a masked array to work even if array contains invalid values</span>
    <span class="k">if</span> <span class="n">vmin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">vminuse</span><span class="o">=</span><span class="n">vmin</span>
    <span class="k">else</span><span class="p">:</span> 
        <span class="n">vminuse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">datamap</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;x&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span> <span class="n">vminuse</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">vminuse</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">datamap_x</span><span class="p">))</span>
        <span class="k">if</span> <span class="s1">&#39;y&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span> <span class="n">vminuse</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">vminuse</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">datamap_y</span><span class="p">))</span>
        <span class="k">if</span> <span class="s1">&#39;z&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span> <span class="n">vminuse</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">vminuse</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">datamap_z</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">vmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">vmaxuse</span><span class="o">=</span><span class="n">vmax</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">vmaxuse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">datamap</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;x&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span> <span class="n">vmaxuse</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">vmaxuse</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">datamap_x</span><span class="p">))</span>
        <span class="k">if</span> <span class="s1">&#39;y&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span> <span class="n">vmaxuse</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">vmaxuse</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">datamap_y</span><span class="p">))</span>
        <span class="k">if</span> <span class="s1">&#39;z&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span> <span class="n">vmaxuse</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">vmaxuse</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">datamap_z</span><span class="p">))</span>

    <span class="c1"># If both values are zero, we have an empty array</span>
    <span class="k">if</span> <span class="n">vmaxuse</span><span class="o">==</span><span class="n">vminuse</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Error, requested array is zero everywhere. Exiting.&quot;</span><span class="p">)</span>

    <span class="c1"># If vminuse and vmaxuse are extracted from data, different signs, and close to each other, adjust to be symmetric</span>
    <span class="c1"># e.g. to plot transverse field components. Always done for symlog.</span>
    <span class="k">if</span> <span class="n">vmin</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">vmax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">symmetric</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">vminuse</span><span class="o">/</span><span class="n">vmaxuse</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span> <span class="ow">or</span> <span class="n">symlog</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">absval</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">vminuse</span><span class="p">),</span><span class="nb">abs</span><span class="p">(</span><span class="n">vmaxuse</span><span class="p">))</span>
            <span class="n">vminuse</span> <span class="o">=</span> <span class="o">-</span><span class="n">absval</span>
            <span class="n">vmaxuse</span> <span class="o">=</span> <span class="n">absval</span>

    <span class="c1"># Ensure that lower bound is valid for logarithmic plots</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">vminuse</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">lin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">symlog</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Drop negative and zero values</span>
        <span class="n">vminuse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">datamap</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;x&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span> <span class="n">vminuse</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">vminuse</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_less_equal</span><span class="p">(</span><span class="n">datamap_x</span><span class="p">,</span><span class="mi">0</span><span class="p">)))</span>
        <span class="k">if</span> <span class="s1">&#39;y&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span> <span class="n">vminuse</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">vminuse</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_less_equal</span><span class="p">(</span><span class="n">datamap_y</span><span class="p">,</span><span class="mi">0</span><span class="p">)))</span>
        <span class="k">if</span> <span class="s1">&#39;z&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span> <span class="n">vminuse</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">vminuse</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_less_equal</span><span class="p">(</span><span class="n">datamap_z</span><span class="p">,</span><span class="mi">0</span><span class="p">)))</span>

    <span class="c1"># Special case of very small vminuse values</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">vmin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">vmax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">vminuse</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">vminuse</span> <span class="o">&lt;</span> <span class="n">vmaxuse</span><span class="o">*</span><span class="mf">1.e-5</span><span class="p">):</span>
        <span class="n">vminuse</span> <span class="o">=</span> <span class="n">vmaxuse</span><span class="o">*</span><span class="mf">1e-5</span>
        <span class="k">if</span> <span class="n">lin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vminuse</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="c1"># If symlog scaling is set:</span>
    <span class="k">if</span> <span class="n">symlog</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">symlog</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">linthresh</span> <span class="o">=</span> <span class="n">symlog</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">linthresh</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">vminuse</span><span class="p">),</span><span class="nb">abs</span><span class="p">(</span><span class="n">vmaxuse</span><span class="p">))</span><span class="o">*</span><span class="mf">1.e-2</span>

    <span class="c1"># Lin or log colour scaling, defaults to log</span>
    <span class="k">if</span> <span class="n">lin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Special SymLogNorm case</span>
        <span class="k">if</span> <span class="n">symlog</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Version</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">Version</span><span class="p">(</span><span class="s2">&quot;3.2.0&quot;</span><span class="p">):</span>
                <span class="n">norm</span> <span class="o">=</span> <span class="n">SymLogNorm</span><span class="p">(</span><span class="n">linthresh</span><span class="o">=</span><span class="n">linthresh</span><span class="p">,</span> <span class="n">linscale</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vminuse</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmaxuse</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;colormap SymLogNorm uses base-e but ticks are calculated with base-10.&quot;</span><span class="p">)</span>
                <span class="c1">#TODO: copy over matplotlib 3.3.0 implementation of SymLogNorm into analysator</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">norm</span> <span class="o">=</span> <span class="n">SymLogNorm</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">linthresh</span><span class="o">=</span><span class="n">linthresh</span><span class="p">,</span> <span class="n">linscale</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vminuse</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmaxuse</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">maxlog</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">vmaxuse</span><span class="p">)))</span>
            <span class="n">minlog</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="o">-</span><span class="n">vminuse</span><span class="p">)))</span>
            <span class="n">logthresh</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">linthresh</span><span class="p">)))</span>
            <span class="n">logstep</span><span class="o">=</span><span class="mi">1</span>
            <span class="n">ticks</span><span class="o">=</span><span class="p">([</span><span class="o">-</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">logthresh</span><span class="p">,</span> <span class="n">minlog</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">logstep</span><span class="p">)][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="o">+</span><span class="p">[</span><span class="mf">0.0</span><span class="p">]</span>
                    <span class="o">+</span><span class="p">[(</span><span class="mi">10</span><span class="o">**</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">logthresh</span><span class="p">,</span> <span class="n">maxlog</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">logstep</span><span class="p">)]</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Logarithmic plot</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">LogNorm</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">vminuse</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="n">vmaxuse</span><span class="p">)</span>
            <span class="n">ticks</span> <span class="o">=</span> <span class="n">LogLocator</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">subs</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span> <span class="c1"># where to show labels</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Linear</span>
        <span class="n">levels</span> <span class="o">=</span> <span class="n">MaxNLocator</span><span class="p">(</span><span class="n">nbins</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">tick_values</span><span class="p">(</span><span class="n">vminuse</span><span class="p">,</span><span class="n">vmaxuse</span><span class="p">)</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">BoundaryNorm</span><span class="p">(</span><span class="n">levels</span><span class="p">,</span> <span class="n">ncolors</span><span class="o">=</span><span class="n">cmapuse</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ticks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">vminuse</span><span class="p">,</span><span class="n">vmaxuse</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>

    <span class="c1"># Create the scalar mappable to define the face colouring of the surface elements</span>
    <span class="n">scamap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="n">colormap</span><span class="p">,</span><span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>


    <span class="c1">###############################################################################</span>
    <span class="c1"># Making the 12 meshes corresponding to the 12 elementary surfaces to plot #</span>
    <span class="c1">###############################################################################</span>
    <span class="n">cutpointaxu</span> <span class="o">=</span> <span class="n">cutpoint</span><span class="o">/</span><span class="n">axisunituse</span>
    <span class="c1"># {X = x0 slice}</span>
    <span class="p">[</span><span class="n">YmeshYmZm</span><span class="p">,</span><span class="n">ZmeshYmZm</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">simext</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">cutpointaxu</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">num</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">cutpoint</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">ymin</span><span class="p">)</span><span class="o">/</span><span class="n">finecellsize</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
                               <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">simext</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">cutpointaxu</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">num</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">cutpoint</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">zmin</span><span class="p">)</span><span class="o">/</span><span class="n">finecellsize</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">XmeshYmZm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">YmeshYmZm</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">cutpointaxu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="p">[</span><span class="n">YmeshYpZm</span><span class="p">,</span><span class="n">ZmeshYpZm</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">cutpointaxu</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">simext</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">num</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">ymax</span><span class="o">-</span><span class="n">cutpoint</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">finecellsize</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
                               <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">simext</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">cutpointaxu</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">num</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">cutpoint</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">zmin</span><span class="p">)</span><span class="o">/</span><span class="n">finecellsize</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">XmeshYpZm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">YmeshYpZm</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">cutpointaxu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="p">[</span><span class="n">YmeshYmZp</span><span class="p">,</span><span class="n">ZmeshYmZp</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">simext</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">cutpointaxu</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">num</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">cutpoint</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">ymin</span><span class="p">)</span><span class="o">/</span><span class="n">finecellsize</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
                               <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">cutpointaxu</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">simext</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="n">num</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">zmax</span><span class="o">-</span><span class="n">cutpoint</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="n">finecellsize</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">XmeshYmZp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">YmeshYmZp</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">cutpointaxu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="p">[</span><span class="n">YmeshYpZp</span><span class="p">,</span><span class="n">ZmeshYpZp</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">cutpointaxu</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">simext</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">num</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">ymax</span><span class="o">-</span><span class="n">cutpoint</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">finecellsize</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
                               <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">cutpointaxu</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">simext</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="n">num</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">zmax</span><span class="o">-</span><span class="n">cutpoint</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="n">finecellsize</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">XmeshYpZp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">YmeshYpZp</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">cutpointaxu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># {Y = y0 slice}</span>
    <span class="p">[</span><span class="n">XmeshXmZm</span><span class="p">,</span><span class="n">ZmeshXmZm</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">simext</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">cutpointaxu</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">num</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">cutpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">xmin</span><span class="p">)</span><span class="o">/</span><span class="n">finecellsize</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
                               <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">simext</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">cutpointaxu</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">num</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">cutpoint</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">zmin</span><span class="p">)</span><span class="o">/</span><span class="n">finecellsize</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">YmeshXmZm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">XmeshXmZm</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">cutpointaxu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="p">[</span><span class="n">XmeshXpZm</span><span class="p">,</span><span class="n">ZmeshXpZm</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">cutpointaxu</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">simext</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">num</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">xmax</span><span class="o">-</span><span class="n">cutpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">finecellsize</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
                               <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">simext</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">cutpointaxu</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">num</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">cutpoint</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">zmin</span><span class="p">)</span><span class="o">/</span><span class="n">finecellsize</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">YmeshXpZm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">XmeshXpZm</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">cutpointaxu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="p">[</span><span class="n">XmeshXmZp</span><span class="p">,</span><span class="n">ZmeshXmZp</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">simext</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">cutpointaxu</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">num</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">cutpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">xmin</span><span class="p">)</span><span class="o">/</span><span class="n">finecellsize</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
                               <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">cutpointaxu</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">simext</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="n">num</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">zmax</span><span class="o">-</span><span class="n">cutpoint</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="n">finecellsize</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">YmeshXmZp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">XmeshXmZp</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">cutpointaxu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="p">[</span><span class="n">XmeshXpZp</span><span class="p">,</span><span class="n">ZmeshXpZp</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">cutpointaxu</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">simext</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">num</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">xmax</span><span class="o">-</span><span class="n">cutpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">finecellsize</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
                               <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">cutpointaxu</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">simext</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="n">num</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">zmax</span><span class="o">-</span><span class="n">cutpoint</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="n">finecellsize</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">YmeshXpZp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">XmeshXpZp</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">cutpointaxu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># {Z = z0 slice}</span>
    <span class="p">[</span><span class="n">XmeshXmYm</span><span class="p">,</span><span class="n">YmeshXmYm</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">simext</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">cutpointaxu</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">num</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">cutpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">xmin</span><span class="p">)</span><span class="o">/</span><span class="n">finecellsize</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
                               <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">simext</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">cutpointaxu</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">num</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">cutpoint</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">ymin</span><span class="p">)</span><span class="o">/</span><span class="n">finecellsize</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">ZmeshXmYm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">XmeshXmYm</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">cutpointaxu</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="p">[</span><span class="n">XmeshXpYm</span><span class="p">,</span><span class="n">YmeshXpYm</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">cutpointaxu</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">simext</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">num</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">xmax</span><span class="o">-</span><span class="n">cutpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">finecellsize</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
                               <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">simext</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">cutpointaxu</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">num</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">cutpoint</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">ymin</span><span class="p">)</span><span class="o">/</span><span class="n">finecellsize</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">ZmeshXpYm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">XmeshXpYm</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">cutpointaxu</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="p">[</span><span class="n">XmeshXmYp</span><span class="p">,</span><span class="n">YmeshXmYp</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">simext</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">cutpointaxu</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">num</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">cutpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">xmin</span><span class="p">)</span><span class="o">/</span><span class="n">finecellsize</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
                               <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">cutpointaxu</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">simext</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">num</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">ymax</span><span class="o">-</span><span class="n">cutpoint</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">finecellsize</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">ZmeshXmYp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">XmeshXmYp</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">cutpointaxu</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="p">[</span><span class="n">XmeshXpYp</span><span class="p">,</span><span class="n">YmeshXpYp</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">cutpointaxu</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">simext</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">num</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">xmax</span><span class="o">-</span><span class="n">cutpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">finecellsize</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
                               <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">cutpointaxu</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">simext</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">num</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">ymax</span><span class="o">-</span><span class="n">cutpoint</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">finecellsize</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">ZmeshXpYp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">XmeshXpYp</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">cutpointaxu</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1"># Creating lists of meshes to be called in a for loop</span>
    <span class="n">Xmesh_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">XmeshYmZm</span><span class="p">,</span><span class="n">XmeshYpZm</span><span class="p">,</span><span class="n">XmeshYmZp</span><span class="p">,</span><span class="n">XmeshYpZp</span><span class="p">,</span> <span class="n">XmeshXmZm</span><span class="p">,</span><span class="n">XmeshXpZm</span><span class="p">,</span><span class="n">XmeshXmZp</span><span class="p">,</span><span class="n">XmeshXpZp</span><span class="p">,</span> <span class="n">XmeshXmYm</span><span class="p">,</span><span class="n">XmeshXpYm</span><span class="p">,</span><span class="n">XmeshXmYp</span><span class="p">,</span><span class="n">XmeshXpYp</span><span class="p">]</span>
    <span class="n">Ymesh_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">YmeshYmZm</span><span class="p">,</span><span class="n">YmeshYpZm</span><span class="p">,</span><span class="n">YmeshYmZp</span><span class="p">,</span><span class="n">YmeshYpZp</span><span class="p">,</span> <span class="n">YmeshXmZm</span><span class="p">,</span><span class="n">YmeshXpZm</span><span class="p">,</span><span class="n">YmeshXmZp</span><span class="p">,</span><span class="n">YmeshXpZp</span><span class="p">,</span> <span class="n">YmeshXmYm</span><span class="p">,</span><span class="n">YmeshXpYm</span><span class="p">,</span><span class="n">YmeshXmYp</span><span class="p">,</span><span class="n">YmeshXpYp</span><span class="p">]</span>
    <span class="n">Zmesh_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ZmeshYmZm</span><span class="p">,</span><span class="n">ZmeshYpZm</span><span class="p">,</span><span class="n">ZmeshYmZp</span><span class="p">,</span><span class="n">ZmeshYpZp</span><span class="p">,</span> <span class="n">ZmeshXmZm</span><span class="p">,</span><span class="n">ZmeshXpZm</span><span class="p">,</span><span class="n">ZmeshXmZp</span><span class="p">,</span><span class="n">ZmeshXpZp</span><span class="p">,</span> <span class="n">ZmeshXmYm</span><span class="p">,</span><span class="n">ZmeshXpYm</span><span class="p">,</span><span class="n">ZmeshXmYp</span><span class="p">,</span><span class="n">ZmeshXpYp</span><span class="p">]</span>

    <span class="c1"># coordinates of the point where the all three 2d cut throughs cuts</span>
    <span class="n">xr_coord</span> <span class="o">=</span> <span class="o">-</span><span class="n">xmin</span> <span class="o">+</span> <span class="n">cutpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">yr_coord</span> <span class="o">=</span> <span class="o">-</span><span class="n">ymin</span> <span class="o">+</span> <span class="n">cutpoint</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">zr_coord</span> <span class="o">=</span> <span class="o">-</span><span class="n">zmin</span> <span class="o">+</span> <span class="n">cutpoint</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1"># coordinates of the point where the all three 2d cut throughs cut in terms of cells</span>
    <span class="n">xr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">xr_coord</span><span class="o">/</span><span class="p">(</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">))</span><span class="o">*</span><span class="n">xsize</span><span class="o">*</span><span class="mi">2</span><span class="o">**</span><span class="n">reflevel</span><span class="p">))</span>
    <span class="n">yr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">yr_coord</span><span class="o">/</span><span class="p">(</span><span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">))</span><span class="o">*</span><span class="n">ysize</span><span class="o">*</span><span class="mi">2</span><span class="o">**</span><span class="n">reflevel</span><span class="p">))</span>
    <span class="n">zr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">zr_coord</span><span class="o">/</span><span class="p">(</span><span class="n">zmax</span> <span class="o">-</span> <span class="n">zmin</span><span class="p">))</span><span class="o">*</span><span class="n">zsize</span><span class="o">*</span><span class="mi">2</span><span class="o">**</span><span class="n">reflevel</span><span class="p">))</span>

    <span class="c1"># Creating lists of datamap_i to be called in that same for loop</span>
    <span class="k">if</span> <span class="s1">&#39;x&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span> <span class="n">datamap_x_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">datamap_x</span><span class="p">[:</span><span class="n">zr</span><span class="p">,:</span><span class="n">yr</span><span class="p">],</span><span class="n">datamap_x</span><span class="p">[:</span><span class="n">zr</span><span class="p">,</span><span class="n">yr</span><span class="p">:],</span><span class="n">datamap_x</span><span class="p">[</span><span class="n">zr</span><span class="p">:,:</span><span class="n">yr</span><span class="p">],</span><span class="n">datamap_x</span><span class="p">[</span><span class="n">zr</span><span class="p">:,</span><span class="n">yr</span><span class="p">:]]</span>
    <span class="k">if</span> <span class="s1">&#39;y&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span> <span class="n">datamap_y_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">datamap_y</span><span class="p">[:</span><span class="n">zr</span><span class="p">,:</span><span class="n">xr</span><span class="p">],</span><span class="n">datamap_y</span><span class="p">[:</span><span class="n">zr</span><span class="p">,</span><span class="n">xr</span><span class="p">:],</span><span class="n">datamap_y</span><span class="p">[</span><span class="n">zr</span><span class="p">:,:</span><span class="n">xr</span><span class="p">],</span><span class="n">datamap_y</span><span class="p">[</span><span class="n">zr</span><span class="p">:,</span><span class="n">xr</span><span class="p">:]]</span>
    <span class="k">if</span> <span class="s1">&#39;z&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span> <span class="n">datamap_z_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">datamap_z</span><span class="p">[:</span><span class="n">yr</span><span class="p">,:</span><span class="n">xr</span><span class="p">],</span><span class="n">datamap_z</span><span class="p">[:</span><span class="n">yr</span><span class="p">,</span><span class="n">xr</span><span class="p">:],</span><span class="n">datamap_z</span><span class="p">[</span><span class="n">yr</span><span class="p">:,:</span><span class="n">xr</span><span class="p">],</span><span class="n">datamap_z</span><span class="p">[</span><span class="n">yr</span><span class="p">:,</span><span class="n">xr</span><span class="p">:]]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">nomask</span><span class="p">:</span>
        <span class="c1"># Creating lists of rhomap_i for the same purpose (especially in case the box does not extend to the full domain)</span>
        <span class="k">if</span> <span class="s1">&#39;x&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span> <span class="n">rhomap_x_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">rhomap_x</span><span class="p">[:</span><span class="n">zr</span><span class="p">,:</span><span class="n">yr</span><span class="p">],</span><span class="n">rhomap_x</span><span class="p">[:</span><span class="n">zr</span><span class="p">,</span><span class="n">yr</span><span class="p">:],</span><span class="n">rhomap_x</span><span class="p">[</span><span class="n">zr</span><span class="p">:,:</span><span class="n">yr</span><span class="p">],</span><span class="n">rhomap_x</span><span class="p">[</span><span class="n">zr</span><span class="p">:,</span><span class="n">yr</span><span class="p">:]]</span>
        <span class="k">if</span> <span class="s1">&#39;y&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span> <span class="n">rhomap_y_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">rhomap_y</span><span class="p">[:</span><span class="n">zr</span><span class="p">,:</span><span class="n">xr</span><span class="p">],</span><span class="n">rhomap_y</span><span class="p">[:</span><span class="n">zr</span><span class="p">,</span><span class="n">xr</span><span class="p">:],</span><span class="n">rhomap_y</span><span class="p">[</span><span class="n">zr</span><span class="p">:,:</span><span class="n">xr</span><span class="p">],</span><span class="n">rhomap_y</span><span class="p">[</span><span class="n">zr</span><span class="p">:,</span><span class="n">xr</span><span class="p">:]]</span>
        <span class="k">if</span> <span class="s1">&#39;z&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span> <span class="n">rhomap_z_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">rhomap_z</span><span class="p">[:</span><span class="n">yr</span><span class="p">,:</span><span class="n">xr</span><span class="p">],</span><span class="n">rhomap_z</span><span class="p">[:</span><span class="n">yr</span><span class="p">,</span><span class="n">xr</span><span class="p">:],</span><span class="n">rhomap_z</span><span class="p">[</span><span class="n">yr</span><span class="p">:,:</span><span class="n">xr</span><span class="p">],</span><span class="n">rhomap_z</span><span class="p">[</span><span class="n">yr</span><span class="p">:,</span><span class="n">xr</span><span class="p">:]]</span>

    <span class="c1"># Creating a new figure and a 3d axes with a custom 3d coordinate axes </span>
    <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nocb</span><span class="p">:</span>
        <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
    <span class="n">ax1</span> <span class="o">=</span> <span class="n">axes3d</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">reflevel</span><span class="p">,</span> <span class="n">cutpoint</span><span class="p">,</span> <span class="n">boxcoords</span><span class="p">,</span> <span class="n">axisunit</span><span class="p">,</span> <span class="n">axisunituse</span><span class="p">,</span> <span class="n">tickinterval</span><span class="p">,</span> <span class="n">fixedticks</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span>
                 <span class="n">thick</span><span class="p">,</span> <span class="n">axiscolor</span><span class="p">,</span> <span class="n">viewangle</span><span class="p">,</span> <span class="n">halfaxes</span><span class="p">,</span> <span class="n">slices</span><span class="p">,</span> <span class="n">Earth</span><span class="p">)</span>

    <span class="c1"># Masking and plotting the elementary surfaces one by one (actually three by three)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">XmeshYZ</span> <span class="o">=</span> <span class="n">Xmesh_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">YmeshYZ</span> <span class="o">=</span> <span class="n">Ymesh_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">ZmeshYZ</span> <span class="o">=</span> <span class="n">Zmesh_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="n">XmeshXZ</span> <span class="o">=</span> <span class="n">Xmesh_list</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">YmeshXZ</span> <span class="o">=</span> <span class="n">Ymesh_list</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">ZmeshXZ</span> <span class="o">=</span> <span class="n">Zmesh_list</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span>

        <span class="n">XmeshXY</span> <span class="o">=</span> <span class="n">Xmesh_list</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">8</span><span class="p">]</span>
        <span class="n">YmeshXY</span> <span class="o">=</span> <span class="n">Ymesh_list</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">8</span><span class="p">]</span>
        <span class="n">ZmeshXY</span> <span class="o">=</span> <span class="n">Zmesh_list</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">8</span><span class="p">]</span>

        <span class="k">if</span> <span class="s1">&#39;x&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span> <span class="n">datamap_x_i</span> <span class="o">=</span> <span class="n">datamap_x_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;y&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span> <span class="n">datamap_y_i</span> <span class="o">=</span> <span class="n">datamap_y_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;z&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span> <span class="n">datamap_z_i</span> <span class="o">=</span> <span class="n">datamap_z_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">nomask</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;x&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span> <span class="n">rhomap_x_i</span> <span class="o">=</span> <span class="n">rhomap_x_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;y&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span> <span class="n">rhomap_y_i</span> <span class="o">=</span> <span class="n">rhomap_y_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;z&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span> <span class="n">rhomap_z_i</span> <span class="o">=</span> <span class="n">rhomap_z_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># The grid generated by meshgrid has all four corners for each cell.</span>
        <span class="c1"># We mask using only the centre values.</span>
        <span class="c1"># Calculate offsets for cell-centre coordinates</span>
        <span class="n">XmeshXYCentres</span> <span class="o">=</span> <span class="n">XmeshXY</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">finecellsize</span><span class="o">/</span><span class="n">axisunituse</span>
        <span class="n">YmeshXYCentres</span> <span class="o">=</span> <span class="n">YmeshXY</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">finecellsize</span><span class="o">/</span><span class="n">axisunituse</span>

        <span class="n">XmeshXZCentres</span> <span class="o">=</span> <span class="n">XmeshXZ</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">finecellsize</span><span class="o">/</span><span class="n">axisunituse</span>
        <span class="n">ZmeshXZCentres</span> <span class="o">=</span> <span class="n">ZmeshXZ</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">finecellsize</span><span class="o">/</span><span class="n">axisunituse</span>

        <span class="n">YmeshYZCentres</span> <span class="o">=</span> <span class="n">YmeshYZ</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">finecellsize</span><span class="o">/</span><span class="n">axisunituse</span>
        <span class="n">ZmeshYZCentres</span> <span class="o">=</span> <span class="n">ZmeshYZ</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">finecellsize</span><span class="o">/</span><span class="n">axisunituse</span>

        <span class="n">maskgrid_XY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">XmeshXYCentres</span><span class="p">)</span>
        <span class="n">maskgrid_XZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">XmeshXZCentres</span><span class="p">)</span>
        <span class="n">maskgrid_YZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">YmeshYZCentres</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pass_full</span><span class="p">:</span>
            <span class="c1"># If zoomed-in using a defined box, and not specifically asking to pass all values:</span>
            <span class="c1"># Generate mask for only visible section (with small buffer for e.g. gradient calculations)</span>
            <span class="n">maskboundarybuffer</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">finecellsize</span><span class="o">/</span><span class="n">axisunituse</span>

            <span class="n">maskgrid_XY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">XmeshXYCentres</span><span class="o">&lt;</span><span class="p">(</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">maskboundarybuffer</span><span class="p">),</span> <span class="n">maskgrid_XY</span><span class="p">)</span>
            <span class="n">maskgrid_XY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">XmeshXYCentres</span><span class="o">&gt;</span><span class="p">(</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">maskboundarybuffer</span><span class="p">),</span> <span class="n">maskgrid_XY</span><span class="p">)</span>
            <span class="n">maskgrid_XY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">YmeshXYCentres</span><span class="o">&lt;</span><span class="p">(</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">maskboundarybuffer</span><span class="p">),</span> <span class="n">maskgrid_XY</span><span class="p">)</span>
            <span class="n">maskgrid_XY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">YmeshXYCentres</span><span class="o">&gt;</span><span class="p">(</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">maskboundarybuffer</span><span class="p">),</span> <span class="n">maskgrid_XY</span><span class="p">)</span>

            <span class="n">maskgrid_XZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">XmeshXZCentres</span><span class="o">&lt;</span><span class="p">(</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">maskboundarybuffer</span><span class="p">),</span> <span class="n">maskgrid_XZ</span><span class="p">)</span>
            <span class="n">maskgrid_XZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">XmeshXZCentres</span><span class="o">&gt;</span><span class="p">(</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">maskboundarybuffer</span><span class="p">),</span> <span class="n">maskgrid_XZ</span><span class="p">)</span>
            <span class="n">maskgrid_XZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">ZmeshXZCentres</span><span class="o">&lt;</span><span class="p">(</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">-</span><span class="n">maskboundarybuffer</span><span class="p">),</span> <span class="n">maskgrid_XZ</span><span class="p">)</span>
            <span class="n">maskgrid_XZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">ZmeshXZCentres</span><span class="o">&gt;</span><span class="p">(</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">+</span><span class="n">maskboundarybuffer</span><span class="p">),</span> <span class="n">maskgrid_XZ</span><span class="p">)</span>

            <span class="n">maskgrid_YZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">YmeshYZCentres</span><span class="o">&lt;</span><span class="p">(</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">maskboundarybuffer</span><span class="p">),</span> <span class="n">maskgrid_YZ</span><span class="p">)</span>
            <span class="n">maskgrid_YZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">YmeshYZCentres</span><span class="o">&gt;</span><span class="p">(</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">maskboundarybuffer</span><span class="p">),</span> <span class="n">maskgrid_YZ</span><span class="p">)</span>
            <span class="n">maskgrid_YZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">ZmeshYZCentres</span><span class="o">&lt;</span><span class="p">(</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">-</span><span class="n">maskboundarybuffer</span><span class="p">),</span> <span class="n">maskgrid_YZ</span><span class="p">)</span>
            <span class="n">maskgrid_YZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">ZmeshYZCentres</span><span class="o">&gt;</span><span class="p">(</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">+</span><span class="n">maskboundarybuffer</span><span class="p">),</span> <span class="n">maskgrid_YZ</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">is_masked</span><span class="p">(</span><span class="n">maskgrid_XY</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;z&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">maskgrid_XY</span><span class="o">.</span><span class="n">mask</span><span class="p">):</span>
            <span class="c1"># Save lists for masking</span>
            <span class="n">MaskXY_X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">maskgrid_XY</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># [0] takes the first element of a tuple</span>
            <span class="n">MaskXY_Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">maskgrid_XY</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">XmeshXYPass</span> <span class="o">=</span> <span class="n">XmeshXY</span><span class="p">[</span><span class="n">MaskXY_X</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">MaskXY_X</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">,:]</span>
            <span class="n">XmeshXYPass</span> <span class="o">=</span> <span class="n">XmeshXYPass</span><span class="p">[:,</span><span class="n">MaskXY_Y</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">MaskXY_Y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">YmeshXYPass</span> <span class="o">=</span> <span class="n">YmeshXY</span><span class="p">[</span><span class="n">MaskXY_X</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">MaskXY_X</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">,:]</span>
            <span class="n">YmeshXYPass</span> <span class="o">=</span> <span class="n">YmeshXYPass</span><span class="p">[:,</span><span class="n">MaskXY_Y</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">MaskXY_Y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">ZmeshXYPass</span> <span class="o">=</span> <span class="n">ZmeshXY</span><span class="p">[</span><span class="n">MaskXY_X</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">MaskXY_X</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">,:]</span>
            <span class="n">ZmeshXYPass</span> <span class="o">=</span> <span class="n">ZmeshXYPass</span><span class="p">[:,</span><span class="n">MaskXY_Y</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">MaskXY_Y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">XmeshXYPass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">XmeshXY</span><span class="p">)</span>
            <span class="n">YmeshXYPass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">YmeshXY</span><span class="p">)</span>
            <span class="n">ZmeshXYPass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ZmeshXY</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">is_masked</span><span class="p">(</span><span class="n">maskgrid_XZ</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;y&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">maskgrid_XZ</span><span class="o">.</span><span class="n">mask</span><span class="p">):</span>
            <span class="c1"># Save lists for masking</span>
            <span class="n">MaskXZ_X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">maskgrid_XZ</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># [0] takes the first element of a tuple</span>
            <span class="n">MaskXZ_Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">maskgrid_XZ</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">XmeshXZPass</span> <span class="o">=</span> <span class="n">XmeshXZ</span><span class="p">[</span><span class="n">MaskXZ_X</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">MaskXZ_X</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">,:]</span>
            <span class="n">XmeshXZPass</span> <span class="o">=</span> <span class="n">XmeshXZPass</span><span class="p">[:,</span><span class="n">MaskXZ_Z</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">MaskXZ_Z</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">YmeshXZPass</span> <span class="o">=</span> <span class="n">YmeshXZ</span><span class="p">[</span><span class="n">MaskXZ_X</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">MaskXZ_X</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">,:]</span>
            <span class="n">YmeshXZPass</span> <span class="o">=</span> <span class="n">YmeshXZPass</span><span class="p">[:,</span><span class="n">MaskXZ_Z</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">MaskXZ_Z</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">ZmeshXZPass</span> <span class="o">=</span> <span class="n">ZmeshXZ</span><span class="p">[</span><span class="n">MaskXZ_X</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">MaskXZ_X</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">,:]</span>
            <span class="n">ZmeshXZPass</span> <span class="o">=</span> <span class="n">ZmeshXZPass</span><span class="p">[:,</span><span class="n">MaskXZ_Z</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">MaskXZ_Z</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">XmeshXZPass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">XmeshXZ</span><span class="p">)</span>
            <span class="n">YmeshXZPass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">YmeshXZ</span><span class="p">)</span>
            <span class="n">ZmeshXZPass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ZmeshXZ</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">is_masked</span><span class="p">(</span><span class="n">maskgrid_YZ</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;x&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">maskgrid_YZ</span><span class="o">.</span><span class="n">mask</span><span class="p">):</span>
            <span class="c1"># Save lists for masking</span>
            <span class="n">MaskYZ_Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">maskgrid_YZ</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># [0] takes the first element of a tuple</span>
            <span class="n">MaskYZ_Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">maskgrid_YZ</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">XmeshYZPass</span> <span class="o">=</span> <span class="n">XmeshYZ</span><span class="p">[</span><span class="n">MaskYZ_Y</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">MaskYZ_Y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">,:]</span>
            <span class="n">XmeshYZPass</span> <span class="o">=</span> <span class="n">XmeshYZPass</span><span class="p">[:,</span><span class="n">MaskYZ_Z</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">MaskYZ_Z</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">YmeshYZPass</span> <span class="o">=</span> <span class="n">YmeshYZ</span><span class="p">[</span><span class="n">MaskYZ_Y</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">MaskYZ_Y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">,:]</span>
            <span class="n">YmeshYZPass</span> <span class="o">=</span> <span class="n">YmeshYZPass</span><span class="p">[:,</span><span class="n">MaskYZ_Z</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">MaskYZ_Z</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">ZmeshYZPass</span> <span class="o">=</span> <span class="n">ZmeshYZ</span><span class="p">[</span><span class="n">MaskYZ_Y</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">MaskYZ_Y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">,:]</span>
            <span class="n">ZmeshYZPass</span> <span class="o">=</span> <span class="n">ZmeshYZPass</span><span class="p">[:,</span><span class="n">MaskYZ_Z</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">MaskYZ_Z</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">XmeshYZPass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">XmeshYZ</span><span class="p">)</span>
            <span class="n">YmeshYZPass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">YmeshYZ</span><span class="p">)</span>
            <span class="n">ZmeshYZPass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ZmeshYZ</span><span class="p">)</span>

        <span class="c1"># Crop both rhomap and datamap to view region</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">is_masked</span><span class="p">(</span><span class="n">maskgrid_XY</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;z&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">maskgrid_XY</span><span class="o">.</span><span class="n">mask</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">nomask</span><span class="p">:</span>
                <span class="c1"># Strip away columns and rows which are outside the plot region</span>
                <span class="n">rhomap_z_i</span> <span class="o">=</span> <span class="n">rhomap_z_i</span><span class="p">[</span><span class="n">MaskXY_X</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">MaskXY_X</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,:]</span>
                <span class="n">rhomap_z_i</span> <span class="o">=</span> <span class="n">rhomap_z_i</span><span class="p">[:,</span><span class="n">MaskXY_Y</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">MaskXY_Y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># Also for the datamap, unless it was already provided by an expression</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">expression</span><span class="p">:</span>
                <span class="n">datamap_z_i</span> <span class="o">=</span> <span class="n">datamap_z_i</span><span class="p">[</span><span class="n">MaskXY_X</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">MaskXY_X</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,:]</span>
                <span class="n">datamap_z_i</span> <span class="o">=</span> <span class="n">datamap_z_i</span><span class="p">[:,</span><span class="n">MaskXY_Y</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">MaskXY_Y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">is_masked</span><span class="p">(</span><span class="n">maskgrid_XZ</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;y&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">maskgrid_XZ</span><span class="o">.</span><span class="n">mask</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">nomask</span><span class="p">:</span>
                <span class="c1"># Strip away columns and rows which are outside the plot region</span>
                <span class="n">rhomap_y_i</span> <span class="o">=</span> <span class="n">rhomap_y_i</span><span class="p">[</span><span class="n">MaskXZ_X</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">MaskXZ_X</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,:]</span>
                <span class="n">rhomap_y_i</span> <span class="o">=</span> <span class="n">rhomap_y_i</span><span class="p">[:,</span><span class="n">MaskXZ_Z</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">MaskXZ_Z</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># Also for the datamap, unless it was already provided by an expression</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">expression</span><span class="p">:</span>
                <span class="n">datamap_y_i</span> <span class="o">=</span> <span class="n">datamap_y_i</span><span class="p">[</span><span class="n">MaskXZ_X</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">MaskXZ_X</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,:]</span>
                <span class="n">datamap_y_i</span> <span class="o">=</span> <span class="n">datamap_y_i</span><span class="p">[:,</span><span class="n">MaskXZ_Z</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">MaskXZ_Z</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">is_masked</span><span class="p">(</span><span class="n">maskgrid_YZ</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;x&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">maskgrid_YZ</span><span class="o">.</span><span class="n">mask</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">nomask</span><span class="p">:</span>
                <span class="c1"># Strip away columns and rows which are outside the plot region</span>
                <span class="n">rhomap_x_i</span> <span class="o">=</span> <span class="n">rhomap_x_i</span><span class="p">[</span><span class="n">MaskYZ_Y</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">MaskYZ_Y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,:]</span>
                <span class="n">rhomap_x_i</span> <span class="o">=</span> <span class="n">rhomap_x_i</span><span class="p">[:,</span><span class="n">MaskYZ_Z</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">MaskYZ_Z</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># Also for the datamap, unless it was already provided by an expression</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">expression</span><span class="p">:</span>
                <span class="n">datamap_x_i</span> <span class="o">=</span> <span class="n">datamap_x_i</span><span class="p">[</span><span class="n">MaskYZ_Y</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">MaskYZ_Y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,:]</span>
                <span class="n">datamap_x_i</span> <span class="o">=</span> <span class="n">datamap_x_i</span><span class="p">[:,</span><span class="n">MaskYZ_Z</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">MaskYZ_Z</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Mask region outside ionosphere. Note that for some boundary layer cells, </span>
        <span class="c1"># a density is calculated, but e.g. pressure is not, and these cells aren&#39;t</span>
        <span class="c1"># excluded by this method. Also mask away regions where datamap is invalid</span>
        <span class="k">if</span> <span class="s1">&#39;z&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">nomask</span><span class="p">:</span>
                <span class="n">rhomap_z_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_less_equal</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_invalid</span><span class="p">(</span><span class="n">rhomap_z_i</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">rhomap_z_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">datamap_z_i</span><span class="p">),</span> <span class="n">rhomap_z_i</span><span class="p">)</span>
                <span class="n">XYmask_z</span> <span class="o">=</span> <span class="n">rhomap_z_i</span><span class="o">.</span><span class="n">mask</span>
                <span class="k">if</span> <span class="n">XYmask_z</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">XYmask_z</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                        <span class="c1"># if everything was masked in rhomap, allow plotting</span>
                        <span class="n">XYmask_z</span><span class="p">[:,:]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Mask datamap</span>
                        <span class="n">datamap_z_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">datamap_z_i</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">XYmask_z</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># no masking</span>
                <span class="n">XYmask_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">datamap_z_i</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                        
            <span class="c1"># Building the face colour maps for plot_surface()</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">isMaskedArray</span><span class="p">(</span><span class="n">datamap_z_i</span><span class="p">):</span>
                <span class="n">fcolor_z_i</span> <span class="o">=</span> <span class="n">scamap</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">datamap_z_i</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="n">fcolor_z_i</span><span class="p">[</span><span class="n">XYmask_z</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fcolor_z_i</span> <span class="o">=</span> <span class="n">scamap</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">datamap_z_i</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;y&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">nomask</span><span class="p">:</span>
                <span class="n">rhomap_y_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_less_equal</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_invalid</span><span class="p">(</span><span class="n">rhomap_y_i</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">rhomap_y_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">datamap_y_i</span><span class="p">),</span> <span class="n">rhomap_y_i</span><span class="p">)</span>
                <span class="n">XZmask_y</span> <span class="o">=</span> <span class="n">rhomap_y_i</span><span class="o">.</span><span class="n">mask</span>
                <span class="k">if</span> <span class="n">XZmask_y</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">XZmask_y</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                        <span class="c1"># if everything was masked in rhomap, allow plotting</span>
                        <span class="n">XZmask_y</span><span class="p">[:,:]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Mask datamap</span>
                        <span class="n">datamap_y_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">datamap_y_i</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">XZmask_y</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># no masking</span>
                <span class="n">XZmask_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">datamap_y_i</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>                        
            <span class="c1"># Building the face colour maps for plot_surface()</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">isMaskedArray</span><span class="p">(</span><span class="n">datamap_y_i</span><span class="p">):</span>
                <span class="n">fcolor_y_i</span> <span class="o">=</span> <span class="n">scamap</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">datamap_y_i</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="n">fcolor_y_i</span><span class="p">[</span><span class="n">XZmask_y</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fcolor_y_i</span> <span class="o">=</span> <span class="n">scamap</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">datamap_y_i</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;x&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">nomask</span><span class="p">:</span>
                <span class="n">rhomap_x_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_less_equal</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_invalid</span><span class="p">(</span><span class="n">rhomap_x_i</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">rhomap_x_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">datamap_x_i</span><span class="p">),</span> <span class="n">rhomap_x_i</span><span class="p">)</span>
                <span class="n">YZmask_x</span> <span class="o">=</span> <span class="n">rhomap_x_i</span><span class="o">.</span><span class="n">mask</span>
                <span class="k">if</span> <span class="n">YZmask_x</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">YZmask_x</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                        <span class="c1"># if everything was masked in rhomap, allow plotting</span>
                        <span class="n">YZmask_x</span><span class="p">[:,:]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Mask datamap</span>
                        <span class="n">datamap_x_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">datamap_x_i</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">YZmask_x</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># no masking</span>
                <span class="n">YZmask_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">datamap_x_i</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

            <span class="c1"># Building the face colour maps for plot_surface()</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">isMaskedArray</span><span class="p">(</span><span class="n">datamap_x_i</span><span class="p">):</span>
                <span class="n">fcolor_x_i</span> <span class="o">=</span> <span class="n">scamap</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">datamap_x_i</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="n">fcolor_x_i</span><span class="p">[</span><span class="n">YZmask_x</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fcolor_x_i</span> <span class="o">=</span> <span class="n">scamap</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">datamap_x_i</span><span class="p">)</span>

        <span class="c1"># Introducing a slight shading to better distiguish the planes</span>
        <span class="k">if</span> <span class="n">shadings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="p">(</span><span class="n">shadx</span><span class="p">,</span><span class="n">shady</span><span class="p">,</span><span class="n">shadz</span><span class="p">)</span> <span class="o">=</span> <span class="n">shadings</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="p">(</span><span class="n">azi</span><span class="p">,</span><span class="n">ele</span><span class="p">)</span> <span class="o">=</span> <span class="n">viewangle</span>
            <span class="n">deg2rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.</span>
            <span class="n">shadx</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ele</span><span class="o">*</span><span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">azi</span><span class="o">*</span><span class="n">deg2rad</span><span class="p">))</span>
            <span class="n">shady</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ele</span><span class="o">*</span><span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">azi</span><span class="o">*</span><span class="n">deg2rad</span><span class="p">))</span>
            <span class="n">shadz</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ele</span><span class="o">*</span><span class="n">deg2rad</span><span class="p">))</span>
            <span class="n">maxshad</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">shadx</span><span class="p">,</span><span class="n">shady</span><span class="p">,</span><span class="n">shadz</span><span class="p">)</span>
            <span class="n">shadx</span> <span class="o">=</span> <span class="n">shadx</span> <span class="o">/</span> <span class="n">maxshad</span>
            <span class="n">shady</span> <span class="o">=</span> <span class="n">shady</span> <span class="o">/</span> <span class="n">maxshad</span>
            <span class="n">shadz</span> <span class="o">=</span> <span class="n">shadz</span> <span class="o">/</span> <span class="n">maxshad</span>

        <span class="c1"># Plotting the partial {X = x0} cut</span>
        <span class="k">if</span> <span class="s1">&#39;x&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="n">XmeshYZPass</span><span class="p">,</span> <span class="n">YmeshYZPass</span><span class="p">,</span> <span class="n">ZmeshYZPass</span><span class="p">,</span> <span class="n">rstride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cstride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">facecolors</span><span class="o">=</span><span class="n">shadx</span><span class="o">*</span><span class="n">fcolor_x_i</span><span class="p">,</span> <span class="n">shade</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">antialiased</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Plotting the partial {Y = y0} cut</span>
        <span class="k">if</span> <span class="s1">&#39;y&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="n">XmeshXZPass</span><span class="p">,</span> <span class="n">YmeshXZPass</span><span class="p">,</span> <span class="n">ZmeshXZPass</span><span class="p">,</span> <span class="n">rstride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cstride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">facecolors</span><span class="o">=</span><span class="n">shady</span><span class="o">*</span><span class="n">fcolor_y_i</span><span class="p">,</span> <span class="n">shade</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">antialiased</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Plotting the partial {Z = z0} cut</span>
        <span class="k">if</span> <span class="s1">&#39;z&#39;</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="n">XmeshXYPass</span><span class="p">,</span> <span class="n">YmeshXYPass</span><span class="p">,</span> <span class="n">ZmeshXYPass</span><span class="p">,</span> <span class="n">rstride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cstride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">facecolors</span><span class="o">=</span><span class="n">shadz</span><span class="o">*</span><span class="n">fcolor_z_i</span><span class="p">,</span> <span class="n">shade</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">antialiased</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1">#******</span>

    <span class="c1"># Plot title - adding the cut point information and tick interval length</span>
    <span class="c1"># unless title was set manually</span>
    <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">title</span><span class="o">==</span><span class="s2">&quot;msec&quot;</span> <span class="ow">or</span> <span class="n">title</span><span class="o">==</span><span class="s2">&quot;musec&quot;</span><span class="p">:</span>        
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">cutpoint</span><span class="o">/</span><span class="n">axisunituse</span> <span class="o">%</span> <span class="mi">1</span><span class="p">,</span><span class="mf">0.</span><span class="p">)):</span>
            <span class="n">plot_title</span> <span class="o">=</span> <span class="n">plot_title</span> <span class="o">+</span> <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">mathmode</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; origin at (</span><span class="si">{:,.0f}</span><span class="s1">, </span><span class="si">{:,.0f}</span><span class="s1">, </span><span class="si">{:,.0f}</span><span class="s1">) [</span><span class="si">{:s}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                         <span class="n">cutpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">axisunituse</span><span class="p">,</span><span class="n">cutpoint</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">axisunituse</span><span class="p">,</span><span class="n">cutpoint</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">axisunituse</span><span class="p">,</span><span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">mathmode</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bfstring</span><span class="p">(</span><span class="n">axisunitstr</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plot_title</span> <span class="o">=</span> <span class="n">plot_title</span> <span class="o">+</span> <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">mathmode</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; origin at (</span><span class="si">{:,.1f}</span><span class="s1">, </span><span class="si">{:,.1f}</span><span class="s1">, </span><span class="si">{:,.1f}</span><span class="s1">) [</span><span class="si">{:s}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                         <span class="n">cutpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">axisunituse</span><span class="p">,</span><span class="n">cutpoint</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">axisunituse</span><span class="p">,</span><span class="n">cutpoint</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">axisunituse</span><span class="p">,</span><span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">mathmode</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bfstring</span><span class="p">(</span><span class="n">axisunitstr</span><span class="p">)))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fixedticks</span><span class="p">:</span>
            <span class="n">tickinfostr</span> <span class="o">=</span> <span class="s1">&#39;Tick every </span><span class="si">{:,.0f}</span><span class="s1"> </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tickinterval</span><span class="o">/</span><span class="n">axisunituse</span><span class="p">,</span><span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">mathmode</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bfstring</span><span class="p">(</span><span class="n">axisunitstr</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tickinfostr</span> <span class="o">=</span> <span class="s1">&#39;Ticks at multiples of </span><span class="si">{:,.0f}</span><span class="s1"> </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tickinterval</span><span class="o">/</span><span class="n">axisunituse</span><span class="p">,</span><span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">mathmode</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bfstring</span><span class="p">(</span><span class="n">axisunitstr</span><span class="p">)))</span>

    <span class="c1">#    plot_title = pt.plot.mathmode(pt.plot.bfstring(plot_title)) + &#39;\n&#39; + pt.plot.mathmode(pt.plot.bfstring(tickinfostr))</span>
        <span class="n">plot_title</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">textbfstring</span><span class="p">(</span><span class="n">plot_title</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">textbfstring</span><span class="p">(</span><span class="n">tickinfostr</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">plot_title</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize2</span><span class="p">,</span><span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span><span class="n">position</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.85</span><span class="p">))</span>

    <span class="c1"># Colourbar title</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cb_title_use</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">cb_title_use</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">mathmode</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bfstring</span><span class="p">(</span><span class="n">cb_title_use</span><span class="p">))</span>

    <span class="c1"># Set flag which affects colorbar decimal precision</span>
    <span class="k">if</span> <span class="n">lin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">cb_linear</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">cb_linear</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Creating colorbar axes</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">nocb</span><span class="p">:</span>
        <span class="n">cax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.76</span><span class="p">,</span><span class="mf">0.2</span><span class="p">,</span><span class="mf">0.03</span><span class="p">,</span><span class="mf">0.6</span><span class="p">])</span>
        <span class="n">cbdir</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">;</span> <span class="n">horalign</span><span class="o">=</span><span class="s2">&quot;left&quot;</span>

        <span class="c1"># First draw colorbar</span>
        <span class="k">if</span> <span class="n">usesci</span><span class="p">:</span>
            <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">scamap</span><span class="p">,</span> <span class="n">ticks</span><span class="o">=</span><span class="n">ticks</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">mtick</span><span class="o">.</span><span class="n">FuncFormatter</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">cbfmtsci</span><span class="p">),</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="n">drawedges</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">scamap</span><span class="p">,</span> <span class="n">ticks</span><span class="o">=</span><span class="n">ticks</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">mtick</span><span class="o">.</span><span class="n">FuncFormatter</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">cbfmt</span><span class="p">),</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="n">drawedges</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">cb</span><span class="o">.</span><span class="n">outline</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="n">thick</span><span class="p">)</span>
        <span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="n">cbdir</span><span class="p">)</span>
        <span class="c1"># Ensure minor tick marks are off</span>
        <span class="k">if</span> <span class="n">lin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cb</span><span class="o">.</span><span class="n">minorticks_off</span><span class="p">()</span>
 
        <span class="n">cbticks</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="n">get_ticks</span><span class="p">()</span>
        <span class="n">cb</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">(</span><span class="n">cbticks</span><span class="p">[(</span><span class="n">cbticks</span><span class="o">&gt;=</span><span class="n">vminuse</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">cbticks</span><span class="o">&lt;=</span><span class="n">vmaxuse</span><span class="p">)])</span>

        <span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="n">fontsize3</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="n">thick</span><span class="p">,</span><span class="n">length</span><span class="o">=</span><span class="mi">3</span><span class="o">*</span><span class="n">thick</span><span class="p">)</span>
        <span class="n">cb_title</span> <span class="o">=</span> <span class="n">cax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">cb_title_use</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize3</span><span class="p">,</span><span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="n">horalign</span><span class="p">)</span>
        <span class="n">cb_title</span><span class="o">.</span><span class="n">set_position</span><span class="p">((</span><span class="mf">0.</span><span class="p">,</span><span class="mf">1.</span><span class="o">+</span><span class="mf">0.025</span><span class="o">*</span><span class="n">scale</span><span class="p">))</span> <span class="c1"># avoids having colourbar title too low when fontsize is increased</span>

        <span class="c1"># Perform intermediate draw if necessary to gain access to ticks</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">symlog</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">vminuse</span><span class="o">/</span><span class="n">vmaxuse</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">0.2</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">lin</span> <span class="ow">and</span> <span class="n">symlog</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span> <span class="c1"># draw to get tick positions</span>

        <span class="c1"># Adjust placement of innermost ticks for symlog if it indeed is (quasi)symmetric</span>
        <span class="k">if</span> <span class="n">symlog</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">vminuse</span><span class="o">/</span><span class="n">vmaxuse</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>
            <span class="n">cbt</span><span class="o">=</span><span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">get_ticklabels</span><span class="p">()</span>
            <span class="p">(</span><span class="n">cbtx</span><span class="p">,</span><span class="n">cbty</span><span class="p">)</span> <span class="o">=</span> <span class="n">cbt</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">cbt</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span> <span class="c1"># just below zero</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="mf">0.5</span><span class="o">-</span><span class="n">cbty</span><span class="p">)</span><span class="o">/</span><span class="n">scale</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">:</span>
                <span class="n">cbt</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">cbt</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_va</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">)</span>
            <span class="p">(</span><span class="n">cbtx</span><span class="p">,</span><span class="n">cbty</span><span class="p">)</span> <span class="o">=</span> <span class="n">cbt</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">cbt</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span> <span class="c1"># just above zero</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="mf">0.5</span><span class="o">-</span><span class="n">cbty</span><span class="p">)</span><span class="o">/</span><span class="n">scale</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">:</span>
                <span class="n">cbt</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">cbt</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_va</span><span class="p">(</span><span class="s2">&quot;bottom&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cbt</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">7</span><span class="p">:</span> <span class="c1"># If we have at least seven ticks, may want to adjust next ones as well</span>
                <span class="p">(</span><span class="n">cbtx</span><span class="p">,</span><span class="n">cbty</span><span class="p">)</span> <span class="o">=</span> <span class="n">cbt</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">cbt</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span> <span class="c1"># second below zero</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="mf">0.5</span><span class="o">-</span><span class="n">cbty</span><span class="p">)</span><span class="o">/</span><span class="n">scale</span> <span class="o">&lt;</span> <span class="mf">0.15</span><span class="p">:</span>
                    <span class="n">cbt</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">cbt</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_va</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">)</span>
                <span class="p">(</span><span class="n">cbtx</span><span class="p">,</span><span class="n">cbty</span><span class="p">)</span> <span class="o">=</span> <span class="n">cbt</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">cbt</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span> <span class="c1"># second above zero</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="mf">0.5</span><span class="o">-</span><span class="n">cbty</span><span class="p">)</span><span class="o">/</span><span class="n">scale</span> <span class="o">&lt;</span> <span class="mf">0.15</span><span class="p">:</span>
                    <span class="n">cbt</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">cbt</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_va</span><span class="p">(</span><span class="s2">&quot;bottom&quot;</span><span class="p">)</span>

        <span class="c1"># Adjust precision for colorbar ticks</span>
        <span class="n">thesetickvalues</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="n">locator</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">thesetickvalues</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">precision_b</span><span class="o">=</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mintickinterval</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">thesetickvalues</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">thesetickvalues</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="c1"># find smallest interval</span>
            <span class="k">for</span> <span class="n">ticki</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">thesetickvalues</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">mintickinterval</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">mintickinterval</span><span class="p">,</span><span class="nb">abs</span><span class="p">(</span><span class="n">thesetickvalues</span><span class="p">[</span><span class="n">ticki</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">thesetickvalues</span><span class="p">[</span><span class="n">ticki</span><span class="p">]))</span>
            <span class="n">precision_a</span><span class="p">,</span> <span class="n">precision_b</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.1e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mintickinterval</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;e&#39;</span><span class="p">)</span>
            <span class="c1"># e.g. 9.0e-1 means we need precision 1</span>
            <span class="c1"># e.g. 1.33e-1 means we need precision 3?</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">decimalprecision_cblin</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">precision_b</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span> <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">decimalprecision_cblin</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="nb">abs</span><span class="p">(</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">precision_b</span><span class="p">)))</span>
        <span class="n">cb</span><span class="o">.</span><span class="n">update_ticks</span><span class="p">()</span>

        <span class="c1"># if too many subticks in logarithmic colorbar:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lin</span> <span class="ow">and</span> <span class="n">symlog</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nlabels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">get_ticklabels</span><span class="p">())</span> <span class="c1"># TODO implement some kind of ratio like in other scripts, if needed?</span>
            <span class="n">valids</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="s1">&#39;2&#39;</span><span class="p">,</span><span class="s1">&#39;3&#39;</span><span class="p">,</span><span class="s1">&#39;4&#39;</span><span class="p">,</span><span class="s1">&#39;5&#39;</span><span class="p">,</span><span class="s1">&#39;6&#39;</span><span class="p">,</span><span class="s1">&#39;7&#39;</span><span class="p">,</span><span class="s1">&#39;8&#39;</span><span class="p">,</span><span class="s1">&#39;9&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">nlabels</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">valids</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="s1">&#39;2&#39;</span><span class="p">,</span><span class="s1">&#39;3&#39;</span><span class="p">,</span><span class="s1">&#39;4&#39;</span><span class="p">,</span><span class="s1">&#39;5&#39;</span><span class="p">,</span><span class="s1">&#39;6&#39;</span><span class="p">,</span><span class="s1">&#39;8&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">nlabels</span> <span class="o">&gt;</span> <span class="mi">19</span><span class="p">:</span>
                <span class="n">valids</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="s1">&#39;2&#39;</span><span class="p">,</span><span class="s1">&#39;5&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">nlabels</span> <span class="o">&gt;</span> <span class="mi">28</span><span class="p">:</span>
                <span class="n">valids</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">]</span>
            <span class="c1"># for label in cb.ax.yaxis.get_ticklabels()[::labelincrement]:</span>
            <span class="k">for</span> <span class="n">labi</span><span class="p">,</span><span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">get_ticklabels</span><span class="p">()):</span>
                <span class="n">labeltext</span> <span class="o">=</span> <span class="n">label</span><span class="o">.</span><span class="n">get_text</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;$&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\mbox{\textbf{--}}&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">labeltext</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">firstdigit</span> <span class="o">=</span> <span class="n">labeltext</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">firstdigit</span> <span class="ow">in</span> <span class="n">valids</span><span class="p">:</span> 
                    <span class="n">label</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>


    <span class="c1"># Add Vlasiator watermark</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">wmark</span> <span class="ow">or</span> <span class="n">wmarkb</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">wmark</span><span class="p">:</span>
            <span class="n">wm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">get_sample_data</span><span class="p">(</span><span class="n">watermarkimage</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wmark</span><span class="o">=</span><span class="n">wmarkb</span> <span class="c1"># for checking for placement</span>
            <span class="n">wm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">get_sample_data</span><span class="p">(</span><span class="n">watermarkimageblack</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">wmark</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">anchor</span> <span class="o">=</span> <span class="n">wmark</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">anchor</span><span class="o">=</span><span class="s2">&quot;NW&quot;</span>
        <span class="c1"># Allowed region and anchor used in tandem for desired effect</span>
        <span class="k">if</span> <span class="n">anchor</span><span class="o">==</span><span class="s2">&quot;NW&quot;</span> <span class="ow">or</span> <span class="n">anchor</span><span class="o">==</span><span class="s2">&quot;W&quot;</span> <span class="ow">or</span> <span class="n">anchor</span><span class="o">==</span><span class="s2">&quot;SW&quot;</span><span class="p">:</span>
            <span class="n">rect</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.98</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">anchor</span><span class="o">==</span><span class="s2">&quot;NE&quot;</span> <span class="ow">or</span> <span class="n">anchor</span><span class="o">==</span><span class="s2">&quot;E&quot;</span> <span class="ow">or</span> <span class="n">anchor</span><span class="o">==</span><span class="s2">&quot;SE&quot;</span><span class="p">:</span>
            <span class="n">rect</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.69</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.98</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">anchor</span><span class="o">==</span><span class="s2">&quot;N&quot;</span> <span class="ow">or</span> <span class="n">anchor</span><span class="o">==</span><span class="s2">&quot;C&quot;</span> <span class="ow">or</span> <span class="n">anchor</span><span class="o">==</span><span class="s2">&quot;S&quot;</span><span class="p">:</span>
            <span class="n">rect</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.35</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.98</span><span class="p">]</span>
        <span class="n">newax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">(</span><span class="n">rect</span><span class="p">,</span> <span class="n">anchor</span><span class="o">=</span><span class="n">anchor</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">newax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">wm</span><span class="p">)</span>
        <span class="n">newax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

    
    <span class="c1"># Adjust layout. Uses tight_layout() but in fact this ensures </span>
    <span class="c1"># that long titles and tick labels are still within the plot area.</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span> 
    <span class="c1"># TODO check: a warning says tight_layout() might not be compatible with those axes. Seems to work though...</span>
    <span class="n">savefig_pad</span><span class="o">=</span><span class="mf">0.01</span>
    <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span>

    <span class="c1"># Save output or draw on-screen</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">draw</span><span class="p">:</span>
        <span class="n">outputfile_default</span><span class="o">=</span><span class="n">run</span><span class="o">+</span><span class="s2">&quot;_threeSlice_&quot;</span><span class="o">+</span><span class="n">varstr</span><span class="o">+</span><span class="n">operatorfilestr</span><span class="o">+</span><span class="n">stepstr</span><span class="o">+</span><span class="s2">&quot;.png&quot;</span>
        <span class="n">savefigname</span><span class="o">=</span><span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">output_path</span><span class="p">(</span><span class="n">outputfile</span><span class="p">,</span><span class="n">outputfile_default</span><span class="p">,</span><span class="n">outputdir</span><span class="p">,</span><span class="n">nooverwrite</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Saving the figure as </span><span class="si">{}</span><span class="s1">, Time since start = </span><span class="si">{:.2f}</span><span class="s1"> s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">savefigname</span><span class="p">,</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t0</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savefigname</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="n">bbox_inches</span><span class="p">,</span> <span class="n">pad_inches</span><span class="o">=</span><span class="n">savefig_pad</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Error with attempting to save figure &quot;</span><span class="o">+</span><span class="n">savefigname</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;...Done! Time since start = </span><span class="si">{:.2f}</span><span class="s1"> s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t0</span><span class="p">))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">savefigname</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Draw on-screen</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Draw complete! Time since start = </span><span class="si">{:.2f}</span><span class="s1"> s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t0</span><span class="p">))</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, University of Helsinki.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>