

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>analysator.plot.plot_isosurface &mdash; analysator  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=9edc463e" />

  
      <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../_static/documentation_options.js?v=187304be"></script>
      <script src="../../../../_static/doctools.js?v=fd6eb6e6"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=6ffebe34"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="author" title="About these documents" href="../../../../about/" />
    <link rel="index" title="Index" href="../../../../genindex/" />
    <link rel="search" title="Search" href="../../../../search/" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../" class="icon icon-home">
            analysator
              <img src="../../../../_static/logo_color.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search/" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../analysator/">Introduction to Analysator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../analysator_exercises/">Analysator exercises</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../analysator_supported/">Analysator supported data reducers and vlasiator variables</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Analysator reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../plot/">plot</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../calculations/">calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../vlsvfile/">vlsvfile</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../miscellaneous/">miscellaneous</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../scripts/">scripts</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contribution guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../contribution_code/">Contributing code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contribution_doc/">Contributing to documentation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">About</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../about/">Credits</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../">analysator</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../">analysator</a></li>
          <li class="breadcrumb-item"><a href="../">analysator.plot</a></li>
      <li class="breadcrumb-item active">analysator.plot.plot_isosurface</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for analysator.plot.plot_isosurface</h1><div class="highlight"><pre>
<span></span><span class="c1"># </span>
<span class="c1"># This file is part of Analysator.</span>
<span class="c1"># Copyright 2013-2016 Finnish Meteorological Institute</span>
<span class="c1"># Copyright 2017-2018 University of Helsinki</span>
<span class="c1"># </span>
<span class="c1"># For details of usage, see the COPYING file and read the &quot;Rules of the Road&quot;</span>
<span class="c1"># at http://www.physics.helsinki.fi/vlasiator/</span>
<span class="c1"># </span>
<span class="c1"># This program is free software; you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU General Public License as published by</span>
<span class="c1"># the Free Software Foundation; either version 2 of the License, or</span>
<span class="c1"># (at your option) any later version.</span>
<span class="c1"># </span>
<span class="c1"># This program is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU General Public License for more details.</span>
<span class="c1"># </span>
<span class="c1"># You should have received a copy of the GNU General Public License along</span>
<span class="c1"># with this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="c1"># 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.</span>
<span class="c1"># </span>

<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">analysator</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mpl_toolkits.mplot3d</span><span class="w"> </span><span class="kn">import</span> <span class="n">Axes3D</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">cm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">skimage</span><span class="w"> </span><span class="kn">import</span> <span class="n">measure</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span><span class="o">,</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">glob</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mpl_toolkits.axes_grid1</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_axes_locatable</span><span class="p">,</span> <span class="n">inset_locator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="kn">import</span> <span class="n">BoundaryNorm</span><span class="p">,</span><span class="n">LogNorm</span><span class="p">,</span><span class="n">SymLogNorm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.ticker</span><span class="w"> </span><span class="kn">import</span> <span class="n">MaxNLocator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.ticker</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogLocator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.ticker</span><span class="w"> </span><span class="kn">import</span> <span class="n">LinearLocator</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.ticker</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mtick</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">colormaps</span> <span class="k">as</span> <span class="n">cmaps</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.cbook</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_sample_data</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">packaging.version</span><span class="w"> </span><span class="kn">import</span> <span class="n">Version</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..calculations</span><span class="w"> </span><span class="kn">import</span> <span class="n">ids3d</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>

<div class="viewcode-block" id="plot_isosurface">
<a class="viewcode-back" href="../../../../plot/#analysator.plot.plot_isosurface">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_isosurface</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">vlsvobj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">filedir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">outputdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">outputfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nooverwrite</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="c1">#</span>
                    <span class="n">surf_var</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">surf_op</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">surf_level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">color_var</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color_op</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">surf_step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="c1">#</span>
                    <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cbtitle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">draw</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">usesci</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">symmetric</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">highres</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">boxm</span><span class="o">=</span><span class="p">[],</span><span class="n">boxre</span><span class="o">=</span><span class="p">[],</span>
                    <span class="n">colormap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">run</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">wmark</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nocb</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">unit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">thick</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                    <span class="n">vscale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                    <span class="n">vmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">symlog</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">angle</span> <span class="o">=</span> <span class="p">[</span><span class="mf">30.</span><span class="p">,</span><span class="mf">90.</span><span class="p">],</span> <span class="n">transparent</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">):</span>

<span class="w">    </span><span class="sd">&#39;&#39;&#39; Plots a coloured isosurface plot with axes and a colour bar.</span>

<span class="sd">    :kwarg filename:    path to .vlsv file to use for input. Assumes a bulk file.</span>
<span class="sd">    :kwarg vlsvobj:     Optionally provide a python vlsvfile object instead</span>
<span class="sd">    :kwarg filedir:     Optionally provide directory where files are located and use step for bulk file name</span>
<span class="sd">    :kwarg step:        output step index, used for constructing output (and possibly input) filename</span>
<span class="sd">    :kwarg outputdir:   path to directory where output files are created (default: $HOME/Plots/ or override with PTOUTPUTDIR)</span>
<span class="sd">                        If directory does not exist, it will be created. If the string does not end in a</span>
<span class="sd">                        forward slash, the final parti will be used as a perfix for the files.</span>
<span class="sd">    :kwarg outputfile:  Full path to output file, will make directory if it does not exist. Overrides outputdir.</span>
<span class="sd">    :kwarg nooverwrite: Set to only perform actions if the target output file does not yet exist                    </span>
<span class="sd">     </span>
<span class="sd">    :kwarg surf_var:    Variable to read for defining surface</span>
<span class="sd">    :kwarg surf_op:     Operator to use for variable to read surface</span>
<span class="sd">    :kwarg surf_level:  Level at which to define surface</span>
<span class="sd">    :kwarg surf_step:   Vertex stepping for surface generation: larger value returns coarser surface</span>

<span class="sd">    :kwarg color_var:   Variable to read for coloring surface</span>
<span class="sd">    :kwarg color_op:    Operator to use for variable to color surface (&#39;x&#39;, &#39;y&#39;, &#39;z&#39;; if None and color_var is a vector, the magnitude is taken)</span>
<span class="sd">           </span>
<span class="sd">    :kwarg boxm:        zoom box extents [x0,x1,y0,y1] in metres (default and truncate to: whole simulation box)</span>
<span class="sd">    :kwarg boxre:       zoom box extents [x0,x1,y0,y1] in Earth radii (default and truncate to: whole simulation box)</span>
<span class="sd">    :kwarg colormap:    colour scale for plot, use e.g. hot_desaturated, jet, viridis, plasma, inferno,</span>
<span class="sd">                        magma, parula, nipy_spectral, RdBu, bwr</span>
<span class="sd">    :kwarg run:         run identifier, used for constructing output filename</span>
<span class="sd">    :kwarg title:       string to use as plot title instead of time</span>
<span class="sd">    :kwarg cbtitle:     string to use as colorbar title instead of map name</span>
<span class="sd">    :kwarg unit:        Plot axes using 10^{unit} m (default: Earth radius R_E)</span>

<span class="sd">    :kwarg usesci:      Use scientific notation for colorbar ticks? (default: 1)</span>
<span class="sd">    :kwarg vscale:      Scale all values with this before plotting. Useful for going from e.g. m^-3 to cm^-3</span>
<span class="sd">                        or from tesla to nanotesla. Guesses correct units for colourbar for some known</span>
<span class="sd">                        variables. Set to None to seek for a default scaling.</span>
<span class="sd">    :kwarg vmin,vmax:   min and max values for colour scale and colour bar. If no values are given,</span>
<span class="sd">                        min and max values for whole plot (non-zero rho regions only) are used.</span>
<span class="sd">    :kwarg symmetric:   Set the absolute value of vmin and vmax to the greater of the two</span>
<span class="sd">    :kwarg lin:         Flag for using linear colour scaling instead of log</span>
<span class="sd">    :kwarg symlog:      Use logarithmic scaling, but linear when abs(value) is below the value given to symlog.</span>
<span class="sd">                        Allows symmetric quasi-logarithmic plots of e.g. transverse field components.</span>
<span class="sd">                        A given of 0 translates to a threshold of max(abs(vmin),abs(vmax)) * 1.e-2.</span>
<span class="sd">    :kwarg wmark:       If set to non-zero, will plot a Vlasiator watermark in the top left corner.</span>
<span class="sd">    :kwarg highres:     Creates the image in high resolution, scaled up by this value (suitable for logging.info). </span>
<span class="sd">    :kwarg draw:        Set to nonzero in order to draw image on-screen instead of saving to file (requires x-windowing)</span>
<span class="sd">    :kwarg transparent: Set to False in order to make the surface opaque</span>
<span class="sd">    :kwarg scale:       Scale text size (default=1.0)</span>
<span class="sd">    :kwarg thick:       line and axis thickness, default=1.0</span>
<span class="sd">    :kwarg nocb:        Set to suppress drawing of colourbar</span>
<span class="sd">    :kwarg angle:       Viewing elevation and azimuthal angles in degrees</span>

<span class="sd">    :returns:           Outputs an image to a file or to the screen.</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># Verify the location of this watermark image</span>
    <span class="n">watermarkimage</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;logo_color.png&#39;</span><span class="p">)</span>
    <span class="c1"># watermarkimage=os.path.expandvars(&#39;$HOME/appl_taito/analysator/pyPlot/logo_color.png&#39;)</span>


    <span class="c1"># Input file or object</span>
    <span class="k">if</span> <span class="n">filename</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
        <span class="n">f</span><span class="o">=</span><span class="n">pt</span><span class="o">.</span><span class="n">vlsvfile</span><span class="o">.</span><span class="n">VlsvReader</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">vlsvobj</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
        <span class="n">f</span><span class="o">=</span><span class="n">vlsvobj</span>
    <span class="k">elif</span> <span class="p">((</span><span class="n">filedir</span><span class="o">!=</span><span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">step</span><span class="o">!=</span><span class="kc">None</span><span class="p">)):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">filedir</span><span class="o">+</span><span class="s1">&#39;bulk*&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">step</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="s1">&#39;0&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.vlsv&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1">#filename = filedir+&#39;bulk.&#39;+str(step).rjust(7,&#39;0&#39;)+&#39;.vlsv&#39;</span>
        <span class="n">f</span><span class="o">=</span><span class="n">pt</span><span class="o">.</span><span class="n">vlsvfile</span><span class="o">.</span><span class="n">VlsvReader</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Error, needs a .vlsv file name, python object, or directory and step&quot;</span><span class="p">)</span>

                
    <span class="c1"># Scientific notation for colorbar ticks?</span>
    <span class="k">if</span> <span class="n">usesci</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
        <span class="n">usesci</span><span class="o">=</span><span class="mi">1</span>
    
    <span class="k">if</span> <span class="n">colormap</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Default values</span>
        <span class="n">colormap</span><span class="o">=</span><span class="s2">&quot;hot_desaturated&quot;</span>
        <span class="k">if</span> <span class="n">color_op</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
            <span class="n">colormap</span><span class="o">=</span><span class="s2">&quot;bwr&quot;</span>

    <span class="n">cmapuse</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">colormap</span><span class="p">)</span>

    <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="o">*</span><span class="n">scale</span> <span class="c1"># Most text</span>
    <span class="n">fontsize2</span><span class="o">=</span><span class="mi">10</span><span class="o">*</span><span class="n">scale</span> <span class="c1"># Time title</span>
    <span class="n">fontsize3</span><span class="o">=</span><span class="mi">7</span><span class="o">*</span><span class="n">scale</span> <span class="c1"># Colour bar ticks</span>

    <span class="c1"># Plot title with time</span>
    <span class="n">timeval</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">timeval</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">read_parameter</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">timeval</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
        <span class="n">timeval</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">read_parameter</span><span class="p">(</span><span class="s2">&quot;t&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">timeval</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Unknown time format encountered&quot;</span><span class="p">)</span>

    <span class="c1"># Plot title with time</span>
    <span class="k">if</span> <span class="n">title</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>        
        <span class="k">if</span> <span class="n">timeval</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>    
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Unknown time format encountered&quot;</span><span class="p">)</span>
            <span class="n">plot_title</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#plot_title = &quot;t=&quot;+str(int(timeval))+&#39; s&#39;</span>
            <span class="n">plot_title</span> <span class="o">=</span> <span class="s2">&quot;t=&quot;</span><span class="o">+</span><span class="s1">&#39;</span><span class="si">{:4.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">timeval</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; s&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plot_title</span> <span class="o">=</span> <span class="n">title</span>

    <span class="c1"># step, used for file name</span>
    <span class="k">if</span> <span class="n">step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">stepstr</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">step</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">filename</span><span class="p">:</span>
            <span class="n">stepstr</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">filename</span><span class="p">[</span><span class="o">-</span><span class="mi">12</span><span class="p">:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stepstr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="c1"># If run name isn&#39;t given, just put &quot;plot&quot; in the output file name</span>
    <span class="k">if</span> <span class="n">run</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
        <span class="n">run</span><span class="o">=</span><span class="s1">&#39;plot&#39;</span>

    <span class="c1"># Verify validity of operator</span>
    <span class="n">surf_opstr</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="n">color_opstr</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">color_op</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">color_op</span><span class="o">!=</span><span class="s1">&#39;x&#39;</span> <span class="ow">and</span> <span class="n">color_op</span><span class="o">!=</span><span class="s1">&#39;y&#39;</span> <span class="ow">and</span> <span class="n">color_op</span><span class="o">!=</span><span class="s1">&#39;z&#39;</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Unknown operator &quot;</span><span class="o">+</span><span class="n">color_op</span><span class="o">+</span><span class="s2">&quot;, defaulting to None/magnitude for a vector.&quot;</span><span class="p">)</span>
            <span class="n">color_op</span><span class="o">=</span><span class="kc">None</span>            
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># For components, always use linear scale, unless symlog is set</span>
            <span class="n">color_opstr</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">color_op</span>
            <span class="k">if</span> <span class="n">symlog</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
                <span class="n">lin</span><span class="o">=</span><span class="mi">7</span>
    <span class="c1"># Verify validity of operator</span>
    <span class="k">if</span> <span class="n">surf_op</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">surf_op</span><span class="o">!=</span><span class="s1">&#39;x&#39;</span> <span class="ow">and</span> <span class="n">surf_op</span><span class="o">!=</span><span class="s1">&#39;y&#39;</span> <span class="ow">and</span> <span class="n">surf_op</span><span class="o">!=</span><span class="s1">&#39;z&#39;</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Unknown operator &quot;</span><span class="o">+</span><span class="n">surf_op</span><span class="p">)</span>
            <span class="n">surf_op</span><span class="o">=</span><span class="kc">None</span>            
        <span class="k">else</span><span class="p">:</span>
            <span class="n">surf_opstr</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">surf_op</span>

    <span class="c1"># Output file name</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">surf_var</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;surf_var must be provided for isosurface plotting.&quot;</span><span class="p">)</span>

    <span class="n">surf_varstr</span><span class="o">=</span><span class="n">surf_var</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">color_var</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
        <span class="n">color_varstr</span><span class="o">=</span><span class="n">color_var</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">color_varstr</span><span class="o">=</span><span class="s2">&quot;solid&quot;</span>

    <span class="n">Re</span> <span class="o">=</span> <span class="mf">6.371e+6</span> <span class="c1"># Earth radius in moutputpref</span>
    <span class="c1"># read in mesh size and cells in ordinary space</span>
    <span class="p">[</span><span class="n">xsize</span><span class="p">,</span> <span class="n">ysize</span><span class="p">,</span> <span class="n">zsize</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get_spatial_mesh_size</span><span class="p">()</span>
    <span class="n">xsize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">xsize</span><span class="p">)</span>
    <span class="n">ysize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ysize</span><span class="p">)</span>
    <span class="n">zsize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">zsize</span><span class="p">)</span>    
    <span class="p">[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">zmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">zmax</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get_spatial_mesh_extent</span><span class="p">()</span>
    <span class="n">cellsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmax</span><span class="o">-</span><span class="n">xmin</span><span class="p">)</span><span class="o">/</span><span class="n">xsize</span>
    <span class="n">cellids</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read_variable</span><span class="p">(</span><span class="s2">&quot;CellID&quot;</span><span class="p">)</span>

    <span class="c1"># Read the FSgrid mesh</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="p">[</span><span class="n">xsizefg</span><span class="p">,</span> <span class="n">ysizefg</span><span class="p">,</span> <span class="n">zsizefg</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get_fsgrid_mesh_size</span><span class="p">()</span>
        <span class="n">xsizefg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">xsizefg</span><span class="p">)</span>
        <span class="n">ysizefg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ysizefg</span><span class="p">)</span>
        <span class="n">zsizefg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">zsizefg</span><span class="p">)</span>
        <span class="p">[</span><span class="n">xminfg</span><span class="p">,</span> <span class="n">yminfg</span><span class="p">,</span> <span class="n">zminfg</span><span class="p">,</span> <span class="n">xmaxfg</span><span class="p">,</span> <span class="n">ymaxfg</span><span class="p">,</span> <span class="n">zmaxfg</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get_fsgrid_mesh_extent</span><span class="p">()</span>
        <span class="n">cellsizefg</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmaxfg</span><span class="o">-</span><span class="n">xminfg</span><span class="p">)</span><span class="o">/</span><span class="n">xsizefg</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">plot_helpers</span><span class="o">.</span><span class="n">CELLSIZE</span> <span class="o">=</span> <span class="n">cellsizefg</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">xsize</span><span class="o">!=</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">ysize</span><span class="o">!=</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">zsize</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Did not find fsgrid data, but found 3D DCCRG mesh. Attempting to adapt.&quot;</span><span class="p">)</span>
            <span class="p">[</span><span class="n">xsizefg</span><span class="p">,</span> <span class="n">ysizefg</span><span class="p">,</span> <span class="n">zsizefg</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">xsize</span> <span class="o">*</span> <span class="mi">2</span><span class="o">**</span><span class="n">f</span><span class="o">.</span><span class="n">get_max_refinement_level</span><span class="p">(),</span> <span class="n">ysize</span> <span class="o">*</span> <span class="mi">2</span><span class="o">**</span><span class="n">f</span><span class="o">.</span><span class="n">get_max_refinement_level</span><span class="p">(),</span> <span class="n">zsize</span> <span class="o">*</span> <span class="mi">2</span><span class="o">**</span><span class="n">f</span><span class="o">.</span><span class="n">get_max_refinement_level</span><span class="p">()]</span>
            <span class="p">[</span><span class="n">xminfg</span><span class="p">,</span> <span class="n">yminfg</span><span class="p">,</span> <span class="n">zminfg</span><span class="p">,</span> <span class="n">xmaxfg</span><span class="p">,</span> <span class="n">ymaxfg</span><span class="p">,</span> <span class="n">zmaxfg</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">zmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">zmax</span><span class="p">]</span>
            <span class="n">cellsizefg</span> <span class="o">=</span> <span class="n">cellsize</span>
            <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">plot_helpers</span><span class="o">.</span><span class="n">CELLSIZE</span> <span class="o">=</span> <span class="n">cellsize</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Found 2D DCCRG mesh without FSgrid data. Exiting.&quot;</span><span class="p">)</span>

    <span class="c1"># sort the cellid and the datamap list</span>
    <span class="n">indexids</span> <span class="o">=</span> <span class="n">cellids</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
    <span class="n">cellids</span> <span class="o">=</span> <span class="n">cellids</span><span class="p">[</span><span class="n">indexids</span><span class="p">]</span>

    <span class="c1"># find the highest refiment level</span>
    <span class="n">reflevel</span> <span class="o">=</span> <span class="n">ids3d</span><span class="o">.</span><span class="n">refinement_level</span><span class="p">(</span><span class="n">xsize</span><span class="p">,</span> <span class="n">ysize</span><span class="p">,</span> <span class="n">zsize</span><span class="p">,</span> <span class="n">cellids</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span> <span class="c1"># Check if Vlasov grid doesn&#39;t reach maximum (fsgrid) refinement</span>
        <span class="k">if</span> <span class="n">xsize</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="n">reflevel</span> <span class="o">+</span> <span class="n">i</span><span class="p">))</span> <span class="o">==</span> <span class="n">xsizefg</span><span class="p">:</span>
            <span class="n">reflevel</span> <span class="o">+=</span> <span class="n">i</span>
            <span class="k">break</span>


    <span class="k">if</span> <span class="p">(</span><span class="n">xsize</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">ysize</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">zsize</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot; isosurface plotting requires 3D spatial domain!&quot;</span><span class="p">)</span>


    <span class="n">simext</span><span class="o">=</span><span class="p">[</span><span class="n">xmin</span><span class="p">,</span><span class="n">xmax</span><span class="p">,</span><span class="n">ymin</span><span class="p">,</span><span class="n">ymax</span><span class="p">,</span><span class="n">zmin</span><span class="p">,</span><span class="n">zmax</span><span class="p">]</span>
    <span class="n">sizes</span><span class="o">=</span><span class="p">[</span><span class="n">xsize</span><span class="p">,</span><span class="n">ysize</span><span class="p">,</span><span class="n">zsize</span><span class="p">]</span>

    <span class="c1"># Select window to draw</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">boxm</span><span class="p">)</span><span class="o">==</span><span class="mi">6</span><span class="p">:</span>
        <span class="n">boxcoords</span><span class="o">=</span><span class="n">boxm</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">boxre</span><span class="p">)</span><span class="o">==</span><span class="mi">6</span><span class="p">:</span>
        <span class="n">boxcoords</span><span class="o">=</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">Re</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">boxre</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">boxcoords</span><span class="o">=</span><span class="n">simext</span>

    <span class="c1"># If box extents were provided manually, truncate to simulation extents</span>
    <span class="n">boxcoords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">simext</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">boxcoords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">simext</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">boxcoords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">simext</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">boxcoords</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">simext</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">boxcoords</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">simext</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
    <span class="n">boxcoords</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="n">simext</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>

    <span class="c1"># Axes and units (default R_E)</span>
    <span class="k">if</span> <span class="n">unit</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span> <span class="c1"># Use m or km or other</span>
        <span class="k">if</span> <span class="n">unit</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">unitstr</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">rmstring</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">unit</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
            <span class="n">unitstr</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">rmstring</span><span class="p">(</span><span class="s1">&#39;km&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">unitstr</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;10^{&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">unit</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;} &#39;</span><span class="o">+</span><span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">rmstring</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">)</span>
        <span class="n">unit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">unit</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">unitstr</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">rmstring</span><span class="p">(</span><span class="s1">&#39;R&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">rmstring</span><span class="p">(</span><span class="s1">&#39;E&#39;</span><span class="p">)</span>
        <span class="n">unit</span> <span class="o">=</span> <span class="n">Re</span>
    <span class="n">unitstr</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">mathmode</span><span class="p">(</span><span class="n">unitstr</span><span class="p">)</span>
        
    <span class="c1"># Scale data extent and plot box</span>
    <span class="n">simext_org</span> <span class="o">=</span> <span class="n">simext</span>
    <span class="n">simext</span><span class="o">=</span><span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="n">unit</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">simext</span><span class="p">]</span>
    <span class="n">boxcoords</span><span class="o">=</span><span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="n">unit</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">boxcoords</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">color_var</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">color_op</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
            <span class="n">color_op</span><span class="o">=</span><span class="s2">&quot;pass&quot;</span>
        <span class="n">datamap_info</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read_variable_info</span><span class="p">(</span><span class="n">color_var</span><span class="p">,</span> <span class="n">operator</span><span class="o">=</span><span class="n">color_op</span><span class="p">)</span>

        <span class="n">cb_title_use</span> <span class="o">=</span> <span class="n">datamap_info</span><span class="o">.</span><span class="n">latex</span>
        <span class="c1"># Check if vscale results in standard unit</span>
        <span class="n">vscale</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">datamap_unit_latex</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">get_scaled_units</span><span class="p">(</span><span class="n">vscale</span><span class="o">=</span><span class="n">vscale</span><span class="p">,</span><span class="n">variable_info</span><span class="o">=</span><span class="n">datamap_info</span><span class="p">)</span>

        <span class="c1"># Add unit to colorbar title</span>
        <span class="k">if</span> <span class="n">datamap_unit_latex</span><span class="p">:</span>
            <span class="n">cb_title_use</span> <span class="o">=</span> <span class="n">cb_title_use</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;\,[&quot;</span><span class="o">+</span><span class="n">datamap_unit_latex</span><span class="o">+</span><span class="s2">&quot;]&quot;</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1"># color_var==None</span>
        <span class="n">cb_title_use</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">nocb</span><span class="o">=</span><span class="mi">1</span>

    <span class="k">if</span> <span class="n">cbtitle</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Here allow underscores for manual math mode</span>
        <span class="n">cb_title_use</span> <span class="o">=</span> <span class="n">cbtitle</span>      


    <span class="k">if</span> <span class="n">surf_op</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">surf_op</span><span class="o">=</span><span class="s2">&quot;pass&quot;</span>
    <span class="n">surf_datamap_info</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read_variable_info</span><span class="p">(</span><span class="n">surf_var</span><span class="p">,</span> <span class="n">operator</span><span class="o">=</span><span class="n">surf_op</span><span class="p">)</span>

    <span class="n">surf_datamap</span> <span class="o">=</span> <span class="n">surf_datamap_info</span><span class="o">.</span><span class="n">data</span>

    <span class="c1"># Verify data shape</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">surf_datamap</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot; read only single surface variable value from vlsv file! surf_datamap.shape being &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">surf_datamap</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

    

    <span class="c1">#Define the box limits</span>
    <span class="n">low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">boxcoords</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">boxcoords</span><span class="p">[</span><span class="mi">4</span><span class="p">]])</span><span class="o">*</span><span class="n">unit</span>
    <span class="n">up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">boxcoords</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">boxcoords</span><span class="p">[</span><span class="mi">5</span><span class="p">]])</span><span class="o">*</span><span class="n">unit</span>

    <span class="c1"># Choose CellIDs inside the box</span>
    <span class="n">ids</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">ids3d</span><span class="o">.</span><span class="n">ids3d_box</span><span class="p">(</span><span class="n">cellids</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="n">reflevel</span><span class="p">,</span> <span class="n">xsize</span><span class="p">,</span> <span class="n">ysize</span><span class="p">,</span> <span class="n">zsize</span><span class="p">,</span> <span class="p">[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">zmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">zmax</span><span class="p">])</span>

    <span class="n">surf_datamap</span> <span class="o">=</span> <span class="n">surf_datamap</span><span class="p">[</span><span class="n">indexids</span><span class="p">]</span>
    <span class="n">surf_datamap</span> <span class="o">=</span> <span class="n">surf_datamap</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

    <span class="c1"># Reshape surface data</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">surf_datamap</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">surf_data_in_box</span> <span class="o">=</span> <span class="n">ids3d</span><span class="o">.</span><span class="n">idmesh3d2</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">surf_datamap</span><span class="p">,</span> <span class="n">reflevel</span><span class="p">,</span> <span class="n">xsize</span><span class="p">,</span> <span class="n">ysize</span><span class="p">,</span> <span class="n">zsize</span><span class="p">,</span>  <span class="kc">None</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">surf_datamap</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">surf_data_in_box</span> <span class="o">=</span> <span class="n">ids3d</span><span class="o">.</span><span class="n">idmesh3d2</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">surf_datamap</span><span class="p">,</span> <span class="n">reflevel</span><span class="p">,</span> <span class="n">xsize</span><span class="p">,</span> <span class="n">ysize</span><span class="p">,</span> <span class="n">zsize</span><span class="p">,</span> <span class="n">surf_datamap</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">surf_datamap</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
        <span class="n">surf_data_in_box</span> <span class="o">=</span> <span class="n">ids3d</span><span class="o">.</span><span class="n">idmesh3d2</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">surf_datamap</span><span class="p">,</span> <span class="n">reflevel</span><span class="p">,</span> <span class="n">xsize</span><span class="p">,</span> <span class="n">ysize</span><span class="p">,</span> <span class="n">zsize</span><span class="p">,</span> <span class="p">(</span><span class="n">surf_datamap</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">surf_datamap</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Dimension error in constructing 2D AMR slice!&quot;</span><span class="p">)</span>

    <span class="c1"># Remove empty rows, columns and tubes</span>
    <span class="n">empty_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">surf_data_in_box</span><span class="o">==</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">empty_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">surf_data_in_box</span><span class="o">==</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

    <span class="n">MaskX</span> <span class="o">=</span> <span class="n">empty_1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">MaskY</span> <span class="o">=</span> <span class="n">empty_0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">MaskZ</span> <span class="o">=</span> <span class="n">empty_1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">cropped_surf_data</span> <span class="o">=</span> <span class="n">surf_data_in_box</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">MaskX</span><span class="p">):</span><span class="nb">max</span><span class="p">(</span><span class="n">MaskX</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,:,:]</span>
    <span class="n">cropped_surf_data</span> <span class="o">=</span> <span class="n">cropped_surf_data</span><span class="p">[:,</span><span class="nb">min</span><span class="p">(</span><span class="n">MaskY</span><span class="p">):</span><span class="nb">max</span><span class="p">(</span><span class="n">MaskY</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,:]</span>
    <span class="n">cropped_surf_data</span> <span class="o">=</span> <span class="n">cropped_surf_data</span><span class="p">[:,:,</span><span class="nb">min</span><span class="p">(</span><span class="n">MaskZ</span><span class="p">):</span><span class="nb">max</span><span class="p">(</span><span class="n">MaskZ</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>


    <span class="c1"># Keep removing the face of the rectangle with the largest number of invalid values until the surface has only proper values</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">zero_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">zero_counts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">cropped_surf_data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>  <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># Face 0 (front)</span>
        <span class="n">zero_counts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">cropped_surf_data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Face 1 (back)</span>
        <span class="n">zero_counts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">cropped_surf_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>  <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># Face 2 (left)</span>
        <span class="n">zero_counts</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">cropped_surf_data</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Face 3 (right)</span>
        <span class="n">zero_counts</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">cropped_surf_data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>  <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># Face 4 (top)</span>
        <span class="n">zero_counts</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">cropped_surf_data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Face 5 (bottom)</span>

        <span class="n">face_to_be_removed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">zero_counts</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">face_to_be_removed</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">cropped_surf_data</span> <span class="o">=</span> <span class="n">cropped_surf_data</span><span class="p">[</span><span class="mi">1</span><span class="p">:,:,:]</span>
        <span class="k">elif</span> <span class="n">face_to_be_removed</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">cropped_surf_data</span> <span class="o">=</span> <span class="n">cropped_surf_data</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:,:]</span>
        <span class="k">elif</span> <span class="n">face_to_be_removed</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">cropped_surf_data</span> <span class="o">=</span> <span class="n">cropped_surf_data</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:,:]</span>
        <span class="k">elif</span> <span class="n">face_to_be_removed</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
            <span class="n">cropped_surf_data</span> <span class="o">=</span> <span class="n">cropped_surf_data</span><span class="p">[:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span>
        <span class="k">elif</span> <span class="n">face_to_be_removed</span><span class="o">==</span><span class="mi">4</span><span class="p">:</span>
            <span class="n">cropped_surf_data</span> <span class="o">=</span> <span class="n">cropped_surf_data</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">elif</span> <span class="n">face_to_be_removed</span><span class="o">==</span><span class="mi">5</span><span class="p">:</span>
            <span class="n">cropped_surf_data</span> <span class="o">=</span> <span class="n">cropped_surf_data</span><span class="p">[:,:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">counter</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">counter</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>    <span class="c1"># Failsafe</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Error with boundaries! Exiting.&quot;</span><span class="p">)</span>

        
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">zero_counts</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
            <span class="k">break</span> 
    

    <span class="k">if</span> <span class="n">surf_level</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
        <span class="n">surf_level</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">cropped_surf_data</span><span class="p">)</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">cropped_surf_data</span><span class="p">))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Minimum found surface value &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">cropped_surf_data</span><span class="p">))</span><span class="o">+</span><span class="s2">&quot; surface level &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">surf_level</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; max &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">cropped_surf_data</span><span class="p">)))</span>

    <span class="c1"># Select plotting back-end based on on-screen plotting or direct to file without requiring x-windowing</span>
    <span class="k">if</span> <span class="n">draw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">get_backend</span><span class="p">())</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">pt</span><span class="o">.</span><span class="n">backend_interactive</span><span class="p">:</span> <span class="c1">#&#39;TkAgg&#39;: </span>
            <span class="n">plt</span><span class="o">.</span><span class="n">switch_backend</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">backend_interactive</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">get_backend</span><span class="p">())</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">pt</span><span class="o">.</span><span class="n">backend_noninteractive</span><span class="p">:</span> <span class="c1">#&#39;Agg&#39;:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">switch_backend</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">backend_noninteractive</span><span class="p">)</span>  


    <span class="n">spacing</span> <span class="o">=</span> <span class="p">((</span><span class="n">xmaxfg</span><span class="o">-</span><span class="n">xminfg</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">xsizefg</span><span class="o">*</span><span class="n">unit</span><span class="p">),</span> <span class="p">(</span><span class="n">ymaxfg</span><span class="o">-</span><span class="n">yminfg</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">ysizefg</span><span class="o">*</span><span class="n">unit</span><span class="p">),</span> <span class="p">(</span><span class="n">zmaxfg</span><span class="o">-</span><span class="n">zminfg</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">zsizefg</span><span class="o">*</span><span class="n">unit</span><span class="p">))</span>

    <span class="n">verts</span><span class="p">,</span> <span class="n">faces</span><span class="p">,</span> <span class="n">normals</span><span class="p">,</span> <span class="n">arrays</span> <span class="o">=</span> <span class="n">measure</span><span class="o">.</span><span class="n">marching_cubes</span><span class="p">(</span><span class="n">cropped_surf_data</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">surf_level</span><span class="p">,</span>
                                                                   <span class="n">spacing</span><span class="o">=</span><span class="n">spacing</span><span class="p">,</span>
                                                                   <span class="n">gradient_direction</span><span class="o">=</span><span class="s1">&#39;descent&#39;</span><span class="p">,</span>
                                                                   <span class="n">step_size</span><span class="o">=</span><span class="n">surf_step</span><span class="p">,</span>
                                                                   <span class="n">allow_degenerate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;lewiner&#39;</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">cropped_surf_data</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span>
    


    <span class="c1">#offset with respect to simulation domain corner</span>
    <span class="n">verts</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">verts</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">low</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">unit</span>
    <span class="n">verts</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">verts</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">low</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">unit</span>
    <span class="n">verts</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">verts</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">low</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">unit</span>

    <span class="c1"># A box that contains the isosurface</span>
    <span class="n">contour_box_low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">min</span><span class="p">(</span><span class="n">verts</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="nb">min</span><span class="p">(</span><span class="n">verts</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="nb">min</span><span class="p">(</span><span class="n">verts</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">unit</span>
    <span class="n">contour_box_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">max</span><span class="p">(</span><span class="n">verts</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="nb">max</span><span class="p">(</span><span class="n">verts</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="nb">max</span><span class="p">(</span><span class="n">verts</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">unit</span>



    <span class="c1"># Next find color variable values at vertices</span>
    <span class="k">if</span> <span class="n">color_var</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nverts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">verts</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Extracting color values for &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">nverts</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; vertices and &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">faces</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]))</span><span class="o">+</span><span class="s2">&quot; faces.&quot;</span><span class="p">)</span>
        <span class="n">all_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nverts</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nverts</span><span class="p">):</span>            
            <span class="c1"># # due to mesh generation, some coordinates may be outside simulation domain</span>
            <span class="c1"># WARNING this means it might be doing wrong things in the periodic dimension of 2.9D runs.</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">verts</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">*</span><span class="n">unit</span> 
            <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">simext_org</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mf">0.1</span><span class="o">*</span><span class="n">cellsize</span><span class="p">)</span>
            <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">simext_org</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">cellsize</span><span class="p">)</span>
            <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">simext_org</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mf">0.1</span><span class="o">*</span><span class="n">cellsize</span><span class="p">)</span>
            <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">simext_org</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">cellsize</span><span class="p">)</span>
            <span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">simext_org</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="mf">0.1</span><span class="o">*</span><span class="n">cellsize</span><span class="p">)</span>
            <span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">simext_org</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">-</span><span class="n">cellsize</span><span class="p">)</span>
            <span class="n">all_coords</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">coords</span>


        <span class="c1"># Choose CellIDs inside the isosurface box</span>
        <span class="n">color_ids</span><span class="p">,</span> <span class="n">color_idx</span> <span class="o">=</span> <span class="n">ids3d</span><span class="o">.</span><span class="n">ids3d_box</span><span class="p">(</span><span class="n">cellids</span><span class="p">,</span> <span class="n">contour_box_low</span><span class="p">,</span> <span class="n">contour_box_up</span><span class="p">,</span> <span class="n">reflevel</span><span class="p">,</span> <span class="n">xsize</span><span class="p">,</span> <span class="n">ysize</span><span class="p">,</span> <span class="n">zsize</span><span class="p">,</span> <span class="p">[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">zmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">zmax</span><span class="p">])</span>

        <span class="c1"># Read the variables to be plotted inside the box</span>
        <span class="k">if</span> <span class="n">color_op</span><span class="o">==</span><span class="s2">&quot;pass&quot;</span><span class="p">:</span>
            <span class="n">vg_colors</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read_variable</span><span class="p">(</span><span class="n">color_var</span><span class="p">,</span> <span class="n">color_ids</span><span class="p">)</span>
            <span class="c1"># If value was vector value, take magnitude</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">vg_colors</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">vg_colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">vg_colors</span><span class="p">),</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vg_colors</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read_variable</span><span class="p">(</span><span class="n">color_var</span><span class="p">,</span> <span class="n">color_ids</span><span class="p">,</span> <span class="n">operator</span><span class="o">=</span><span class="n">color_op</span><span class="p">)</span>            
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">vg_colors</span><span class="p">)</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Error reading color variable &quot;</span><span class="o">+</span><span class="n">color_var</span><span class="o">+</span><span class="s2">&quot;! Exiting.&quot;</span><span class="p">)</span>


        <span class="n">vg_coords</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read_variable</span><span class="p">(</span><span class="s2">&quot;vg_coordinates&quot;</span><span class="p">,</span> <span class="n">color_ids</span><span class="p">)</span>

        <span class="c1"># Interpolate the values to the surface</span>
        <span class="n">interpolation</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">RBFInterpolator</span><span class="p">(</span><span class="n">vg_coords</span><span class="p">,</span> <span class="n">vg_colors</span><span class="p">,</span> <span class="n">neighbors</span> <span class="o">=</span> <span class="mi">27</span><span class="p">)</span>

        <span class="n">color_data</span> <span class="o">=</span> <span class="n">interpolation</span><span class="p">(</span><span class="n">all_coords</span><span class="p">)</span><span class="o">*</span><span class="n">vscale</span>

        <span class="c1"># Make sure color data is 1-dimensional (e.g. magnitude of E instead of 3 components)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">color_data</span><span class="p">)</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">color_data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">color_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">color_var</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
        <span class="c1"># dummy norm</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No surface color given, using dummy setup&quot;</span><span class="p">)</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">BoundaryNorm</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">ncolors</span><span class="o">=</span><span class="n">cmapuse</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">vminuse</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">vmaxuse</span><span class="o">=</span><span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># If automatic range finding is required, find min and max of array</span>
        <span class="c1"># Performs range-finding on a masked array to work even if array contains invalid values</span>
        <span class="n">color_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_invalid</span><span class="p">(</span><span class="n">color_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vmin</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
            <span class="n">vminuse</span><span class="o">=</span><span class="n">vmin</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">vminuse</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">color_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vmax</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
            <span class="n">vmaxuse</span><span class="o">=</span><span class="n">vmax</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vmaxuse</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">color_data</span><span class="p">)</span>       

        <span class="c1"># If both values are zero, we have an empty array</span>
        <span class="k">if</span> <span class="n">vmaxuse</span><span class="o">==</span><span class="n">vminuse</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Error, requested array is zero everywhere. Exiting.&quot;</span><span class="p">)</span>

        <span class="c1"># If vminuse and vmaxuse are extracted from data, different signs, and close to each other, adjust to be symmetric</span>
        <span class="c1"># e.g. to plot transverse field components. Always done for symlog.</span>
        <span class="k">if</span> <span class="n">vmin</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">vmax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">symmetric</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">vminuse</span><span class="o">/</span><span class="n">vmaxuse</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span> <span class="ow">or</span> <span class="n">symlog</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">absval</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">vminuse</span><span class="p">),</span><span class="nb">abs</span><span class="p">(</span><span class="n">vmaxuse</span><span class="p">))</span>
                <span class="n">vminuse</span> <span class="o">=</span> <span class="o">-</span><span class="n">absval</span>
                <span class="n">vmaxuse</span> <span class="o">=</span> <span class="n">absval</span>

        <span class="c1"># Check that lower bound is valid for logarithmic plots</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">vminuse</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">lin</span><span class="o">==</span><span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">symlog</span><span class="o">==</span><span class="kc">None</span><span class="p">):</span>
            <span class="c1"># Drop negative and zero values</span>
            <span class="n">vminuse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_less_equal</span><span class="p">(</span><span class="n">color_data</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>

        <span class="c1"># Special case of very small vminuse values</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">vmin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">vmax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">vminuse</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">vminuse</span> <span class="o">&lt;</span> <span class="n">vmaxuse</span><span class="o">*</span><span class="mf">1.e-5</span><span class="p">):</span>
            <span class="n">vminuse</span> <span class="o">=</span> <span class="n">vmaxuse</span><span class="o">*</span><span class="mf">1e-5</span>
            <span class="k">if</span> <span class="n">lin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">vminuse</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># If symlog scaling is set:</span>
        <span class="k">if</span> <span class="n">symlog</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">symlog</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">linthresh</span> <span class="o">=</span> <span class="n">symlog</span> 
            <span class="k">else</span><span class="p">:</span>
                <span class="n">linthresh</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">vminuse</span><span class="p">),</span><span class="nb">abs</span><span class="p">(</span><span class="n">vmaxuse</span><span class="p">))</span><span class="o">*</span><span class="mf">1.e-2</span>

        <span class="c1"># Lin or log colour scaling, defaults to log</span>
        <span class="k">if</span> <span class="n">lin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Special SymLogNorm case</span>
            <span class="k">if</span> <span class="n">symlog</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">Version</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">Version</span><span class="p">(</span><span class="s2">&quot;3.2.0&quot;</span><span class="p">):</span>
                    <span class="n">norm</span> <span class="o">=</span> <span class="n">SymLogNorm</span><span class="p">(</span><span class="n">linthresh</span><span class="o">=</span><span class="n">linthresh</span><span class="p">,</span> <span class="n">linscale</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vminuse</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmaxuse</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;colormap SymLogNorm uses base-e but ticks are calculated with base-10.&quot;</span><span class="p">)</span>
                    <span class="c1">#TODO: copy over matplotlib 3.3.0 implementation of SymLogNorm into analysator</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">norm</span> <span class="o">=</span> <span class="n">SymLogNorm</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">linthresh</span><span class="o">=</span><span class="n">linthresh</span><span class="p">,</span> <span class="n">linscale</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vminuse</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmaxuse</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">maxlog</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">vmaxuse</span><span class="p">)))</span>
                <span class="n">minlog</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="o">-</span><span class="n">vminuse</span><span class="p">)))</span>
                <span class="n">logthresh</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">linthresh</span><span class="p">)))</span>
                <span class="n">logstep</span><span class="o">=</span><span class="mi">1</span>
                <span class="n">ticks</span><span class="o">=</span><span class="p">([</span><span class="o">-</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">logthresh</span><span class="p">,</span> <span class="n">minlog</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">logstep</span><span class="p">)][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="o">+</span><span class="p">[</span><span class="mf">0.0</span><span class="p">]</span>
                        <span class="o">+</span><span class="p">[(</span><span class="mi">10</span><span class="o">**</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">logthresh</span><span class="p">,</span> <span class="n">maxlog</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">logstep</span><span class="p">)]</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Logarithmic plot</span>
                <span class="n">norm</span> <span class="o">=</span> <span class="n">LogNorm</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">vminuse</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="n">vmaxuse</span><span class="p">)</span>
                <span class="n">ticks</span> <span class="o">=</span> <span class="n">LogLocator</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">subs</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span> <span class="c1"># where to show labels</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Linear</span>
            <span class="n">levels</span> <span class="o">=</span> <span class="n">MaxNLocator</span><span class="p">(</span><span class="n">nbins</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">tick_values</span><span class="p">(</span><span class="n">vminuse</span><span class="p">,</span><span class="n">vmaxuse</span><span class="p">)</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">BoundaryNorm</span><span class="p">(</span><span class="n">levels</span><span class="p">,</span> <span class="n">ncolors</span><span class="o">=</span><span class="n">cmapuse</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ticks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">vminuse</span><span class="p">,</span><span class="n">vmaxuse</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="n">lin</span><span class="p">)</span>            

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Selected color range: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">vminuse</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; to &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">vmaxuse</span><span class="p">))</span>

    <span class="c1"># Create 300 dpi image of suitable size</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mf">4.5</span><span class="p">,</span><span class="mf">4.5</span><span class="p">],</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
    <span class="c1">#ax1 = fig.gca(projection=&#39;3d&#39;)</span>
    <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>

    <span class="c1"># If requested high res image</span>
    <span class="k">if</span> <span class="n">highres</span><span class="p">:</span>
        <span class="n">highresscale</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="p">((</span><span class="nb">type</span><span class="p">(</span><span class="n">highres</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">highres</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)):</span>
            <span class="n">highresscale</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">highres</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">highresscale</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">):</span>
                <span class="n">highresscale</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="c1"># figsize= [x * highresscale for x in figsize] # figsize not defined, neither used in this function</span>
        <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="o">*</span><span class="n">highresscale</span>
        <span class="n">fontsize2</span><span class="o">=</span><span class="n">fontsize2</span><span class="o">*</span><span class="n">highresscale</span>
        <span class="n">fontsize3</span><span class="o">=</span><span class="n">fontsize3</span><span class="o">*</span><span class="n">highresscale</span>
        <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="o">*</span><span class="n">highresscale</span>
        <span class="n">thick</span><span class="o">=</span><span class="n">thick</span><span class="o">*</span><span class="n">highresscale</span>
        <span class="c1"># streamlinethick=streamlinethick*highresscale # streamlinethick not defined, neither used in this function</span>
        <span class="c1"># vectorsize=vectorsize*highresscale # vectorsize not defined, neither used in this function</span>

    <span class="c1"># Generate virtual bounding box to get equal aspect</span>
    <span class="n">maxrange</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">boxcoords</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">boxcoords</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">-</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">4</span><span class="p">]])</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">/</span> <span class="mf">2.0</span>
    <span class="n">midvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">boxcoords</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">boxcoords</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">+</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">4</span><span class="p">]])</span> <span class="o">/</span> <span class="mf">2.0</span>


    <span class="c1"># Three options:</span>
    <span class="c1"># 2.9D ecliptic, 2.9D polar, or 3D</span>
    <span class="k">if</span> <span class="n">ysize</span> <span class="o">&lt;</span> <span class="mf">0.2</span><span class="o">*</span><span class="n">xsize</span><span class="p">:</span> <span class="c1"># 2.9D polar, perform rotation</span>
        <span class="n">generatedsurface</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">plot_trisurf</span><span class="p">(</span><span class="n">verts</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span> <span class="n">verts</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">verts</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">triangles</span><span class="o">=</span><span class="n">faces</span><span class="p">,</span>
                                            <span class="n">cmap</span><span class="o">=</span><span class="n">cmapuse</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vminuse</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmaxuse</span><span class="p">,</span> 
                                            <span class="n">lw</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">shade</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">antialiased</span><span class="o">=</span><span class="n">transparent</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;z [&quot;</span><span class="o">+</span><span class="n">unitstr</span><span class="o">+</span><span class="s2">&quot;]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize3</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;x [&quot;</span><span class="o">+</span><span class="n">unitstr</span><span class="o">+</span><span class="s2">&quot;]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize3</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s2">&quot;y [&quot;</span><span class="o">+</span><span class="n">unitstr</span><span class="o">+</span><span class="s2">&quot;]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize3</span><span class="p">)</span>


        <span class="c1"># Set camera angle</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">view_init</span><span class="p">(</span><span class="n">elev</span><span class="o">=</span><span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">azim</span><span class="o">=</span><span class="n">angle</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1"># Set virtual bounding box</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">midvals</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">maxrange</span><span class="p">,</span> <span class="n">midvals</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">maxrange</span><span class="p">])</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="n">midvals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">maxrange</span><span class="p">,</span> <span class="n">midvals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">maxrange</span><span class="p">])</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_zlim</span><span class="p">([</span><span class="n">midvals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">maxrange</span><span class="p">,</span> <span class="n">midvals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">maxrange</span><span class="p">])</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="n">fontsize3</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="n">thick</span><span class="p">,</span><span class="n">length</span><span class="o">=</span><span class="mi">3</span><span class="o">*</span><span class="n">thick</span><span class="p">)</span>
        
    <span class="k">else</span><span class="p">:</span> <span class="c1"># 3D or 2.9D ecliptic, leave as is</span>
        <span class="n">generatedsurface</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">plot_trisurf</span><span class="p">(</span><span class="n">verts</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">verts</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">verts</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span> <span class="n">triangles</span><span class="o">=</span><span class="n">faces</span><span class="p">,</span>
                                            <span class="n">cmap</span><span class="o">=</span><span class="n">cmapuse</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vminuse</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmaxuse</span><span class="p">,</span> 
                                            <span class="n">lw</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">shade</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">antialiased</span><span class="o">=</span><span class="n">transparent</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;x [&quot;</span><span class="o">+</span><span class="n">unitstr</span><span class="o">+</span><span class="s2">&quot;]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize3</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;y [&quot;</span><span class="o">+</span><span class="n">unitstr</span><span class="o">+</span><span class="s2">&quot;]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize3</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s2">&quot;z [&quot;</span><span class="o">+</span><span class="n">unitstr</span><span class="o">+</span><span class="s2">&quot;]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize3</span><span class="p">)</span>
        <span class="c1"># Set camera angle</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">view_init</span><span class="p">(</span><span class="n">elev</span><span class="o">=</span><span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">azim</span><span class="o">=</span><span class="n">angle</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1"># Set virtual bounding box</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">midvals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">maxrange</span><span class="p">,</span> <span class="n">midvals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">maxrange</span><span class="p">])</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="n">midvals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">maxrange</span><span class="p">,</span> <span class="n">midvals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">maxrange</span><span class="p">])</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_zlim</span><span class="p">([</span><span class="n">midvals</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">maxrange</span><span class="p">,</span> <span class="n">midvals</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">maxrange</span><span class="p">])</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="n">fontsize3</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="n">thick</span><span class="p">,</span><span class="n">length</span><span class="o">=</span><span class="mi">3</span><span class="o">*</span><span class="n">thick</span><span class="p">)</span>


    <span class="c1"># Setting per-triangle colours for plot_trisurf needs to be done</span>
    <span class="c1"># as a separate set_array call.</span>
    <span class="k">if</span> <span class="n">color_var</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Find face-averaged colors</span>
        <span class="c1"># (simply setting the array to color_data failed for some reason)</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">color_data</span><span class="p">[</span><span class="n">faces</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">generatedsurface</span><span class="o">.</span><span class="n">set_array</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span>
        
    <span class="c1"># Title and plot limits</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_title</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">plot_title</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize2</span><span class="p">,</span><span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>


    <span class="c1"># ax1.set_aspect(&#39;equal&#39;) #&lt;&lt;&lt;--- this does not work for 3D plots!</span>

    <span class="c1"># for axis in [&#39;top&#39;,&#39;bottom&#39;,&#39;left&#39;,&#39;right&#39;]:</span>
    <span class="c1">#     ax1.spines[axis].set_linewidth(thick)</span>
    <span class="c1"># ax1.xaxis.set_tick_params(width=thick,length=3)</span>
    <span class="c1"># ax1.yaxis.set_tick_params(width=thick,length=3)</span>
    <span class="c1"># #ax1.xaxis.set_tick_params(which=&#39;minor&#39;,width=3,length=5)</span>
    <span class="c1"># #ax1.yaxis.set_tick_params(which=&#39;minor&#39;,width=3,length=5)    </span>


    <span class="k">if</span> <span class="ow">not</span> <span class="n">nocb</span><span class="p">:</span>
        <span class="c1"># First draw colorbar</span>
        <span class="k">if</span> <span class="n">usesci</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>        
            <span class="n">cb</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">generatedsurface</span><span class="p">,</span><span class="n">ticks</span><span class="o">=</span><span class="n">ticks</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">mtick</span><span class="o">.</span><span class="n">FuncFormatter</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">cbfmt</span><span class="p">),</span> <span class="n">drawedges</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.023</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cb</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">generatedsurface</span><span class="p">,</span><span class="n">ticks</span><span class="o">=</span><span class="n">ticks</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="n">mtick</span><span class="o">.</span><span class="n">FuncFormatter</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">cbfmtsci</span><span class="p">),</span><span class="n">drawedges</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cb_title_use</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">cb_title_use</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">mathmode</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bfstring</span><span class="p">(</span><span class="n">cb_title_use</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">lin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">cb_linear</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">cb_linear</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Ensure minor tick marks are off</span>
        <span class="k">if</span> <span class="n">lin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cb</span><span class="o">.</span><span class="n">minorticks_off</span><span class="p">()</span>

        <span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="n">fontsize3</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="n">thick</span><span class="p">,</span><span class="n">length</span><span class="o">=</span><span class="mi">3</span><span class="o">*</span><span class="n">thick</span><span class="p">)</span>
        <span class="n">cb</span><span class="o">.</span><span class="n">outline</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="n">thick</span><span class="p">)</span>
        <span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">cb_title_use</span><span class="p">)</span>
        <span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_horizontalalignment</span><span class="p">(</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>

        <span class="c1"># Adjust precision for colorbar ticks</span>
        <span class="n">thesetickvalues</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="n">locator</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">thesetickvalues</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">precision_b</span><span class="o">=</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mintickinterval</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">thesetickvalues</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">thesetickvalues</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="c1"># find smallest interval</span>
            <span class="k">for</span> <span class="n">ticki</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">thesetickvalues</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">mintickinterval</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">mintickinterval</span><span class="p">,</span><span class="nb">abs</span><span class="p">(</span><span class="n">thesetickvalues</span><span class="p">[</span><span class="n">ticki</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">thesetickvalues</span><span class="p">[</span><span class="n">ticki</span><span class="p">]))</span>
            <span class="n">precision_a</span><span class="p">,</span> <span class="n">precision_b</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.1e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mintickinterval</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;e&#39;</span><span class="p">)</span>
            <span class="c1"># e.g. 9.0e-1 means we need precision 1</span>
            <span class="c1"># e.g. 1.33e-1 means we need precision 3?</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">decimalprecision_cblin</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">precision_b</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span> <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">decimalprecision_cblin</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="nb">abs</span><span class="p">(</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">precision_b</span><span class="p">)))</span>
        <span class="n">cb</span><span class="o">.</span><span class="n">update_ticks</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">symlog</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">vminuse</span><span class="o">/</span><span class="n">vmaxuse</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>
            <span class="n">cbt</span><span class="o">=</span><span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">get_ticklabels</span><span class="p">()</span>
            <span class="p">(</span><span class="n">cbtx</span><span class="p">,</span><span class="n">cbty</span><span class="p">)</span> <span class="o">=</span> <span class="n">cbt</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">cbt</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span> <span class="c1"># just below zero</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="mf">0.5</span><span class="o">-</span><span class="n">cbty</span><span class="p">)</span><span class="o">/</span><span class="n">scale</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">:</span>
                <span class="n">cbt</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">cbt</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_va</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">)</span>
            <span class="p">(</span><span class="n">cbtx</span><span class="p">,</span><span class="n">cbty</span><span class="p">)</span> <span class="o">=</span> <span class="n">cbt</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">cbt</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span> <span class="c1"># just above zero</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="mf">0.5</span><span class="o">-</span><span class="n">cbty</span><span class="p">)</span><span class="o">/</span><span class="n">scale</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">:</span>
                <span class="n">cbt</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">cbt</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_va</span><span class="p">(</span><span class="s2">&quot;bottom&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cbt</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">7</span><span class="p">:</span> <span class="c1"># If we have at least seven ticks, may want to adjust next ones as well</span>
                <span class="p">(</span><span class="n">cbtx</span><span class="p">,</span><span class="n">cbty</span><span class="p">)</span> <span class="o">=</span> <span class="n">cbt</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">cbt</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span> <span class="c1"># second below zero</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="mf">0.5</span><span class="o">-</span><span class="n">cbty</span><span class="p">)</span><span class="o">/</span><span class="n">scale</span> <span class="o">&lt;</span> <span class="mf">0.15</span><span class="p">:</span>
                    <span class="n">cbt</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">cbt</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_va</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">)</span>
                <span class="p">(</span><span class="n">cbtx</span><span class="p">,</span><span class="n">cbty</span><span class="p">)</span> <span class="o">=</span> <span class="n">cbt</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">cbt</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span> <span class="c1"># second above zero</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="mf">0.5</span><span class="o">-</span><span class="n">cbty</span><span class="p">)</span><span class="o">/</span><span class="n">scale</span> <span class="o">&lt;</span> <span class="mf">0.15</span><span class="p">:</span>
                    <span class="n">cbt</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">cbt</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_va</span><span class="p">(</span><span class="s2">&quot;bottom&quot;</span><span class="p">)</span>

        <span class="c1"># if too many subticks in logarithmic colorbar:</span>
        <span class="k">if</span> <span class="n">lin</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">symlog</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nlabels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">get_ticklabels</span><span class="p">())</span> <span class="c1">#/ ratio</span>
            <span class="n">valids</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="s1">&#39;2&#39;</span><span class="p">,</span><span class="s1">&#39;3&#39;</span><span class="p">,</span><span class="s1">&#39;4&#39;</span><span class="p">,</span><span class="s1">&#39;5&#39;</span><span class="p">,</span><span class="s1">&#39;6&#39;</span><span class="p">,</span><span class="s1">&#39;7&#39;</span><span class="p">,</span><span class="s1">&#39;8&#39;</span><span class="p">,</span><span class="s1">&#39;9&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">nlabels</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">valids</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="s1">&#39;2&#39;</span><span class="p">,</span><span class="s1">&#39;3&#39;</span><span class="p">,</span><span class="s1">&#39;4&#39;</span><span class="p">,</span><span class="s1">&#39;5&#39;</span><span class="p">,</span><span class="s1">&#39;6&#39;</span><span class="p">,</span><span class="s1">&#39;8&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">nlabels</span> <span class="o">&gt;</span> <span class="mi">19</span><span class="p">:</span>
                <span class="n">valids</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="s1">&#39;2&#39;</span><span class="p">,</span><span class="s1">&#39;5&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">nlabels</span> <span class="o">&gt;</span> <span class="mi">28</span><span class="p">:</span>
                <span class="n">valids</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">]</span>
            <span class="c1"># for label in cb.ax.yaxis.get_ticklabels()[::labelincrement]:</span>
            <span class="k">for</span> <span class="n">labi</span><span class="p">,</span><span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">get_ticklabels</span><span class="p">()):</span>
                <span class="n">labeltext</span> <span class="o">=</span> <span class="n">label</span><span class="o">.</span><span class="n">get_text</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;$&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\mbox{\textbf{--}}&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">labeltext</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">firstdigit</span> <span class="o">=</span> <span class="n">labeltext</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">firstdigit</span> <span class="ow">in</span> <span class="n">valids</span><span class="p">:</span> 
                    <span class="n">label</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>



    <span class="c1"># Add Vlasiator watermark</span>
    <span class="k">if</span> <span class="n">wmark</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>        
        <span class="n">wm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">get_sample_data</span><span class="p">(</span><span class="n">watermarkimage</span><span class="p">))</span>
        <span class="n">newax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.90</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.08</span><span class="p">],</span> <span class="n">anchor</span><span class="o">=</span><span class="s1">&#39;NW&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">newax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">wm</span><span class="p">)</span>
        <span class="n">newax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">savefig_pad</span><span class="o">=</span><span class="mf">0.1</span> <span class="c1"># The default is 0.1</span>
    <span class="n">bbox_inches</span><span class="o">=</span><span class="kc">None</span>


    <span class="c1"># Save output or draw on-screen</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">draw</span><span class="p">:</span>
        <span class="c1"># Note: generated title can cause strange PNG header problems</span>
        <span class="c1"># in rare cases. This problem is under investigation, but is related to the exact generated</span>
        <span class="c1"># title string. This try-catch attempts to simplify the time string until output succedes.</span>
        <span class="n">outputfile_default</span><span class="o">=</span><span class="n">run</span><span class="o">+</span><span class="s2">&quot;_isosurface_&quot;</span><span class="o">+</span><span class="n">surf_varstr</span><span class="o">+</span><span class="n">surf_opstr</span><span class="o">+</span><span class="s2">&quot;-&quot;</span><span class="o">+</span><span class="n">color_varstr</span><span class="o">+</span><span class="n">color_opstr</span><span class="o">+</span><span class="n">stepstr</span><span class="o">+</span><span class="s2">&quot;.png&quot;</span>
        <span class="n">savefigname</span><span class="o">=</span><span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">output_path</span><span class="p">(</span><span class="n">outputdir</span><span class="o">=</span><span class="n">outputdir</span><span class="p">,</span> <span class="n">outputfile</span><span class="o">=</span><span class="n">outputfile</span><span class="p">,</span> <span class="n">outputfile_default</span><span class="o">=</span><span class="n">outputfile_default</span><span class="p">,</span><span class="n">nooverwrite</span><span class="o">=</span><span class="n">nooverwrite</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savefigname</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="n">bbox_inches</span><span class="p">,</span> <span class="n">pad_inches</span><span class="o">=</span><span class="n">savefig_pad</span><span class="p">)</span>
            <span class="n">savechange</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">savechange</span><span class="o">=</span><span class="mi">1</span>
            <span class="n">plot_title</span> <span class="o">=</span> <span class="s2">&quot;t=&quot;</span><span class="o">+</span><span class="s1">&#39;</span><span class="si">{:4.1f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">timeval</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; s &#39;</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">plot_title</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize2</span><span class="p">,</span><span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>                
            <span class="k">try</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savefigname</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="n">bbox_inches</span><span class="p">,</span> <span class="n">pad_inches</span><span class="o">=</span><span class="n">savefig_pad</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">plot_title</span> <span class="o">=</span> <span class="s2">&quot;t=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">timeval</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; s   &#39;</span>
                <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">plot_title</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize2</span><span class="p">,</span><span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>                
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savefigname</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="n">bbox_inches</span><span class="p">,</span> <span class="n">pad_inches</span><span class="o">=</span><span class="n">savefig_pad</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">plot_title</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">plot_title</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize2</span><span class="p">,</span><span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>                
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savefigname</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="n">bbox_inches</span><span class="p">,</span> <span class="n">pad_inches</span><span class="o">=</span><span class="n">savefig_pad</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Error:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span> <span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> 
                                     <span class="s2">&quot;Error with attempting to save figure, sometimes due to matplotlib LaTeX integration.</span><span class="se">\n</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                                    Usually removing the title should work, but this time even that failed.&quot;</span><span class="p">)</span>                        

        <span class="k">if</span> <span class="n">savechange</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Due to rendering error, replaced image title with &quot;</span><span class="o">+</span><span class="n">plot_title</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">savechange</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">savefigname</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>






<div class="viewcode-block" id="plot_neutral_sheet">
<a class="viewcode-back" href="../../../../plot/#analysator.plot.plot_neutral_sheet">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_neutral_sheet</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">vlsvobj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">filedir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">outputdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outputfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">nooverwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">var</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">operator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cbtitle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">usesci</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                  <span class="n">symlog</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">boxm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">boxre</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">colormap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">nocb</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">internalcb</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">wmark</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">wmarkb</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">axisunit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">thick</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                  <span class="n">tickinterval</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="c1"># Fairly certain this is a valid null value</span>
                  <span class="n">noborder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">noxlabels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">noylabels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">vmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">external</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">expression</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">diff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">vscale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                  <span class="n">absolute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">symmetric</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">pass_vars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pass_times</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pass_full</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">nomask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">Earth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">highres</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">vectors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vectordensity</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">vectorcolormap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">vectorsize</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                  <span class="n">streamlines</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">streamlinedensity</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">streamlinecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">streamlinethick</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                  <span class="n">axes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cbaxes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">cb_horizontal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">useimshow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">imshowinterp</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">folding_alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">z_extent</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span> <span class="n">sheetlayer</span><span class="o">=</span><span class="s1">&#39;above&#39;</span>
                  <span class="p">):</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Plots a coloured plot along the neutral sheet with axes and a colour bar.</span>

<span class="sd">        :kwarg filename:    path to .vlsv file to use for input. Assumes a bulk file.</span>
<span class="sd">        :kwarg vlsvobj:     Optionally provide a python vlsvfile object instead</span>
<span class="sd">        :kwarg filedir:     Optionally provide directory where files are located and use step for bulk file name</span>
<span class="sd">        :kwarg step:        output step index, used for constructing output (and possibly input) filename</span>
<span class="sd">        :kwarg run:         run identifier, used for constructing output filename</span>
<span class="sd">        :kwarg outputdir:   path to directory where output files are created (default: $HOME/Plots/ or override with PTOUTPUTDIR)</span>
<span class="sd">                            If directory does not exist, it will be created. If the string does not end in a</span>
<span class="sd">                            forward slash, the final part will be used as a prefix for the files.</span>
<span class="sd">        :kwarg outputfile:  Singular output file name</span>

<span class="sd">        :kwarg nooverwrite: Set to only perform actions if the target output file does not yet exist                    </span>

<span class="sd">        :kwarg var:         variable to plot, e.g. rho, RhoBackstream, beta, Temperature, MA, Mms, va, vms,</span>
<span class="sd">                            E, B, v, V or others. Accepts any variable known by analysator.</span>
<span class="sd">                            Per-population variables are simply given as &quot;proton/rho&quot; etc</span>
<span class="sd">        :kwarg operator:    Operator to apply to variable: None, x, y, or z. Vector variables return either</span>
<span class="sd">                            the queried component, or otherwise the magnitude. </span>
<span class="sd">        :kwarg op:          duplicate of operator</span>
<span class="sd">            </span>
<span class="sd">        :kwarg boxm:        zoom box extents [x0,x1,y0,y1] in metres (default and truncate to: whole simulation box)</span>
<span class="sd">        :kwarg boxre:       zoom box extents [x0,x1,y0,y1] in Earth radii (default and truncate to: whole simulation box)</span>
<span class="sd">        :kwarg colormap:    colour scale for plot, use e.g. hot_desaturated, jet, viridis, plasma, inferno,</span>
<span class="sd">                            magma, parula, nipy_spectral, RdBu, bwr</span>
<span class="sd">        :kwarg title:       string to use as plot title instead of time.</span>
<span class="sd">                            Special case: Set to &quot;msec&quot; to plot time with millisecond accuracy or &quot;musec&quot;</span>
<span class="sd">                            for microsecond accuracy. &quot;sec&quot; is integer second accuracy.</span>
<span class="sd">        :kwarg cbtitle:     string to use as colorbar title instead of map name</span>
<span class="sd">        :kwarg axisunit:    Plot axes using 10^{axisunit} m (default: Earth radius R_E)</span>
<span class="sd">        :kwarg tickinterval: Interval at which to have ticks on axes (not colorbar)</span>

<span class="sd">        :kwarg usesci:      Use scientific notation for colorbar ticks? (default: True)</span>
<span class="sd">        :kwarg vmin,vmax:   min and max values for colour scale and colour bar. If no values are given,</span>
<span class="sd">                            min and max values for whole plot (non-zero rho regions only) are used.</span>
<span class="sd">        :kwarg symmetric:   Set the absolute value of vmin and vmax to the greater of the two</span>
<span class="sd">        :kwarg lin:         Flag for using linear colour scaling instead of log</span>
<span class="sd">        :kwarg symlog:      Use logarithmic scaling, but linear when abs(value) is below the value given to symlog.</span>
<span class="sd">                            Allows symmetric quasi-logarithmic plots of e.g. transverse field components.</span>
<span class="sd">                            A given of 0 translates to a threshold of max(abs(vmin),abs(vmax)) * 1.e-2, but this can</span>
<span class="sd">                            result in the innermost tick marks overlapping. In this case, using a larger value for </span>
<span class="sd">                            symlog is suggested.</span>
<span class="sd">        :kwarg wmark:       If set to non-zero, will plot a Vlasiator watermark in the top left corner. If set to a text</span>
<span class="sd">                            string, tries to use that as the location, e.g. &quot;NW&quot;,&quot;NE&quot;,&quot;SW&quot;,&quot;SW&quot;</span>
<span class="sd">        :kwarg wmarkb:      As for wmark, but uses an all-black Vlasiator logo.</span>
<span class="sd">        :kwarg Earth:       If set, draws an earth at (0,0)</span>
<span class="sd">        :kwarg highres:     Creates the image in high resolution, scaled up by this value (suitable for print). </span>


<span class="sd">        :kwarg draw:        Set to nonzero in order to draw image on-screen instead of saving to file (requires x-windowing)</span>

<span class="sd">        :kwarg noborder:    Plot figure edge-to-edge without borders (default off)</span>
<span class="sd">        :kwarg noxlabels:   Suppress x-axis labels and title</span>
<span class="sd">        :kwarg noylabels:   Suppress y-axis labels and title</span>
<span class="sd">        :kwarg scale:       Scale text size (default=1.0)</span>
<span class="sd">        :kwarg thick:       line and axis thickness, default=1.0</span>
<span class="sd">        :kwarg nocb:        Set to suppress drawing of colourbar</span>
<span class="sd">        :kwarg internalcb:  Set to draw colorbar inside plot instead of outside. If set to a text</span>
<span class="sd">                            string, tries to use that as the location, e.g. &quot;NW&quot;,&quot;NE&quot;,&quot;SW&quot;,&quot;SW&quot;</span>

<span class="sd">        :kwarg external:    Optional function to use for external plotting of e.g. contours. The function</span>
<span class="sd">                            receives the following arguments: ax, XmeshXY,YmeshXY, pass_maps</span>
<span class="sd">                            If the function accepts a fifth variable, if set to true, it is expected to </span>
<span class="sd">                            return a list of required variables for constructing the pass_maps dictionary.</span>
<span class="sd">                            **See note under** ``expression`` **about the dictionaries of arrays.**</span>
<span class="sd">        :kwarg expression:  Optional function which calculates a custom expression to plot. The function</span>
<span class="sd">                            receives the same dictionary of numpy arrays as external, as an argument pass_maps,</span>
<span class="sd">                            the contents of which are maps of variables. Each is either of size [ysize,xsize]</span>
<span class="sd">                            or for multi-dimensional variables (vectors, tensors) it&#39;s [ysize,xsize,dim].</span>
<span class="sd">                            If the function accepts a second variable, if set to true, it is expected to </span>
<span class="sd">                            return a list of required variables for pass_maps.</span>
<span class="sd">                            **Important note:** the dictionaries of arrays passed to external and expression are of shape [ysize,xzize], so</span>
<span class="sd">                            for some analysis transposing them is necessary. For pre-existing functions to use and to base new functions</span>
<span class="sd">                            on, see the plot_helpers.py file.</span>

<span class="sd">        :kwarg vscale:      Scale all values with this before plotting. Useful for going from e.g. m^-3 to cm^-3</span>
<span class="sd">                            or from tesla to nanotesla. Guesses correct units for colourbar for some known</span>
<span class="sd">                            variables. Set to None to seek for a default scaling.</span>
<span class="sd">        :kwarg absolute:    Plot the absolute of the evaluated variable</span>

<span class="sd">        :kwarg pass_vars:   Optional list of map names to pass to the external/expression functions </span>
<span class="sd">                            as a dictionary of numpy arrays. Each is either of size [ysize,xsize] or </span>
<span class="sd">                            for multi-dimensional variables (vectors, tensors) it&#39;s [ysize,xsize,dim].</span>
<span class="sd">        :kwarg pass_times:  Integer, how many timesteps in each direction should be passed to external/expression</span>
<span class="sd">                            functions in pass_vars (e.g. pass_times=1 passes the values of three timesteps). If</span>
<span class="sd">                            pass_times has two values, the first is the extent before, the second after.</span>
<span class="sd">                            (e.g. pass_times=[2,1] passes the values of two preceding and one following timesteps</span>
<span class="sd">                            for a total of four timesteps)</span>
<span class="sd">                            This causes pass_vars to become a list of timesteps, with each timestep containing</span>
<span class="sd">                            a dictionary of numpy arrays as for regular pass_vars. An additional dictionary entry is</span>
<span class="sd">                            added as &#39;dstep&#39; which gives the timestep offset from the master frame.</span>
<span class="sd">                            Does not work if working from a vlsv-object.</span>
<span class="sd">        :kwarg pass_full:   Set to anything but None in order to pass the full arrays instead of a zoomed-in section</span>

<span class="sd">        :kwarg diff:        Instead of a regular plot, plot the difference between the selected plot type for</span>
<span class="sd">                            the regular source file and the file given by this keyword. This overides external</span>
<span class="sd">                            and expression keywords, as well as related pass_vars, pass_times, and pass_full.</span>

<span class="sd">        :kwarg z_extent:    Search bracket for the neutral sheet in axisunit units</span>
<span class="sd">        :kwarg folding_alpha: If non-zero, plots transparent dots over the regions where the sheet has multiple separate z-values. A value of 1.0 is opaque, a value of 0.0 is transparent.</span>
<span class="sd">        :kwarg sheetlayer:  If set to &#39;above&#39;, plots the topmost layer of the neutral sheet in case of folding. If set to anything else, </span>
<span class="sd">                            the downmost layer is plotted.</span>
<span class="sd">        :kwarg nomask:      Do not mask plotting based on proton density</span>

<span class="sd">        :kwarg vectors:     Set to a vector variable to overplot (unit length vectors, color displays variable magnitude)</span>
<span class="sd">        :kwarg vectordensity: Aim for how many vectors to show in plot window (default 100)</span>
<span class="sd">        :kwarg vectorcolormap: Colormap to use for overplotted vectors (default: gray)</span>
<span class="sd">        :kwarg vectorsize:  Scaling of vector sizes</span>

<span class="sd">        :kwarg streamlines: Set to a vector variable to overplot as streamlines</span>
<span class="sd">        :kwarg streamlinedensity: Set streamline density (default 1)</span>
<span class="sd">        :kwarg streamlinecolor: Set streamline color (default white)</span>
<span class="sd">        :kwarg streamlinethick: Set streamline thickness</span>

<span class="sd">        :kwarg axes:        Provide the routine a set of axes to draw within instead of generating a new image.</span>
<span class="sd">                            It is recommended to either also provide cbaxes or activate nocb, unless one wants a colorbar</span>
<span class="sd">                            to be automatically added next to the panel (but this may affect the overall layout)</span>
<span class="sd">                            Note that the aspect ratio of the colormap is made equal in any case, hence the axes</span>
<span class="sd">                            proportions may change if the box and axes size are not designed to match by the user</span>
<span class="sd">        :kwarg cbaxes:      Provide the routine a set of axes for the colourbar.</span>
<span class="sd">        :kwarg cb_horizontal: Set to draw the colorbar horizontally instead of vertically (default: False) requires cbaxes to be set.</span>
<span class="sd">        :kwarg normal:      Direction of the normal of the 2D cut through (&#39;x&#39;, &#39;y&#39;, or &#39;z&#39; or a vector)</span>
<span class="sd">        :kwarg cutpoint:    Coordinate (in normal direction) through which the cut must pass [m]</span>
<span class="sd">        :kwarg cutpointre:  Coordinate (in normal direction) through which the cut must pass [rE]</span>
<span class="sd">        :kwarg useimshow:   Use imshow for raster background instead (default: False)</span>
<span class="sd">        :kwarg imshowinterp: Use this matplotlib interpolation for imshow (default: &#39;none&#39;)</span>


<span class="sd">        :returns:           Outputs an image to a file or to the screen.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># Verify the location of this watermark image</span>
    <span class="n">watermarkimage</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;logo_color.png&#39;</span><span class="p">)</span>
    <span class="n">watermarkimageblack</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;logo_black.png&#39;</span><span class="p">)</span>

    <span class="c1"># Switch None-keywords to empty lists (this way subsequent calls get correct empty default values</span>
    <span class="k">if</span> <span class="n">boxm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">boxm</span><span class="o">=</span><span class="p">[],</span>
    <span class="k">if</span> <span class="n">boxre</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">boxre</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">if</span> <span class="n">pass_vars</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pass_vars</span><span class="o">=</span><span class="p">[]</span>

    <span class="c1"># Change certain falsy values:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">lin</span> <span class="ow">and</span> <span class="n">lin</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">lin</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">lin</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">lin</span> <span class="o">=</span> <span class="mi">7</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">symlog</span> <span class="ow">and</span> <span class="n">symlog</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">symlog</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">symlog</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">symlog</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">filedir</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="n">filedir</span> <span class="o">=</span> <span class="s1">&#39;./&#39;</span>


    <span class="c1"># Input file or object</span>
    <span class="k">if</span> <span class="n">filename</span><span class="p">:</span>
        <span class="n">f</span><span class="o">=</span><span class="n">pt</span><span class="o">.</span><span class="n">vlsvfile</span><span class="o">.</span><span class="n">VlsvReader</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">filedir</span> <span class="ow">and</span> <span class="n">step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">filedir</span><span class="o">+</span><span class="s1">&#39;bulk*&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">step</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="s1">&#39;0&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.vlsv&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1">#filename = filedir+&#39;bulk.&#39;+str(step).rjust(7,&#39;0&#39;)+&#39;.vlsv&#39;</span>
        <span class="n">f</span><span class="o">=</span><span class="n">pt</span><span class="o">.</span><span class="n">vlsvfile</span><span class="o">.</span><span class="n">VlsvReader</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">vlsvobj</span><span class="p">:</span>
        <span class="n">f</span><span class="o">=</span><span class="n">vlsvobj</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Error, needs a .vlsv file name, python object, or directory and step&quot;</span><span class="p">)</span>

    
    <span class="k">if</span> <span class="n">operator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">op</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">operator</span><span class="o">=</span><span class="n">op</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">colormap</span><span class="p">:</span>
        <span class="c1"># Default values</span>
        <span class="n">colormap</span><span class="o">=</span><span class="s2">&quot;hot_desaturated&quot;</span>
        <span class="k">if</span> <span class="n">operator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">operator</span> <span class="ow">in</span> <span class="s1">&#39;xyz&#39;</span><span class="p">:</span>
            <span class="n">colormap</span><span class="o">=</span><span class="s2">&quot;bwr&quot;</span>
    
    <span class="n">cmapuse</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">colormap</span><span class="p">)</span>

    
    <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="o">*</span><span class="n">scale</span> <span class="c1"># Most text</span>
    <span class="n">fontsize2</span><span class="o">=</span><span class="mi">10</span><span class="o">*</span><span class="n">scale</span> <span class="c1"># Time title</span>
    <span class="n">fontsize3</span><span class="o">=</span><span class="mi">8</span><span class="o">*</span><span class="n">scale</span> <span class="c1"># Colour bar ticks and title</span>
    <span class="c1"># Small internal colorbar needs increased font size</span>
    <span class="k">if</span> <span class="n">internalcb</span><span class="p">:</span> 
        <span class="n">fontsize3</span><span class="o">=</span><span class="n">fontsize3</span><span class="o">*</span><span class="mi">2</span>

    <span class="c1"># Plot title with time</span>
    <span class="n">timeval</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">read_parameter</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>

    <span class="c1"># Plot title with time</span>
    <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">title</span><span class="o">==</span><span class="s2">&quot;msec&quot;</span> <span class="ow">or</span> <span class="n">title</span><span class="o">==</span><span class="s2">&quot;musec&quot;</span><span class="p">:</span>        
        <span class="k">if</span> <span class="n">timeval</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>    
            <span class="n">plot_title</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">timeformat</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{:4.1f}</span><span class="s1">&#39;</span>
            <span class="k">if</span> <span class="n">title</span><span class="o">==</span><span class="s2">&quot;sec&quot;</span><span class="p">:</span> <span class="n">timeformat</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{:4.0f}</span><span class="s1">&#39;</span>
            <span class="k">if</span> <span class="n">title</span><span class="o">==</span><span class="s2">&quot;msec&quot;</span><span class="p">:</span> <span class="n">timeformat</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{:4.3f}</span><span class="s1">&#39;</span>
            <span class="k">if</span> <span class="n">title</span><span class="o">==</span><span class="s2">&quot;musec&quot;</span><span class="p">:</span> <span class="n">timeformat</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{:4.6f}</span><span class="s1">&#39;</span>
            <span class="n">plot_title</span> <span class="o">=</span> <span class="s2">&quot;t=&quot;</span><span class="o">+</span><span class="n">timeformat</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">timeval</span><span class="p">)</span><span class="o">+</span><span class="sa">r</span><span class="s1">&#39;\,s&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plot_title</span> <span class="o">=</span> <span class="n">title</span>

    <span class="c1"># step, used for file name</span>
    <span class="k">if</span> <span class="n">step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">stepstr</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">step</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">filename</span><span class="p">:</span>
            <span class="n">stepstr</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">filename</span><span class="p">[</span><span class="o">-</span><span class="mi">12</span><span class="p">:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stepstr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="c1"># If run name isn&#39;t given, just put &quot;plot&quot; in the output file name</span>
    <span class="k">if</span> <span class="n">run</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">run</span><span class="o">=</span><span class="s1">&#39;plot&#39;</span>

    <span class="c1"># Verify validity of operator</span>
    <span class="n">operatorstr</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="n">operatorfilestr</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">operator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># .isdigit checks if the operator is an integer (for taking an element from a vector)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">operator</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
            <span class="n">operator</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">operator</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">operator</span> <span class="ow">in</span> <span class="s1">&#39;xyz&#39;</span> <span class="ow">and</span> <span class="n">operator</span> <span class="o">!=</span> <span class="s1">&#39;magnitude&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">operator</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Unknown operator &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">operator</span><span class="p">))</span>
            <span class="n">operator</span><span class="o">=</span><span class="kc">None</span>
            <span class="n">operatorstr</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">operator</span> <span class="ow">in</span> <span class="s1">&#39;xyz&#39;</span><span class="p">:</span>
            <span class="c1"># For components, always use linear scale, unless symlog is set</span>
            <span class="n">operatorstr</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">operator</span>
            <span class="n">operatorfilestr</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">operator</span>
            <span class="k">if</span> <span class="n">symlog</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">lin</span><span class="o">=</span><span class="mi">7</span>
        <span class="c1"># index a vector</span>
        <span class="k">if</span> <span class="n">operator</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="n">operator</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">operator</span><span class="p">)</span>
            <span class="n">operatorstr</span><span class="o">=</span><span class="s1">&#39;_{&#39;</span><span class="o">+</span><span class="n">operator</span><span class="o">+</span><span class="s1">&#39;}&#39;</span>
            <span class="n">operatorfilestr</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">operator</span>
        <span class="c1"># Note: operator magnitude gets operatorstr=&#39;&#39;</span>

    <span class="c1"># Output file name</span>
    <span class="k">if</span> <span class="n">expression</span><span class="p">:</span>
        <span class="n">varstr</span><span class="o">=</span><span class="n">expression</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">var</span><span class="p">:</span>
            <span class="c1"># If no expression or variable given, defaults to rhom</span>
            <span class="n">var</span><span class="o">=</span><span class="s1">&#39;vg_rhom&#39;</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">check_variable</span><span class="p">(</span><span class="s2">&quot;proton/vg_rho&quot;</span><span class="p">):</span> <span class="c1"># multipop v5</span>
                <span class="n">var</span> <span class="o">=</span> <span class="s1">&#39;proton/vg_rho&#39;</span>
            <span class="k">elif</span> <span class="n">f</span><span class="o">.</span><span class="n">check_variable</span><span class="p">(</span><span class="s2">&quot;moments&quot;</span><span class="p">):</span> <span class="c1"># restart</span>
                <span class="n">var</span> <span class="o">=</span> <span class="s1">&#39;vg_restart_rhom&#39;</span>
            <span class="k">elif</span> <span class="n">f</span><span class="o">.</span><span class="n">check_variable</span><span class="p">(</span><span class="s2">&quot;rho&quot;</span><span class="p">):</span> <span class="c1"># old pre-v5 data (no fsgrid or AMR)</span>
                <span class="n">var</span> <span class="o">=</span> <span class="s1">&#39;rho&#39;</span>
        <span class="n">varstr</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>

    <span class="c1"># Activate diff mode?</span>
    <span class="k">if</span> <span class="n">diff</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">expression</span> <span class="ow">or</span> <span class="n">external</span> <span class="ow">or</span> <span class="n">pass_vars</span> <span class="ow">or</span> <span class="n">pass_times</span> <span class="ow">or</span> <span class="n">pass_full</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;attempted to perform diff with one of the following active:</span><span class="se">\n</span><span class="s2"> expression or external or pass_vars or pass_times or pass_full. Exiting.&quot;</span><span class="p">)</span>

        <span class="n">expression</span><span class="o">=</span><span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">plot_helpers</span><span class="o">.</span><span class="n">expr_Diff</span>
        <span class="n">pass_vars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
        <span class="n">varstr</span><span class="o">=</span><span class="s2">&quot;DIFF_&quot;</span><span class="o">+</span><span class="n">var</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="n">pass_times</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># File output checks</span>


    <span class="n">Re</span> <span class="o">=</span> <span class="mf">6.371e+6</span> <span class="c1"># Earth radius in m</span>
    <span class="c1"># read in mesh size and cells in ordinary space</span>
    <span class="p">[</span><span class="n">xsize</span><span class="p">,</span> <span class="n">ysize</span><span class="p">,</span> <span class="n">zsize</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get_spatial_mesh_size</span><span class="p">()</span>
    <span class="n">xsize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">xsize</span><span class="p">)</span>
    <span class="n">ysize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ysize</span><span class="p">)</span>
    <span class="n">zsize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">zsize</span><span class="p">)</span>    
    <span class="p">[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">zmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">zmax</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get_spatial_mesh_extent</span><span class="p">()</span>
    <span class="n">cellsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmax</span><span class="o">-</span><span class="n">xmin</span><span class="p">)</span><span class="o">/</span><span class="n">xsize</span>
    <span class="n">cellids</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read_variable</span><span class="p">(</span><span class="s2">&quot;CellID&quot;</span><span class="p">)</span>

    <span class="c1"># Read the FSgrid mesh</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="p">[</span><span class="n">xsizefg</span><span class="p">,</span> <span class="n">ysizefg</span><span class="p">,</span> <span class="n">zsizefg</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get_fsgrid_mesh_size</span><span class="p">()</span>
        <span class="n">xsizefg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">xsizefg</span><span class="p">)</span>
        <span class="n">ysizefg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ysizefg</span><span class="p">)</span>
        <span class="n">zsizefg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">zsizefg</span><span class="p">)</span>
        <span class="p">[</span><span class="n">xminfg</span><span class="p">,</span> <span class="n">yminfg</span><span class="p">,</span> <span class="n">zminfg</span><span class="p">,</span> <span class="n">xmaxfg</span><span class="p">,</span> <span class="n">ymaxfg</span><span class="p">,</span> <span class="n">zmaxfg</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get_fsgrid_mesh_extent</span><span class="p">()</span>
        <span class="n">cellsizefg</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmaxfg</span><span class="o">-</span><span class="n">xminfg</span><span class="p">)</span><span class="o">/</span><span class="n">xsizefg</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">plot_helpers</span><span class="o">.</span><span class="n">CELLSIZE</span> <span class="o">=</span> <span class="n">cellsizefg</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">xsize</span><span class="o">!=</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">ysize</span><span class="o">!=</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">zsize</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Did not find fsgrid data, but found 3D DCCRG mesh. Attempting to adapt.&quot;</span><span class="p">)</span>
            <span class="p">[</span><span class="n">xsizefg</span><span class="p">,</span> <span class="n">ysizefg</span><span class="p">,</span> <span class="n">zsizefg</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">xsize</span> <span class="o">*</span> <span class="mi">2</span><span class="o">**</span><span class="n">f</span><span class="o">.</span><span class="n">get_max_refinement_level</span><span class="p">(),</span> <span class="n">ysize</span> <span class="o">*</span> <span class="mi">2</span><span class="o">**</span><span class="n">f</span><span class="o">.</span><span class="n">get_max_refinement_level</span><span class="p">(),</span> <span class="n">zsize</span> <span class="o">*</span> <span class="mi">2</span><span class="o">**</span><span class="n">f</span><span class="o">.</span><span class="n">get_max_refinement_level</span><span class="p">()]</span>
            <span class="p">[</span><span class="n">xminfg</span><span class="p">,</span> <span class="n">yminfg</span><span class="p">,</span> <span class="n">zminfg</span><span class="p">,</span> <span class="n">xmaxfg</span><span class="p">,</span> <span class="n">ymaxfg</span><span class="p">,</span> <span class="n">zmaxfg</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">zmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">zmax</span><span class="p">]</span>
            <span class="n">cellsizefg</span> <span class="o">=</span> <span class="n">cellsize</span>
            <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">plot_helpers</span><span class="o">.</span><span class="n">CELLSIZE</span> <span class="o">=</span> <span class="n">cellsize</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Found 2D DCCRG mesh without FSgrid data. Exiting.&quot;</span><span class="p">)</span>


    <span class="c1"># sort the cellid and the datamap list</span>
    <span class="n">indexids</span> <span class="o">=</span> <span class="n">cellids</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
    <span class="n">cellids</span> <span class="o">=</span> <span class="n">cellids</span><span class="p">[</span><span class="n">indexids</span><span class="p">]</span>

    <span class="c1"># find the highest refiment level</span>
    <span class="n">reflevel</span> <span class="o">=</span> <span class="n">ids3d</span><span class="o">.</span><span class="n">refinement_level</span><span class="p">(</span><span class="n">xsize</span><span class="p">,</span> <span class="n">ysize</span><span class="p">,</span> <span class="n">zsize</span><span class="p">,</span> <span class="n">cellids</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span> <span class="c1"># Check if Vlasov grid doesn&#39;t reach maximum (fsgrid) refinement</span>
        <span class="k">if</span> <span class="n">xsize</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="n">reflevel</span> <span class="o">+</span> <span class="n">i</span><span class="p">))</span> <span class="o">==</span> <span class="n">xsizefg</span><span class="p">:</span>
            <span class="n">reflevel</span> <span class="o">+=</span> <span class="n">i</span>
            <span class="k">break</span>

    <span class="c1"># Verify that FSgrid and spatial grid agree</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">xmin</span><span class="o">!=</span><span class="n">xminfg</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">xmax</span><span class="o">!=</span><span class="n">xmaxfg</span><span class="p">)</span> <span class="ow">or</span>
        <span class="p">(</span><span class="n">ymin</span><span class="o">!=</span><span class="n">yminfg</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">ymax</span><span class="o">!=</span><span class="n">ymaxfg</span><span class="p">)</span> <span class="ow">or</span>
        <span class="p">(</span><span class="n">zmin</span><span class="o">!=</span><span class="n">zminfg</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">zmax</span><span class="o">!=</span><span class="n">zmaxfg</span><span class="p">)</span> <span class="ow">or</span>
        <span class="p">(</span><span class="n">xsize</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">reflevel</span><span class="p">)</span> <span class="o">!=</span><span class="n">xsizefg</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">ysize</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">reflevel</span><span class="p">)</span> <span class="o">!=</span><span class="n">ysizefg</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">zsize</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">reflevel</span><span class="p">)</span> <span class="o">!=</span><span class="n">zsizefg</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;FSgrid and vlasov grid disagreement!&quot;</span><span class="p">)</span>

    
    <span class="c1"># Plotting grid in the XY plane</span>
    <span class="n">axislabels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span>
    <span class="n">simext</span><span class="o">=</span><span class="p">[</span><span class="n">xmin</span><span class="p">,</span><span class="n">xmax</span><span class="p">,</span><span class="n">ymin</span><span class="p">,</span><span class="n">ymax</span><span class="p">,</span><span class="n">zmin</span><span class="p">,</span><span class="n">zmax</span><span class="p">]</span>
    <span class="n">sizes</span><span class="o">=</span><span class="p">[</span><span class="n">xsize</span><span class="p">,</span><span class="n">ysize</span><span class="p">]</span>
    <span class="n">sliceoffset</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">zmin</span><span class="p">)</span>
    <span class="n">xyz</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">idlist</span><span class="p">,</span> <span class="n">indexlist</span> <span class="o">=</span> <span class="n">ids3d</span><span class="o">.</span><span class="n">ids3d</span><span class="p">(</span><span class="n">cellids</span><span class="p">,</span> <span class="n">sliceoffset</span><span class="p">,</span> <span class="n">reflevel</span><span class="p">,</span> <span class="n">xsize</span><span class="p">,</span> <span class="n">ysize</span><span class="p">,</span> <span class="n">zsize</span><span class="p">,</span> <span class="n">zmin</span><span class="o">=</span><span class="n">zmin</span><span class="p">,</span> <span class="n">zmax</span><span class="o">=</span><span class="n">zmax</span><span class="p">)</span>


    <span class="c1"># Axes and units (default R_E)</span>
    <span class="k">if</span> <span class="n">axisunit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># Use m or km or other</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">axisunit</span><span class="p">,</span><span class="mi">0</span><span class="p">):</span>
            <span class="n">axisunitstr</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">rmstring</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">axisunit</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">axisunitstr</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">rmstring</span><span class="p">(</span><span class="s1">&#39;km&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">axisunitstr</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$10^{&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">axisunit</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;} &#39;</span><span class="o">+</span><span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">rmstring</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">)</span>
        <span class="n">axisunit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">axisunit</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axisunitstr</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">rmstring</span><span class="p">(</span><span class="s1">&#39;R&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">rmstring</span><span class="p">(</span><span class="s1">&#39;E&#39;</span><span class="p">)</span>
        <span class="n">axisunit</span> <span class="o">=</span> <span class="n">Re</span>


    <span class="c1"># Select window to draw</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">boxm</span><span class="p">)</span><span class="o">==</span><span class="mi">4</span><span class="p">:</span>
        <span class="n">boxcoords</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">boxm</span><span class="p">)</span><span class="o">+</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">axisunit</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">z_extent</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">boxre</span><span class="p">)</span><span class="o">==</span><span class="mi">4</span><span class="p">:</span>
        <span class="n">boxcoords</span><span class="o">=</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">Re</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">boxre</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">Re</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">z_extent</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">boxcoords</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">simext</span><span class="p">)</span>

    <span class="c1"># If box extents were provided manually, truncate to simulation extents</span>
    <span class="n">boxcoords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">simext</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">boxcoords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">simext</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">boxcoords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">simext</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">boxcoords</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">simext</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">boxcoords</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">simext</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
    <span class="n">boxcoords</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="n">simext</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>

    <span class="c1"># Scale data extent and plot box</span>
    <span class="n">simext</span><span class="o">=</span><span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="n">axisunit</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">simext</span><span class="p">]</span>
    <span class="n">boxcoords</span><span class="o">=</span><span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="n">axisunit</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">boxcoords</span><span class="p">]</span>

    <span class="c1">#################################################</span>
    <span class="c1"># Find rhom map for use in masking out ionosphere</span>
    <span class="c1">#################################################</span>
    <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">check_variable</span><span class="p">(</span><span class="s2">&quot;moments&quot;</span><span class="p">):</span>
        <span class="n">rhomap</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read_variable</span><span class="p">(</span><span class="s2">&quot;vg_restart_rhom&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">f</span><span class="o">.</span><span class="n">check_variable</span><span class="p">(</span><span class="s2">&quot;proton/vg_rho&quot;</span><span class="p">):</span>
        <span class="n">rhomap</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read_variable</span><span class="p">(</span><span class="s2">&quot;proton/vg_rho&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">f</span><span class="o">.</span><span class="n">check_variable</span><span class="p">(</span><span class="s2">&quot;vg_rhom&quot;</span><span class="p">):</span>
        <span class="n">rhomap</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read_variable</span><span class="p">(</span><span class="s2">&quot;vg_rhom&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">f</span><span class="o">.</span><span class="n">check_variable</span><span class="p">(</span><span class="s2">&quot;rho&quot;</span><span class="p">):</span> <span class="c1">#old non-AMR data, can still be 3D</span>
        <span class="n">rhomap</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read_variable</span><span class="p">(</span><span class="s2">&quot;rho&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;vlsv data did not contain one of the following variables:</span><span class="se">\n</span><span class="s2">&quot;</span> \
        <span class="s2">&quot;moments,proton/vg_rho,vg_rhom,rho&quot;</span><span class="p">)</span>

              
    <span class="n">rhomap</span> <span class="o">=</span> <span class="n">rhomap</span><span class="p">[</span><span class="n">indexids</span><span class="p">]</span> <span class="c1"># sort</span>
    <span class="n">rhomap</span> <span class="o">=</span> <span class="n">rhomap</span><span class="p">[</span><span class="n">indexlist</span><span class="p">]</span> <span class="c1"># find required cells</span>
    <span class="c1"># Create the plotting grid</span>
    <span class="n">rhomap</span> <span class="o">=</span> <span class="n">ids3d</span><span class="o">.</span><span class="n">idmesh3d</span><span class="p">(</span><span class="n">idlist</span><span class="p">,</span> <span class="n">rhomap</span><span class="p">,</span> <span class="n">reflevel</span><span class="p">,</span> <span class="n">xsize</span><span class="p">,</span> <span class="n">ysize</span><span class="p">,</span> <span class="n">zsize</span><span class="p">,</span> <span class="n">xyz</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># scale the sizes to the heighest refinement level because</span>
    <span class="c1"># plotting is done at that level</span>
    <span class="n">sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="o">**</span><span class="n">reflevel</span><span class="p">)</span>
    <span class="n">sizes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sizes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="o">**</span><span class="n">reflevel</span><span class="p">)</span>

    <span class="c1"># Allow title override</span>
    <span class="k">if</span> <span class="n">cbtitle</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Here allow underscores for manual math mode</span>
        <span class="n">cb_title_use</span> <span class="o">=</span> <span class="n">cbtitle</span>       

    <span class="c1"># Generates the mesh to map the data to.</span>
    <span class="p">[</span><span class="n">XmeshXY</span><span class="p">,</span><span class="n">YmeshXY</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">simext</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">simext</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">num</span><span class="o">=</span><span class="n">sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">simext</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">simext</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">num</span><span class="o">=</span><span class="n">sizes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>

    <span class="c1"># The grid generated by meshgrid has all four corners for each cell.</span>
    <span class="c1"># We mask using only the centre values.</span>
    <span class="c1"># Calculate offsets for cell-centre coordinates</span>
    <span class="n">XmeshCentres</span> <span class="o">=</span> <span class="n">XmeshXY</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">XmeshXY</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">XmeshXY</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">YmeshCentres</span> <span class="o">=</span> <span class="n">YmeshXY</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">YmeshXY</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">YmeshXY</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">maskgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">XmeshCentres</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pass_full</span><span class="p">:</span>
        <span class="c1"># If zoomed-in using a defined box, and not specifically asking to pass all values:</span>
        <span class="c1"># Generate mask for only visible section (with small buffer for e.g. gradient calculations)</span>
        <span class="n">maskboundarybuffer</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">cellsize</span><span class="o">/</span><span class="n">axisunit</span>
        <span class="n">maskgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">XmeshCentres</span><span class="o">&lt;</span><span class="p">(</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">maskboundarybuffer</span><span class="p">),</span> <span class="n">maskgrid</span><span class="p">)</span>
        <span class="n">maskgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">XmeshCentres</span><span class="o">&gt;</span><span class="p">(</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">maskboundarybuffer</span><span class="p">),</span> <span class="n">maskgrid</span><span class="p">)</span>
        <span class="n">maskgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">YmeshCentres</span><span class="o">&lt;</span><span class="p">(</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">maskboundarybuffer</span><span class="p">),</span> <span class="n">maskgrid</span><span class="p">)</span>
        <span class="n">maskgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">YmeshCentres</span><span class="o">&gt;</span><span class="p">(</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">maskboundarybuffer</span><span class="p">),</span> <span class="n">maskgrid</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">is_masked</span><span class="p">(</span><span class="n">maskgrid</span><span class="p">):</span>
        <span class="c1"># Save lists for masking</span>
        <span class="n">MaskX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">maskgrid</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># [0] takes the first element of a tuple</span>
        <span class="n">MaskY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">maskgrid</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">XmeshPass</span> <span class="o">=</span> <span class="n">XmeshXY</span><span class="p">[</span><span class="n">MaskX</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">MaskX</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,:]</span>
        <span class="n">XmeshPass</span> <span class="o">=</span> <span class="n">XmeshPass</span><span class="p">[:,</span><span class="n">MaskY</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">MaskY</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">YmeshPass</span> <span class="o">=</span> <span class="n">YmeshXY</span><span class="p">[</span><span class="n">MaskX</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">MaskX</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,:]</span>
        <span class="n">YmeshPass</span> <span class="o">=</span> <span class="n">YmeshPass</span><span class="p">[:,</span><span class="n">MaskY</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">MaskY</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">XmeshCentres</span> <span class="o">=</span> <span class="n">XmeshCentres</span><span class="p">[</span><span class="n">MaskX</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">MaskX</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,:]</span>
        <span class="n">XmeshCentres</span> <span class="o">=</span> <span class="n">XmeshCentres</span><span class="p">[:,</span><span class="n">MaskY</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">MaskY</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">YmeshCentres</span> <span class="o">=</span> <span class="n">YmeshCentres</span><span class="p">[</span><span class="n">MaskX</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">MaskX</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,:]</span>
        <span class="n">YmeshCentres</span> <span class="o">=</span> <span class="n">YmeshCentres</span><span class="p">[:,</span><span class="n">MaskY</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">MaskY</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">XmeshPass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">XmeshXY</span><span class="p">)</span>
        <span class="n">YmeshPass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">YmeshXY</span><span class="p">)</span>

    <span class="n">sheet_xyz</span><span class="p">,</span> <span class="n">folds</span> <span class="o">=</span> <span class="n">sheet_coordinate_finder</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">boxcoords</span><span class="p">,</span> <span class="n">axisunit</span><span class="p">,</span> <span class="n">cellids</span><span class="p">,</span> <span class="n">reflevel</span><span class="p">,</span> <span class="n">indexids</span><span class="p">,</span> <span class="n">XmeshPass</span><span class="p">,</span> <span class="n">YmeshPass</span><span class="p">,</span> <span class="n">sheetlayer</span><span class="p">)</span>

    <span class="c1"># Read and sort coordinates for data interpolation</span>
    <span class="n">vg_coordinates</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read_variable</span><span class="p">(</span><span class="s2">&quot;vg_coordinates&quot;</span><span class="p">)</span>
    <span class="n">vg_coordinates</span> <span class="o">=</span> <span class="n">vg_coordinates</span><span class="p">[</span><span class="n">indexids</span><span class="p">]</span>


    <span class="c1">############################################</span>
    <span class="c1"># Read data and calculate required variables</span>
    <span class="c1">############################################</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">expression</span><span class="p">:</span>        
        <span class="c1"># Read data from file</span>
        <span class="k">if</span> <span class="n">operator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">operator</span><span class="o">=</span><span class="s2">&quot;pass&quot;</span>
        <span class="n">datamap_info</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read_variable_info</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">operator</span><span class="o">=</span><span class="n">operator</span><span class="p">)</span>

        <span class="n">cb_title_use</span> <span class="o">=</span> <span class="n">datamap_info</span><span class="o">.</span><span class="n">latex</span>
        <span class="c1"># Check if vscale results in standard unit</span>
        <span class="n">vscale</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">datamap_unit_latex</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">get_scaled_units</span><span class="p">(</span><span class="n">vscale</span><span class="o">=</span><span class="n">vscale</span><span class="p">,</span><span class="n">variable_info</span><span class="o">=</span><span class="n">datamap_info</span><span class="p">)</span>

        <span class="c1"># Add unit to colorbar title</span>
        <span class="k">if</span> <span class="n">datamap_unit_latex</span><span class="p">:</span>
            <span class="n">cb_title_use</span> <span class="o">=</span> <span class="n">cb_title_use</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;\,[&quot;</span><span class="o">+</span><span class="n">datamap_unit_latex</span><span class="o">+</span><span class="s2">&quot;]&quot;</span>

        <span class="n">datamap</span> <span class="o">=</span> <span class="n">datamap_info</span><span class="o">.</span><span class="n">data</span>

        <span class="c1"># Verify data shape</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">datamap</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Error, read only single value from vlsv file! datamap.shape being &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">datamap</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">datamap</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span> <span class="c1"># Vector variable</span>
            <span class="n">datamap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">datamap</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># vlasov grid, AMR</span>
        <span class="n">datamap</span> <span class="o">=</span> <span class="n">datamap</span><span class="p">[</span><span class="n">indexids</span><span class="p">]</span> <span class="c1"># sort</span>

        <span class="n">data_interpolation</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">RBFInterpolator</span><span class="p">(</span><span class="n">vg_coordinates</span><span class="p">,</span> <span class="n">datamap</span><span class="p">,</span> <span class="n">neighbors</span> <span class="o">=</span> <span class="mi">27</span><span class="p">)</span>

        <span class="n">datamap</span> <span class="o">=</span> <span class="n">data_interpolation</span><span class="p">(</span><span class="n">sheet_xyz</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">XmeshPass</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Expression set, use generated or provided colorbar title</span>
        <span class="n">cb_title_use</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="n">operatorstr</span>

    <span class="c1">#Attempt to call external and expression functions to see if they have required</span>
    <span class="c1"># variable information (If they accept the requestvars keyword, they should</span>
    <span class="c1"># return a list of variable names as strings)</span>
    <span class="n">pass3d</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">meshReflevel</span> <span class="o">=</span> <span class="n">reflevel</span>
    <span class="n">reqvariables</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">expression</span><span class="p">:</span> <span class="c1"># Check the expression</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">reqvariables</span> <span class="o">=</span> <span class="n">expression</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">if</span> <span class="n">external</span><span class="p">:</span> <span class="c1"># Check the external</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">reqvariables</span> <span class="o">=</span> <span class="n">external</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">if</span> <span class="n">reqvariables</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">reqvariables</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="s2">&quot;3d&quot;</span><span class="p">:</span>
                    <span class="n">pass3d</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="s2">&quot;noupscale&quot;</span><span class="p">:</span>
                    <span class="n">meshReflevel</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="p">(</span><span class="n">i</span> <span class="ow">in</span> <span class="n">pass_vars</span><span class="p">):</span> 
                    <span class="n">pass_vars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="c1"># If expression or external routine need variables, read them from the file.</span>
    <span class="k">if</span> <span class="n">pass_vars</span><span class="p">:</span>        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pass_times</span><span class="p">:</span>
            <span class="c1"># Note: pass_maps is now a dictionary</span>
            <span class="n">pass_maps</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># Gather the required variable maps for a single time step</span>
            <span class="k">for</span> <span class="n">mapval</span> <span class="ow">in</span> <span class="n">pass_vars</span><span class="p">:</span>

                <span class="c1"># vlasov grid, AMR</span>
                <span class="n">pass_map</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read_variable</span><span class="p">(</span><span class="n">mapval</span><span class="p">)</span>
                <span class="n">pass_map</span> <span class="o">=</span> <span class="n">pass_map</span><span class="p">[</span><span class="n">indexids</span><span class="p">]</span> <span class="c1"># sort</span>

                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">pass_map</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>    
                    <span class="n">var_interpolation</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">RBFInterpolator</span><span class="p">(</span><span class="n">vg_coordinates</span><span class="p">,</span> <span class="n">pass_map</span><span class="p">,</span> <span class="n">neighbors</span> <span class="o">=</span> <span class="mi">27</span><span class="p">)</span>
                    <span class="n">pass_map</span> <span class="o">=</span> <span class="n">var_interpolation</span><span class="p">(</span><span class="n">sheet_xyz</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">XmeshPass</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">pass_map</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span> <span class="c1"># vector variable</span>
                    <span class="n">temporary_pass_map</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pass_map</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="n">var_interpolation</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">RBFInterpolator</span><span class="p">(</span><span class="n">vg_coordinates</span><span class="p">,</span> <span class="n">pass_map</span><span class="p">[:,</span><span class="n">s</span><span class="p">],</span> <span class="n">neighbors</span> <span class="o">=</span> <span class="mi">27</span><span class="p">)</span>
                        <span class="n">temporary_pass_map</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var_interpolation</span><span class="p">(</span><span class="n">sheet_xyz</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">XmeshPass</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
                    <span class="n">pass_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">temporary_pass_map</span><span class="p">))</span>

                <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">pass_map</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>  <span class="c1"># tensor variable</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Tensor support has not been implemented yet! Aborting&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Error in reshaping pass_maps!&quot;</span><span class="p">)</span>


                <span class="n">pass_maps</span><span class="p">[</span><span class="n">mapval</span><span class="p">]</span> <span class="o">=</span> <span class="n">pass_map</span> <span class="c1"># add to the dictionary</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Or gather over a number of time steps</span>
            <span class="c1"># Note: pass_maps is now a list of dictionaries</span>
            <span class="n">pass_maps</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">diff</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Comparing files &quot;</span><span class="o">+</span><span class="n">filename</span><span class="o">+</span><span class="s2">&quot; and &quot;</span><span class="o">+</span><span class="n">diff</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">filename</span><span class="p">:</span>
                <span class="n">currstep</span> <span class="o">=</span> <span class="n">step</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">filename</span><span class="p">:</span> <span class="c1"># parse from filename</span>
                    <span class="n">currstep</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">filename</span><span class="p">[</span><span class="o">-</span><span class="mi">12</span><span class="p">:</span><span class="o">-</span><span class="mi">5</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Error, cannot determine current step for time extent extraction!&quot;</span><span class="p">)</span>

            <span class="c1"># define relative time step selection</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">pass_times</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">dsteps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">pass_times</span><span class="p">)),</span><span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">pass_times</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">pass_times</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">pass_times</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                <span class="n">dsteps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">pass_times</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span><span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">pass_times</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>                
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid value given to pass_times&quot;</span><span class="p">)</span>

            <span class="c1"># Loop over requested times</span>
            <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">dsteps</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">diff</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ds</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">filenamestep</span> <span class="o">=</span> <span class="n">filename</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">filenamestep</span> <span class="o">=</span> <span class="n">diff</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Construct using known filename.</span>
                    <span class="n">filenamestep</span> <span class="o">=</span> <span class="n">filename</span><span class="p">[:</span><span class="o">-</span><span class="mi">12</span><span class="p">]</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">currstep</span><span class="o">+</span><span class="n">ds</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="s1">&#39;0&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.vlsv&#39;</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">filenamestep</span><span class="p">)</span>
                <span class="n">fstep</span><span class="o">=</span><span class="n">pt</span><span class="o">.</span><span class="n">vlsvfile</span><span class="o">.</span><span class="n">VlsvReader</span><span class="p">(</span><span class="n">filenamestep</span><span class="p">)</span>
                <span class="n">step_cellids</span> <span class="o">=</span> <span class="n">fstep</span><span class="o">.</span><span class="n">read_variable</span><span class="p">(</span><span class="s2">&quot;CellID&quot;</span><span class="p">)</span>
                <span class="n">step_indexids</span> <span class="o">=</span> <span class="n">step_cellids</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
                <span class="n">step_cellids</span> <span class="o">=</span> <span class="n">step_cellids</span><span class="p">[</span><span class="n">step_indexids</span><span class="p">]</span>
                <span class="n">step_reflevel</span> <span class="o">=</span> <span class="n">ids3d</span><span class="o">.</span><span class="n">refinement_level</span><span class="p">(</span><span class="n">xsize</span><span class="p">,</span> <span class="n">ysize</span><span class="p">,</span> <span class="n">zsize</span><span class="p">,</span> <span class="n">step_cellids</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span> <span class="c1"># Check if Vlasov grid doesn&#39;t reach maximum (fsgrid) refinement</span>
                    <span class="k">if</span> <span class="n">xsize</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="n">step_reflevel</span> <span class="o">+</span> <span class="n">i</span><span class="p">))</span> <span class="o">==</span> <span class="n">xsizefg</span><span class="p">:</span>
                        <span class="n">step_reflevel</span> <span class="o">+=</span> <span class="n">i</span>
                        <span class="k">break</span>

                <span class="n">fsheet_xyz</span><span class="p">,</span> <span class="n">ffolds</span> <span class="o">=</span> <span class="n">sheet_coordinate_finder</span><span class="p">(</span><span class="n">fstep</span><span class="p">,</span> <span class="n">boxcoords</span><span class="p">,</span> <span class="n">axisunit</span><span class="p">,</span> <span class="n">step_cellids</span><span class="p">,</span> <span class="n">step_reflevel</span><span class="p">,</span> <span class="n">step_indexids</span><span class="p">,</span> <span class="n">XmeshPass</span><span class="p">,</span> <span class="n">YmeshPass</span><span class="p">)</span>


                <span class="c1"># Append new dictionary as new timestep</span>
                <span class="n">pass_maps</span><span class="o">.</span><span class="n">append</span><span class="p">({})</span>
                <span class="c1"># Add relative step identifier to dictionary</span>
                <span class="n">pass_maps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;dstep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span>
                <span class="c1"># Gather the required variable maps</span>
                <span class="k">for</span> <span class="n">mapval</span> <span class="ow">in</span> <span class="n">pass_vars</span><span class="p">:</span>

                    <span class="c1"># vlasov grid, AMR</span>
                    <span class="n">pass_map</span> <span class="o">=</span> <span class="n">fstep</span><span class="o">.</span><span class="n">read_variable</span><span class="p">(</span><span class="n">mapval</span><span class="p">)</span>
                    <span class="n">pass_map</span> <span class="o">=</span> <span class="n">pass_map</span><span class="p">[</span><span class="n">step_indexids</span><span class="p">]</span> <span class="c1"># sort</span>

                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">pass_map</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>    
                        <span class="n">var_interpolation</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">RBFInterpolator</span><span class="p">(</span><span class="n">vg_coordinates</span><span class="p">,</span> <span class="n">pass_map</span><span class="p">,</span> <span class="n">neighbors</span> <span class="o">=</span> <span class="mi">27</span><span class="p">)</span>
                        <span class="n">pass_map</span> <span class="o">=</span> <span class="n">var_interpolation</span><span class="p">(</span><span class="n">fsheet_xyz</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">XmeshPass</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">pass_map</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span> <span class="c1"># vector variable</span>
                        <span class="n">temporary_pass_map</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pass_map</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                            <span class="n">var_interpolation</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">RBFInterpolator</span><span class="p">(</span><span class="n">vg_coordinates</span><span class="p">,</span> <span class="n">pass_map</span><span class="p">[:,</span><span class="n">s</span><span class="p">],</span> <span class="n">neighbors</span> <span class="o">=</span> <span class="mi">27</span><span class="p">)</span>
                            <span class="n">temporary_pass_map</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var_interpolation</span><span class="p">(</span><span class="n">fsheet_xyz</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">XmeshPass</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
                        <span class="n">pass_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">temporary_pass_map</span><span class="p">))</span>

                    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">pass_map</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>  <span class="c1"># tensor variable</span>
                        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Tensor support has not been implemented yet! Aborting&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Error in reshaping pass_maps!&quot;</span><span class="p">)</span>
                    <span class="n">pass_maps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">mapval</span><span class="p">]</span> <span class="o">=</span> <span class="n">pass_map</span> <span class="c1"># add to the dictionary</span>

    <span class="c1"># colorbar title for diffs:</span>
    <span class="k">if</span> <span class="n">diff</span><span class="p">:</span>
        <span class="n">listofkeys</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">pass_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">diffvar</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">listofkeys</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">diffvar</span><span class="o">!=</span><span class="s2">&quot;dstep&quot;</span><span class="p">:</span> <span class="k">break</span>
        <span class="n">cb_title_use</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">mathmode</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bfstring</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">rmstring</span><span class="p">(</span><span class="s2">&quot;DIFF0~&quot;</span><span class="o">+</span><span class="n">diffvar</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span><span class="sa">r</span><span class="s2">&quot;\_&quot;</span><span class="p">))))</span>
    <span class="c1"># Evaluate time difference</span>
    <span class="k">if</span> <span class="n">diff</span><span class="p">:</span>
        <span class="n">tvf</span><span class="o">=</span><span class="n">pt</span><span class="o">.</span><span class="n">vlsvfile</span><span class="o">.</span><span class="n">VlsvReader</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">tvf</span><span class="o">.</span><span class="n">read_parameter</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
        <span class="n">tvf1</span><span class="o">=</span><span class="n">pt</span><span class="o">.</span><span class="n">vlsvfile</span><span class="o">.</span><span class="n">VlsvReader</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">tvf1</span><span class="o">.</span><span class="n">read_parameter</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">t1</span><span class="o">-</span><span class="n">t0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)):</span>
            <span class="n">plot_title</span> <span class="o">=</span> <span class="n">plot_title</span> <span class="o">+</span> <span class="s2">&quot;~dt=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">t1</span><span class="o">-</span><span class="n">t0</span><span class="p">)</span>


    <span class="c1">#Optional user-defined expression used for color panel instead of a single pre-existing var</span>
    <span class="k">if</span> <span class="n">expression</span><span class="p">:</span>
        <span class="n">datamap</span> <span class="o">=</span> <span class="n">expression</span><span class="p">(</span><span class="n">pass_maps</span><span class="p">)</span>

        <span class="c1"># Handle operators</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">operator</span> <span class="ow">and</span> <span class="p">(</span><span class="n">operator</span> <span class="o">!=</span> <span class="s1">&#39;pass&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">operator</span> <span class="o">!=</span> <span class="s1">&#39;magnitude&#39;</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">operator</span><span class="o">==</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> 
                <span class="n">operator</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>
            <span class="k">if</span> <span class="n">operator</span><span class="o">==</span><span class="s1">&#39;y&#39;</span><span class="p">:</span> 
                <span class="n">operator</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
            <span class="k">if</span> <span class="n">operator</span><span class="o">==</span><span class="s1">&#39;z&#39;</span><span class="p">:</span> 
                <span class="n">operator</span> <span class="o">=</span> <span class="s1">&#39;2&#39;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">operator</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span><span class="s2">&quot;Error parsing operator for custom expression!&quot;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">datamap</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                <span class="n">datamap</span> <span class="o">=</span> <span class="n">datamap</span><span class="p">[:,:,</span><span class="nb">int</span><span class="p">(</span><span class="n">operator</span><span class="p">)]</span>
        
    <span class="c1"># Now, if map is a vector or tensor, reduce it down</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">datamap</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span> <span class="c1"># vector</span>
        <span class="k">if</span> <span class="n">datamap</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">!=</span><span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Error, expected array of 3-element vectors, found array of shape &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">datamap</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

        <span class="c1"># take magnitude of three-element vectors</span>
        <span class="n">datamap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">datamap</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">datamap</span><span class="p">)</span><span class="o">==</span><span class="mi">4</span><span class="p">:</span> <span class="c1"># tensor</span>
        <span class="k">if</span> <span class="n">datamap</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">!=</span><span class="mi">3</span> <span class="ow">or</span> <span class="n">datamap</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">!=</span><span class="mi">3</span><span class="p">:</span>
            <span class="c1"># This may also catch 3D simulation fsgrid variables</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Error, expected array of 3x3 tensors, found array of shape &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">datamap</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

        <span class="c1"># take trace</span>
        <span class="n">datamap</span> <span class="o">=</span> <span class="n">datamap</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">datamap</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">datamap</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">datamap</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">5</span><span class="p">:</span> <span class="c1"># Too many dimensions</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Error, too many dimensions in datamap, found array of shape &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">datamap</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">datamap</span><span class="p">)</span><span class="o">!=</span><span class="mi">2</span><span class="p">:</span> <span class="c1"># Too many dimensions</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Error, too many dimensions in datamap, found array of shape &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">datamap</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>


    <span class="c1"># Scale final generated datamap if requested</span>
    <span class="n">datamap</span> <span class="o">=</span> <span class="n">datamap</span> <span class="o">*</span> <span class="n">vscale</span>
    
    <span class="c1"># Take absolute</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">absolute</span><span class="p">):</span>
        <span class="n">datamap</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">datamap</span><span class="p">)</span>

    <span class="c1"># Crop both rhomap and datamap to view region</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">is_masked</span><span class="p">(</span><span class="n">maskgrid</span><span class="p">):</span>
        <span class="c1"># Strip away columns and rows which are outside the plot region</span>
        <span class="n">rhomap</span> <span class="o">=</span> <span class="n">rhomap</span><span class="p">[</span><span class="n">MaskX</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">MaskX</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,:]</span>
        <span class="n">rhomap</span> <span class="o">=</span> <span class="n">rhomap</span><span class="p">[:,</span><span class="n">MaskY</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">MaskY</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>


    <span class="c1"># Mask region outside ionosphere. Note that for some boundary layer cells, </span>
    <span class="c1"># a density is calculated, but e.g. pressure is not, and these cells aren&#39;t</span>
    <span class="c1"># excluded by this method. Also mask away regions where datamap is invalid</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">nomask</span><span class="p">:</span>
        <span class="n">rhomap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_less_equal</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_invalid</span><span class="p">(</span><span class="n">rhomap</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">rhomap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">datamap</span><span class="p">),</span> <span class="n">rhomap</span><span class="p">)</span>
        <span class="n">XYmask</span> <span class="o">=</span> <span class="n">rhomap</span><span class="o">.</span><span class="n">mask</span>
        <span class="k">if</span> <span class="n">XYmask</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">XYmask</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="c1"># if everything was masked in rhomap, allow plotting</span>
                <span class="n">XYmask</span><span class="p">[:,:]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Mask datamap</span>
                <span class="n">datamap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">datamap</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">XYmask</span><span class="p">)</span>

    <span class="c1">#If automatic range finding is required, find min and max of array</span>
    <span class="c1"># Performs range-finding on a masked array to work even if array contains invalid values</span>
    <span class="k">if</span> <span class="n">vmin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">vminuse</span><span class="o">=</span><span class="n">vmin</span>
    <span class="k">else</span><span class="p">:</span> 
        <span class="n">vminuse</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">datamap</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">vmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">vmaxuse</span><span class="o">=</span><span class="n">vmax</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">vmaxuse</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">datamap</span><span class="p">)</span>

    <span class="c1"># If both values are zero, we have an empty array</span>
    <span class="k">if</span> <span class="n">vmaxuse</span><span class="o">==</span><span class="n">vminuse</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Error, requested array is zero everywhere. Exiting.&quot;</span><span class="p">)</span>


    <span class="c1"># If vminuse and vmaxuse are extracted from data, different signs, and close to each other, adjust to be symmetric</span>
    <span class="c1"># e.g. to plot transverse field components. Always done for symlog.</span>
    <span class="k">if</span> <span class="n">vmin</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">vmax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">symmetric</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">vminuse</span><span class="o">/</span><span class="n">vmaxuse</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span> <span class="ow">or</span> <span class="n">symlog</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">absval</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">vminuse</span><span class="p">),</span><span class="nb">abs</span><span class="p">(</span><span class="n">vmaxuse</span><span class="p">))</span>
            <span class="n">vminuse</span> <span class="o">=</span> <span class="o">-</span><span class="n">absval</span>
            <span class="n">vmaxuse</span> <span class="o">=</span> <span class="n">absval</span>

    <span class="c1"># Ensure that lower bound is valid for logarithmic plots</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">vminuse</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">lin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">symlog</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Drop negative and zero values</span>
        <span class="n">vminuse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_less_equal</span><span class="p">(</span><span class="n">datamap</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>

    <span class="c1"># Special case of very small vminuse values</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">vmin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">vmax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">vminuse</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">vminuse</span> <span class="o">&lt;</span> <span class="n">vmaxuse</span><span class="o">*</span><span class="mf">1.e-5</span><span class="p">):</span>
        <span class="n">vminuse</span> <span class="o">=</span> <span class="n">vmaxuse</span><span class="o">*</span><span class="mf">1e-5</span>
        <span class="k">if</span> <span class="n">lin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vminuse</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="c1"># # If symlog scaling is set:</span>
    <span class="k">if</span> <span class="n">symlog</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">symlog</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">linthresh</span> <span class="o">=</span> <span class="n">symlog</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">linthresh</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">vminuse</span><span class="p">),</span><span class="nb">abs</span><span class="p">(</span><span class="n">vmaxuse</span><span class="p">))</span><span class="o">*</span><span class="mf">1.e-2</span>

    <span class="c1"># Lin or log colour scaling, defaults to log</span>
    <span class="k">if</span> <span class="n">lin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Special SymLogNorm case</span>
        <span class="k">if</span> <span class="n">symlog</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Version</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">Version</span><span class="p">(</span><span class="s2">&quot;3.2.0&quot;</span><span class="p">):</span>
                <span class="n">norm</span> <span class="o">=</span> <span class="n">SymLogNorm</span><span class="p">(</span><span class="n">linthresh</span><span class="o">=</span><span class="n">linthresh</span><span class="p">,</span> <span class="n">linscale</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vminuse</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmaxuse</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;colormap SymLogNorm uses base-e but ticks are calculated with base-10.&quot;</span><span class="p">)</span>
                <span class="c1">#TODO: copy over matplotlib 3.3.0 implementation of SymLogNorm into analysator</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">norm</span> <span class="o">=</span> <span class="n">SymLogNorm</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">linthresh</span><span class="o">=</span><span class="n">linthresh</span><span class="p">,</span> <span class="n">linscale</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vminuse</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmaxuse</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">maxlog</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">vmaxuse</span><span class="p">)))</span>
            <span class="n">minlog</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="o">-</span><span class="n">vminuse</span><span class="p">)))</span>
            <span class="n">logthresh</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">linthresh</span><span class="p">)))</span>
            <span class="n">logstep</span><span class="o">=</span><span class="mi">1</span>
            <span class="n">ticks</span><span class="o">=</span><span class="p">([</span><span class="o">-</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">logthresh</span><span class="p">,</span> <span class="n">minlog</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">logstep</span><span class="p">)][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="o">+</span><span class="p">[</span><span class="mf">0.0</span><span class="p">]</span>
                    <span class="o">+</span><span class="p">[(</span><span class="mi">10</span><span class="o">**</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">logthresh</span><span class="p">,</span> <span class="n">maxlog</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">logstep</span><span class="p">)]</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Logarithmic plot</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">LogNorm</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">vminuse</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="n">vmaxuse</span><span class="p">)</span>
            <span class="n">ticks</span> <span class="o">=</span> <span class="n">LogLocator</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">subs</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,)</span> <span class="k">if</span> <span class="n">cb_horizontal</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)))</span> <span class="c1"># where to show labels</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Linear</span>
        <span class="n">levels</span> <span class="o">=</span> <span class="n">MaxNLocator</span><span class="p">(</span><span class="n">nbins</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">tick_values</span><span class="p">(</span><span class="n">vminuse</span><span class="p">,</span><span class="n">vmaxuse</span><span class="p">)</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">BoundaryNorm</span><span class="p">(</span><span class="n">levels</span><span class="p">,</span> <span class="n">ncolors</span><span class="o">=</span><span class="n">cmapuse</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ticks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">vminuse</span><span class="p">,</span><span class="n">vmaxuse</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="n">lin</span><span class="p">)</span>            

    <span class="c1"># Select plotting back-end based on on-screen plotting or direct to file without requiring x-windowing</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">axes</span><span class="p">:</span> <span class="c1"># If axes are provided, leave backend as-is.</span>
        <span class="k">if</span> <span class="n">draw</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">get_backend</span><span class="p">())</span> <span class="o">!=</span> <span class="n">pt</span><span class="o">.</span><span class="n">backend_interactive</span><span class="p">:</span> <span class="c1">#&#39;TkAgg&#39;: </span>
                <span class="n">plt</span><span class="o">.</span><span class="n">switch_backend</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">backend_interactive</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">get_backend</span><span class="p">())</span> <span class="o">!=</span> <span class="n">pt</span><span class="o">.</span><span class="n">backend_noninteractive</span><span class="p">:</span> <span class="c1">#&#39;Agg&#39;:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">switch_backend</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">backend_noninteractive</span><span class="p">)</span>  

    <span class="c1"># Select image shape to match plotted area</span>
    <span class="n">boxlenx</span> <span class="o">=</span> <span class="n">boxcoords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">boxleny</span> <span class="o">=</span> <span class="n">boxcoords</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="c1"># Round the values so that image sizes won&#39;t wobble when there&#39;s e.g. a moving box and numerical inaccuracies.</span>
    <span class="c1"># This is only done if the box size is suitable for the unit in use.</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">boxlenx</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">boxleny</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)):</span>
        <span class="n">boxlenx</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">boxlenx</span><span class="o">*</span><span class="mi">20</span><span class="o">*</span><span class="mf">1.024</span><span class="p">)</span> <span class="p">)</span> 
        <span class="n">boxleny</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">boxleny</span><span class="o">*</span><span class="mi">20</span><span class="o">*</span><span class="mf">1.024</span><span class="p">)</span> <span class="p">)</span> 
    <span class="n">ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">boxleny</span><span class="o">/</span><span class="n">boxlenx</span><span class="p">)</span>
    <span class="c1"># default for square figure is figsize=[4.0,3.15] (with some accounting for axes etc)</span>
    <span class="n">figsize</span> <span class="o">=</span> <span class="p">[</span><span class="mf">4.0</span><span class="p">,</span><span class="mf">3.15</span><span class="o">*</span><span class="n">ratio</span><span class="p">]</span>
    <span class="c1"># Special case for edge-to-edge figures</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">plot_title</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">nocb</span> <span class="ow">or</span> <span class="n">internalcb</span><span class="p">)</span> <span class="ow">and</span> <span class="n">noborder</span> <span class="ow">and</span> <span class="n">noxlabels</span> <span class="ow">and</span> <span class="n">noylabels</span><span class="p">):</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="p">(</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">figsize</span> <span class="o">=</span> <span class="p">[</span><span class="mf">4.0</span><span class="p">,</span><span class="mf">4.0</span><span class="o">*</span><span class="n">ratio</span><span class="p">]</span>

    <span class="c1"># If requested high res image</span>
    <span class="k">if</span> <span class="n">highres</span><span class="p">:</span>
        <span class="n">highresscale</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="p">((</span><span class="nb">type</span><span class="p">(</span><span class="n">highres</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">highres</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)):</span>
            <span class="n">highresscale</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">highres</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">highresscale</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">):</span>
                <span class="n">highresscale</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">figsize</span><span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">*</span> <span class="n">highresscale</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">figsize</span><span class="p">]</span>
        <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="o">*</span><span class="n">highresscale</span>
        <span class="n">fontsize2</span><span class="o">=</span><span class="n">fontsize2</span><span class="o">*</span><span class="n">highresscale</span>
        <span class="n">fontsize3</span><span class="o">=</span><span class="n">fontsize3</span><span class="o">*</span><span class="n">highresscale</span>
        <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="o">*</span><span class="n">highresscale</span>
        <span class="n">thick</span><span class="o">=</span><span class="n">thick</span><span class="o">*</span><span class="n">highresscale</span>
        <span class="n">streamlinethick</span><span class="o">=</span><span class="n">streamlinethick</span><span class="o">*</span><span class="n">highresscale</span>
        <span class="n">vectorsize</span><span class="o">=</span><span class="n">vectorsize</span><span class="o">*</span><span class="n">highresscale</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">axes</span><span class="p">:</span>
        <span class="c1"># Create 300 dpi image of suitable size</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span> <span class="c1"># get current axes</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax1</span><span class="o">=</span><span class="n">axes</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span> <span class="c1"># get current figure</span>

    <span class="c1"># Plot the actual mesh</span>
    <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="n">useimshow</span><span class="p">):</span>
        <span class="n">fig1</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">XmeshPass</span><span class="p">,</span><span class="n">YmeshPass</span><span class="p">,</span><span class="n">datamap</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">colormap</span><span class="p">,</span><span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig1</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">datamap</span><span class="p">,</span>
                          <span class="n">cmap</span><span class="o">=</span><span class="n">colormap</span><span class="p">,</span>
                          <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span>
                          <span class="n">interpolation</span><span class="o">=</span><span class="n">imshowinterp</span><span class="p">,</span>
                          <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span>
                          <span class="n">extent</span><span class="o">=</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">XmeshPass</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">XmeshPass</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">YmeshPass</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">YmeshPass</span><span class="p">))</span>
                         <span class="p">)</span>

    <span class="c1"># Title and plot limits</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_title</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Add 3D slice position in title</span>
        <span class="n">plot_title</span> <span class="o">=</span> <span class="n">plot_title</span>
        <span class="n">plot_title</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">mathmode</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bfstring</span><span class="p">(</span><span class="n">plot_title</span><span class="p">))</span>        
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">plot_title</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize2</span><span class="p">,</span><span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>

    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">3</span><span class="p">]])</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">,</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="s1">&#39;right&#39;</span><span class="p">]:</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="n">thick</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="n">thick</span><span class="p">,</span><span class="n">length</span><span class="o">=</span><span class="mi">3</span><span class="o">*</span><span class="n">thick</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="n">thick</span><span class="p">,</span><span class="n">length</span><span class="o">=</span><span class="mi">3</span><span class="o">*</span><span class="n">thick</span><span class="p">)</span>
    <span class="c1">#ax1.xaxis.set_tick_params(which=&#39;minor&#39;,width=3,length=5)</span>
    <span class="c1">#ax1.yaxis.set_tick_params(which=&#39;minor&#39;,width=3,length=5)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">noxlabels</span><span class="p">:</span>
        <span class="n">xlabelstr</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">mathmode</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bfstring</span><span class="p">(</span><span class="n">axislabels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="sa">r</span><span class="s1">&#39;\,[&#39;</span><span class="o">+</span><span class="n">axisunitstr</span><span class="o">+</span><span class="s1">&#39;]&#39;</span><span class="p">))</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabelstr</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span><span class="n">weight</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">ax1</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">():</span>
            <span class="n">item</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">fontsize</span><span class="p">)</span>
            <span class="n">item</span><span class="o">.</span><span class="n">set_fontweight</span><span class="p">(</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">offsetText</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">fontsize</span><span class="p">)</span><span class="c1"># set axis exponent offset font sizes</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">noylabels</span><span class="p">:</span>
        <span class="n">ylabelstr</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">mathmode</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bfstring</span><span class="p">(</span><span class="n">axislabels</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="sa">r</span><span class="s1">&#39;\,[&#39;</span><span class="o">+</span><span class="n">axisunitstr</span><span class="o">+</span><span class="s1">&#39;]&#39;</span><span class="p">))</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabelstr</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span><span class="n">weight</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">ax1</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">():</span>
            <span class="n">item</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">fontsize</span><span class="p">)</span>
            <span class="n">item</span><span class="o">.</span><span class="n">set_fontweight</span><span class="p">(</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">offsetText</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">fontsize</span><span class="p">)</span><span class="c1"># set axis exponent offset font sizes</span>


    <span class="k">if</span> <span class="n">Earth</span><span class="p">:</span>
        <span class="n">Earth</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
        <span class="n">Earth2</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Wedge</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="mf">0.9</span><span class="p">,</span> <span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">Earth</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">Earth2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">folding_alpha</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">folds_to_plot</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">folds</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">folds_to_plot</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">axisunit</span><span class="p">,</span> <span class="n">folds_to_plot</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">axisunit</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">folding_alpha</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">streamlines</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Streamline support not implemented yet! Aborting&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>       
        


    <span class="c1"># add vectors on top</span>
    <span class="k">if</span> <span class="n">vectors</span><span class="p">:</span>

        <span class="n">sheet_cids</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">get_cellid</span><span class="p">(</span><span class="n">sheet_coord</span><span class="p">)</span> <span class="k">for</span> <span class="n">sheet_coord</span> <span class="ow">in</span> <span class="n">sheet_xyz</span><span class="p">]</span>   <span class="c1">#slow</span>
        <span class="n">xlen</span><span class="p">,</span> <span class="n">ylen</span> <span class="o">=</span> <span class="n">XmeshPass</span><span class="o">.</span><span class="n">shape</span>
        
        <span class="c1"># vlasov grid, AMR</span>
        <span class="n">vectmap</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read_variable</span><span class="p">(</span><span class="n">vectors</span><span class="p">,</span> <span class="n">sheet_cids</span><span class="p">)</span>
        <span class="n">vectmap</span> <span class="o">=</span> <span class="n">vectmap</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">xlen</span><span class="p">,</span> <span class="n">ylen</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">XYmask</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">vectmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vectmap</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">vectmap</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">XYmask</span>

    
        <span class="c1"># Find vector lengths and define color</span>
        <span class="n">lengths</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vectmap</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Mask out the smallest vectors (at e.g. inner boundary)</span>
        <span class="n">lengths</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_less</span><span class="p">(</span><span class="n">lengths</span><span class="p">,</span> <span class="mf">0.01</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">lengths</span><span class="p">))</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">lengths</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">lengths</span><span class="p">)))</span>

        <span class="c1"># Try to estimate vectstep so there&#39;s about 100 vectors in the image area</span>
        <span class="n">visibleboxcells</span> <span class="o">=</span> <span class="p">(</span><span class="n">axisunit</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="p">((</span><span class="n">cellsize</span><span class="o">*</span><span class="p">(</span><span class="mf">0.5</span><span class="o">**</span><span class="n">reflevel</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">vectstep</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">visibleboxcells</span><span class="o">/</span><span class="n">vectordensity</span><span class="p">))</span>
        <span class="n">vectstep</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">vectstep</span><span class="p">)</span>
        
        <span class="c1"># inplane unit length vectors</span>
        <span class="n">vectmap</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">vectmap</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">vectmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">vectmap</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vectmap</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)[:,:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>
       
        <span class="n">X</span> <span class="o">=</span> <span class="n">XmeshCentres</span><span class="p">[::</span><span class="n">vectstep</span><span class="p">,::</span><span class="n">vectstep</span><span class="p">]</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">YmeshCentres</span><span class="p">[::</span><span class="n">vectstep</span><span class="p">,::</span><span class="n">vectstep</span><span class="p">]</span>

        <span class="n">U</span> <span class="o">=</span> <span class="n">vectmap</span><span class="p">[::</span><span class="n">vectstep</span><span class="p">,::</span><span class="n">vectstep</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>            
        <span class="n">V</span> <span class="o">=</span> <span class="n">vectmap</span><span class="p">[::</span><span class="n">vectstep</span><span class="p">,::</span><span class="n">vectstep</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[::</span><span class="n">vectstep</span><span class="p">,::</span><span class="n">vectstep</span><span class="p">]</span> 
        <span class="c1"># quiver uses scale in the inverse fashion</span>
    
        <span class="n">ax1</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">V</span><span class="p">,</span><span class="n">C</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">vectorcolormap</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;dots&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.05</span><span class="o">/</span><span class="n">vectorsize</span><span class="p">,</span> <span class="n">headlength</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">headwidth</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                   <span class="n">headaxislength</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">scale_units</span><span class="o">=</span><span class="s1">&#39;dots&#39;</span><span class="p">,</span> <span class="n">pivot</span><span class="o">=</span><span class="s1">&#39;middle&#39;</span><span class="p">)</span>
    

    <span class="c1"># Optional external additional plotting routine overlayed on color plot</span>
    <span class="c1"># Uses the same pass_maps variable as expressions</span>
    <span class="k">if</span> <span class="n">external</span><span class="p">:</span>
        <span class="c1">#extresult=external(ax1, XmeshXY,YmeshXY, pass_maps)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">axes</span><span class="p">:</span>
            <span class="n">extresult</span><span class="o">=</span><span class="n">external</span><span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">XmeshCentres</span><span class="p">,</span><span class="n">YmeshCentres</span><span class="p">,</span> <span class="n">pass_maps</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">extresult</span><span class="o">=</span><span class="n">external</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">XmeshCentres</span><span class="p">,</span><span class="n">YmeshCentres</span><span class="p">,</span> <span class="n">pass_maps</span><span class="p">)</span>


    <span class="k">if</span> <span class="ow">not</span> <span class="n">nocb</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cbaxes</span><span class="p">:</span> 
            <span class="c1"># Colorbar axes are provided</span>
            <span class="n">cax</span> <span class="o">=</span> <span class="n">cbaxes</span>
            <span class="n">cbdir</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">;</span> <span class="n">horalign</span><span class="o">=</span><span class="s2">&quot;left&quot;</span>
        <span class="k">elif</span> <span class="n">internalcb</span><span class="p">:</span>
            <span class="c1"># Colorbar within plot area</span>
            <span class="n">cbloc</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">cbdir</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">;</span> <span class="n">horalign</span><span class="o">=</span><span class="s2">&quot;right&quot;</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">internalcb</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">internalcb</span><span class="o">==</span><span class="s2">&quot;NW&quot;</span><span class="p">:</span>
                    <span class="n">cbloc</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span> <span class="n">cbdir</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">;</span> <span class="n">horalign</span><span class="o">=</span><span class="s2">&quot;left&quot;</span>
                <span class="k">if</span> <span class="n">internalcb</span><span class="o">==</span><span class="s2">&quot;SW&quot;</span><span class="p">:</span> 
                    <span class="n">cbloc</span><span class="o">=</span><span class="mi">3</span><span class="p">;</span> <span class="n">cbdir</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">;</span> <span class="n">horalign</span><span class="o">=</span><span class="s2">&quot;left&quot;</span>
                <span class="k">if</span> <span class="n">internalcb</span><span class="o">==</span><span class="s2">&quot;SE&quot;</span><span class="p">:</span> 
                    <span class="n">cbloc</span><span class="o">=</span><span class="mi">4</span><span class="p">;</span> <span class="n">cbdir</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">;</span>  <span class="n">horalign</span><span class="o">=</span><span class="s2">&quot;right&quot;</span>
            <span class="c1"># borderpad default value is 0.5, need to increase it to make room for colorbar title</span>
            <span class="n">cax</span> <span class="o">=</span> <span class="n">inset_locator</span><span class="o">.</span><span class="n">inset_axes</span><span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;5%&quot;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="s2">&quot;35%&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">cbloc</span><span class="p">,</span> <span class="n">borderpad</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
                             <span class="n">bbox_transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Split existing axes to make room for colorbar</span>
            <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">ax1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cb_horizontal</span><span class="p">:</span>
                <span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;4%&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.55</span><span class="o">*</span><span class="n">scale</span><span class="p">)</span>     
                <span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_label_coords</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="o">-</span><span class="mf">0.18</span><span class="p">)</span>
                <span class="n">horalign</span><span class="o">=</span><span class="s2">&quot;center&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;5%&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
                <span class="n">horalign</span><span class="o">=</span><span class="s2">&quot;left&quot;</span>
            <span class="n">cbdir</span><span class="o">=</span><span class="s2">&quot;right&quot;</span>


        <span class="c1"># Colourbar title</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cb_title_use</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">cb_title_use</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">mathmode</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bfstring</span><span class="p">(</span><span class="n">cb_title_use</span><span class="p">))</span>

        <span class="c1"># Set flag which affects colorbar decimal precision</span>
        <span class="k">if</span> <span class="n">lin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">cb_linear</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">cb_linear</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># First draw colorbar</span>
        <span class="k">if</span> <span class="n">usesci</span><span class="p">:</span>
            <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">fig1</span><span class="p">,</span> <span class="n">ticks</span><span class="o">=</span><span class="n">ticks</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">mtick</span><span class="o">.</span><span class="n">FuncFormatter</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">cbfmtsci</span><span class="p">),</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="n">drawedges</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;horizontal&quot;</span> <span class="k">if</span> <span class="n">cb_horizontal</span> <span class="k">else</span> <span class="s2">&quot;vertical&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#cb = plt.colorbar(fig1, ticks=ticks, format=mtick.FormatStrFormatter(&#39;%4.2f&#39;), cax=cax, drawedges=False)</span>
            <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">fig1</span><span class="p">,</span> <span class="n">ticks</span><span class="o">=</span><span class="n">ticks</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">mtick</span><span class="o">.</span><span class="n">FuncFormatter</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">cbfmt</span><span class="p">),</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="n">drawedges</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;horizontal&quot;</span> <span class="k">if</span> <span class="n">cb_horizontal</span> <span class="k">else</span> <span class="s2">&quot;vertical&quot;</span><span class="p">)</span>
        <span class="n">cb</span><span class="o">.</span><span class="n">outline</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="n">thick</span><span class="p">)</span>
        <span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="n">cbdir</span><span class="p">)</span>
        <span class="c1"># Ensure minor tick marks are off</span>
        <span class="k">if</span> <span class="n">lin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cb</span><span class="o">.</span><span class="n">minorticks_off</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">cbaxes</span><span class="p">:</span>
            <span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="n">fontsize3</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="n">thick</span><span class="p">,</span><span class="n">length</span><span class="o">=</span><span class="mi">3</span><span class="o">*</span><span class="n">thick</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="mi">30</span> <span class="k">if</span> <span class="n">cb_horizontal</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">cb_title</span> <span class="o">=</span> <span class="n">cax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">cb_title_use</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize3</span><span class="p">,</span><span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="n">horalign</span><span class="p">)</span>
            <span class="n">cb_title</span><span class="o">.</span><span class="n">set_position</span><span class="p">((</span><span class="mf">0.</span><span class="p">,</span><span class="mf">1.</span><span class="o">+</span><span class="mf">0.025</span><span class="o">*</span><span class="n">scale</span><span class="p">))</span> <span class="c1"># avoids having colourbar title too low when fontsize is increased</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="n">thick</span><span class="p">,</span><span class="n">length</span><span class="o">=</span><span class="mi">3</span><span class="o">*</span><span class="n">thick</span><span class="p">)</span>
            <span class="n">cb_title</span> <span class="o">=</span> <span class="n">cax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">cb_title_use</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span><span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="n">horalign</span><span class="p">)</span>

        <span class="c1"># Perform intermediate draw if necessary to gain access to ticks</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">symlog</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">vminuse</span><span class="o">/</span><span class="n">vmaxuse</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">0.2</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">lin</span> <span class="ow">and</span> <span class="n">symlog</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span> <span class="c1"># draw to get tick positions</span>

        <span class="c1"># Adjust placement of innermost ticks for symlog if it indeed is (quasi)symmetric</span>
        <span class="k">if</span> <span class="n">symlog</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">vminuse</span><span class="o">/</span><span class="n">vmaxuse</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>
            <span class="n">cbt</span><span class="o">=</span><span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">get_ticklabels</span><span class="p">()</span>
            <span class="p">(</span><span class="n">cbtx</span><span class="p">,</span><span class="n">cbty</span><span class="p">)</span> <span class="o">=</span> <span class="n">cbt</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">cbt</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span> <span class="c1"># just below zero</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="mf">0.5</span><span class="o">-</span><span class="n">cbty</span><span class="p">)</span><span class="o">/</span><span class="n">scale</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">:</span>
                <span class="n">cbt</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">cbt</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_va</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">)</span>
            <span class="p">(</span><span class="n">cbtx</span><span class="p">,</span><span class="n">cbty</span><span class="p">)</span> <span class="o">=</span> <span class="n">cbt</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">cbt</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span> <span class="c1"># just above zero</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="mf">0.5</span><span class="o">-</span><span class="n">cbty</span><span class="p">)</span><span class="o">/</span><span class="n">scale</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">:</span>
                <span class="n">cbt</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">cbt</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_va</span><span class="p">(</span><span class="s2">&quot;bottom&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cbt</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">7</span><span class="p">:</span> <span class="c1"># If we have at least seven ticks, may want to adjust next ones as well</span>
                <span class="p">(</span><span class="n">cbtx</span><span class="p">,</span><span class="n">cbty</span><span class="p">)</span> <span class="o">=</span> <span class="n">cbt</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">cbt</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span> <span class="c1"># second below zero</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="mf">0.5</span><span class="o">-</span><span class="n">cbty</span><span class="p">)</span><span class="o">/</span><span class="n">scale</span> <span class="o">&lt;</span> <span class="mf">0.15</span><span class="p">:</span>
                    <span class="n">cbt</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">cbt</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_va</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">)</span>
                <span class="p">(</span><span class="n">cbtx</span><span class="p">,</span><span class="n">cbty</span><span class="p">)</span> <span class="o">=</span> <span class="n">cbt</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">cbt</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span> <span class="c1"># second above zero</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="mf">0.5</span><span class="o">-</span><span class="n">cbty</span><span class="p">)</span><span class="o">/</span><span class="n">scale</span> <span class="o">&lt;</span> <span class="mf">0.15</span><span class="p">:</span>
                    <span class="n">cbt</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">cbt</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_va</span><span class="p">(</span><span class="s2">&quot;bottom&quot;</span><span class="p">)</span>

        <span class="c1"># Adjust precision for colorbar ticks</span>
        <span class="n">thesetickvalues</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="n">locator</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">thesetickvalues</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">precision_b</span><span class="o">=</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mintickinterval</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">thesetickvalues</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">thesetickvalues</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="c1"># find smallest interval</span>
            <span class="k">for</span> <span class="n">ticki</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">thesetickvalues</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">mintickinterval</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">mintickinterval</span><span class="p">,</span><span class="nb">abs</span><span class="p">(</span><span class="n">thesetickvalues</span><span class="p">[</span><span class="n">ticki</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">thesetickvalues</span><span class="p">[</span><span class="n">ticki</span><span class="p">]))</span>
            <span class="n">precision_a</span><span class="p">,</span> <span class="n">precision_b</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.1e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mintickinterval</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;e&#39;</span><span class="p">)</span>
            <span class="c1"># e.g. 9.0e-1 means we need precision 1</span>
            <span class="c1"># e.g. 1.33e-1 means we need precision 3?</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">decimalprecision_cblin</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">precision_b</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span> <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">decimalprecision_cblin</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="nb">abs</span><span class="p">(</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">precision_b</span><span class="p">)))</span>
        <span class="n">cb</span><span class="o">.</span><span class="n">update_ticks</span><span class="p">()</span>

        <span class="c1"># if too many subticks in logarithmic colorbar:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lin</span> <span class="ow">and</span> <span class="n">symlog</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nlabels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">get_ticklabels</span><span class="p">())</span> <span class="o">/</span> <span class="n">ratio</span>
            <span class="c1"># Force less ticks for internal colorbars</span>
            <span class="k">if</span> <span class="n">internalcb</span><span class="p">:</span> 
                <span class="n">nlabels</span> <span class="o">=</span> <span class="n">nlabels</span> <span class="o">*</span> <span class="mf">1.5</span>
            <span class="n">valids</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="s1">&#39;2&#39;</span><span class="p">,</span><span class="s1">&#39;3&#39;</span><span class="p">,</span><span class="s1">&#39;4&#39;</span><span class="p">,</span><span class="s1">&#39;5&#39;</span><span class="p">,</span><span class="s1">&#39;6&#39;</span><span class="p">,</span><span class="s1">&#39;7&#39;</span><span class="p">,</span><span class="s1">&#39;8&#39;</span><span class="p">,</span><span class="s1">&#39;9&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">nlabels</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">valids</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="s1">&#39;2&#39;</span><span class="p">,</span><span class="s1">&#39;3&#39;</span><span class="p">,</span><span class="s1">&#39;4&#39;</span><span class="p">,</span><span class="s1">&#39;5&#39;</span><span class="p">,</span><span class="s1">&#39;6&#39;</span><span class="p">,</span><span class="s1">&#39;8&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">nlabels</span> <span class="o">&gt;</span> <span class="mi">19</span><span class="p">:</span>
                <span class="n">valids</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="s1">&#39;2&#39;</span><span class="p">,</span><span class="s1">&#39;5&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">nlabels</span> <span class="o">&gt;</span> <span class="mi">28</span><span class="p">:</span>
                <span class="n">valids</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">]</span>
            <span class="c1"># for label in cb.ax.yaxis.get_ticklabels()[::labelincrement]:</span>
            <span class="k">for</span> <span class="n">labi</span><span class="p">,</span><span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">get_ticklabels</span><span class="p">()):</span>
                <span class="n">labeltext</span> <span class="o">=</span> <span class="n">label</span><span class="o">.</span><span class="n">get_text</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;$&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\mbox{\textbf{--}}&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">labeltext</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">firstdigit</span> <span class="o">=</span> <span class="n">labeltext</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">firstdigit</span> <span class="ow">in</span> <span class="n">valids</span><span class="p">:</span> 
                    <span class="n">label</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Add Vlasiator watermark</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">wmark</span> <span class="ow">or</span> <span class="n">wmarkb</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">axes</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">wmark</span><span class="p">:</span>
            <span class="n">wm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">get_sample_data</span><span class="p">(</span><span class="n">watermarkimage</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wmark</span><span class="o">=</span><span class="n">wmarkb</span> <span class="c1"># for checking for placement</span>
            <span class="n">wm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">get_sample_data</span><span class="p">(</span><span class="n">watermarkimageblack</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">wmark</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">anchor</span> <span class="o">=</span> <span class="n">wmark</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">anchor</span><span class="o">=</span><span class="s2">&quot;NW&quot;</span>
        <span class="c1"># Allowed region and anchor used in tandem for desired effect</span>
        <span class="k">if</span> <span class="n">anchor</span><span class="o">==</span><span class="s2">&quot;NW&quot;</span> <span class="ow">or</span> <span class="n">anchor</span><span class="o">==</span><span class="s2">&quot;W&quot;</span> <span class="ow">or</span> <span class="n">anchor</span><span class="o">==</span><span class="s2">&quot;SW&quot;</span><span class="p">:</span>
            <span class="n">rect</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.98</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">anchor</span><span class="o">==</span><span class="s2">&quot;NE&quot;</span> <span class="ow">or</span> <span class="n">anchor</span><span class="o">==</span><span class="s2">&quot;E&quot;</span> <span class="ow">or</span> <span class="n">anchor</span><span class="o">==</span><span class="s2">&quot;SE&quot;</span><span class="p">:</span>
            <span class="n">rect</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.69</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.98</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">anchor</span><span class="o">==</span><span class="s2">&quot;N&quot;</span> <span class="ow">or</span> <span class="n">anchor</span><span class="o">==</span><span class="s2">&quot;C&quot;</span> <span class="ow">or</span> <span class="n">anchor</span><span class="o">==</span><span class="s2">&quot;S&quot;</span><span class="p">:</span>
            <span class="n">rect</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.35</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.98</span><span class="p">]</span>
        <span class="n">newax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">(</span><span class="n">rect</span><span class="p">,</span> <span class="n">anchor</span><span class="o">=</span><span class="n">anchor</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">newax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">wm</span><span class="p">)</span>
        <span class="n">newax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

    <span class="c1"># Find required precision</span>
    <span class="n">mintickinterval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">boxcoords</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">boxcoords</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">tickinterval</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span> <span class="c1"># draw to get tick positions</span>
    <span class="k">for</span> <span class="n">axisi</span><span class="p">,</span> <span class="n">axis</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">tickinterval</span><span class="p">:</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">mtick</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="n">tickinterval</span><span class="p">))</span>
            <span class="n">mintickinterval</span> <span class="o">=</span> <span class="n">tickinterval</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># Find tick interval</span>
            <span class="n">thesetickvalues</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">get_major_locator</span><span class="p">()()</span>
            <span class="n">mintickinterval</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">mintickinterval</span><span class="p">,</span><span class="nb">abs</span><span class="p">(</span><span class="n">thesetickvalues</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">thesetickvalues</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="c1"># Adjust axis tick labels</span>
    <span class="k">for</span> <span class="n">axisi</span><span class="p">,</span> <span class="n">axis</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="p">]):</span>
        <span class="c1"># Set required decimal precision</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">decimalprecision_ax</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>
        <span class="n">precision_a</span><span class="p">,</span> <span class="n">precision_b</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.1e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mintickinterval</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;e&#39;</span><span class="p">)</span>
        <span class="c1"># e.g. 9.0e-1 means we need precision 1</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">precision_b</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span> <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">decimalprecision_ax</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">precision_b</span><span class="p">)))</span>
        <span class="c1"># Find maximum possible lengths of axis tick labels</span>
        <span class="c1"># Only counts digits</span>
        <span class="n">axisminmax</span> <span class="o">=</span> <span class="n">boxcoords</span><span class="p">[</span><span class="n">axisi</span><span class="o">*</span><span class="mi">2</span><span class="p">:</span><span class="n">axisi</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">ticklens</span> <span class="o">=</span> <span class="p">[</span> <span class="nb">len</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\D&#39;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">axisfmt</span><span class="p">(</span><span class="n">bc</span><span class="p">,</span><span class="kc">None</span><span class="p">)))</span> <span class="k">for</span> <span class="n">bc</span> <span class="ow">in</span> <span class="n">axisminmax</span><span class="p">]</span>
        <span class="n">tickmaxlens</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">ticklens</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">])</span>
        
        <span class="c1"># Custom tick formatter</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">mtick</span><span class="o">.</span><span class="n">FuncFormatter</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">axisfmt</span><span class="p">))</span>
        <span class="n">ticklabs</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">get_ticklabels</span><span class="p">()</span>
        <span class="c1"># Set boldface.</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ticklabs</span><span class="p">:</span>
            <span class="n">t</span><span class="o">.</span><span class="n">set_fontweight</span><span class="p">(</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
            <span class="c1"># If label has &gt;3 numbers, tilt it</span>
            <span class="k">if</span> <span class="n">tickmaxlens</span><span class="o">&gt;</span><span class="mi">3</span><span class="p">:</span> 
                <span class="n">t</span><span class="o">.</span><span class="n">set_rotation</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
                <span class="n">t</span><span class="o">.</span><span class="n">set_verticalalignment</span><span class="p">(</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
                <span class="n">t</span><span class="o">.</span><span class="n">set_horizontalalignment</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>

    <span class="c1"># Or turn x-axis labels off</span>
    <span class="k">if</span> <span class="n">noxlabels</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">get_ticklabels</span><span class="p">():</span>
            <span class="n">label</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span> 
    <span class="c1"># Or turn y-axis labels off</span>
    <span class="k">if</span> <span class="n">noylabels</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">get_ticklabels</span><span class="p">():</span>
            <span class="n">label</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Adjust layout. Uses tight_layout() but in fact this ensures </span>
    <span class="c1"># that long titles and tick labels are still within the plot area.</span>
    <span class="k">if</span> <span class="n">axes</span><span class="p">:</span>
        <span class="n">savefig_pad</span><span class="o">=</span><span class="mf">0.01</span>
        <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">noborder</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">savefig_pad</span><span class="o">=</span><span class="mf">0.05</span> <span class="c1"># The default is 0.1</span>
        <span class="n">bbox_inches</span><span class="o">=</span><span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
        <span class="n">savefig_pad</span><span class="o">=</span><span class="mf">0.01</span>
        <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span>
        
    <span class="c1"># Save output or draw on-screen</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">draw</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">axes</span><span class="p">:</span>
        <span class="n">outputfile_default</span><span class="o">=</span><span class="n">run</span><span class="o">+</span><span class="s2">&quot;_sheet_&quot;</span><span class="o">+</span><span class="n">varstr</span><span class="o">+</span><span class="n">operatorfilestr</span><span class="o">+</span><span class="n">stepstr</span><span class="o">+</span><span class="s2">&quot;.png&quot;</span>
        <span class="n">savefigname</span><span class="o">=</span><span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">output_path</span><span class="p">(</span><span class="n">outputfile</span><span class="p">,</span><span class="n">outputfile_default</span><span class="p">,</span><span class="n">outputdir</span><span class="p">,</span><span class="n">nooverwrite</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savefigname</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="n">bbox_inches</span><span class="p">,</span> <span class="n">pad_inches</span><span class="o">=</span><span class="n">savefig_pad</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Error with attempting to save figure &quot;</span><span class="o">+</span><span class="n">savefigname</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">savefigname</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">axes</span><span class="p">:</span>
        <span class="c1"># Draw on-screen</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">sheet_coordinate_finder</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">boxcoords</span><span class="p">,</span> <span class="n">axisunit</span><span class="p">,</span> <span class="n">cellids</span><span class="p">,</span> <span class="n">reflevel</span><span class="p">,</span> <span class="n">indexids</span><span class="p">,</span> <span class="n">XmeshPass</span><span class="p">,</span> <span class="n">YmeshPass</span><span class="p">,</span> <span class="n">sheetlayer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper function for plot_neutral_sheet</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">[</span><span class="n">xsize</span><span class="p">,</span> <span class="n">ysize</span><span class="p">,</span> <span class="n">zsize</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get_spatial_mesh_size</span><span class="p">()</span>
    <span class="n">xsize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">xsize</span><span class="p">)</span>
    <span class="n">ysize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ysize</span><span class="p">)</span>
    <span class="n">zsize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">zsize</span><span class="p">)</span>    
    <span class="p">[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">zmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">zmax</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get_spatial_mesh_extent</span><span class="p">()</span>
    <span class="n">cellsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmax</span><span class="o">-</span><span class="n">xmin</span><span class="p">)</span><span class="o">/</span><span class="n">xsize</span>

    <span class="c1"># Read the FSgrid mesh</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="p">[</span><span class="n">xsizefg</span><span class="p">,</span> <span class="n">ysizefg</span><span class="p">,</span> <span class="n">zsizefg</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get_fsgrid_mesh_size</span><span class="p">()</span>
        <span class="n">xsizefg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">xsizefg</span><span class="p">)</span>
        <span class="n">ysizefg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ysizefg</span><span class="p">)</span>
        <span class="n">zsizefg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">zsizefg</span><span class="p">)</span>
        <span class="p">[</span><span class="n">xminfg</span><span class="p">,</span> <span class="n">yminfg</span><span class="p">,</span> <span class="n">zminfg</span><span class="p">,</span> <span class="n">xmaxfg</span><span class="p">,</span> <span class="n">ymaxfg</span><span class="p">,</span> <span class="n">zmaxfg</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get_fsgrid_mesh_extent</span><span class="p">()</span>
        <span class="n">cellsizefg</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmaxfg</span><span class="o">-</span><span class="n">xminfg</span><span class="p">)</span><span class="o">/</span><span class="n">xsizefg</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">plot_helpers</span><span class="o">.</span><span class="n">CELLSIZE</span> <span class="o">=</span> <span class="n">cellsizefg</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">xsize</span><span class="o">!=</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">ysize</span><span class="o">!=</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">zsize</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Did not find fsgrid data, but found 3D DCCRG mesh. Attempting to adapt.&quot;</span><span class="p">)</span>
            <span class="p">[</span><span class="n">xsizefg</span><span class="p">,</span> <span class="n">ysizefg</span><span class="p">,</span> <span class="n">zsizefg</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">xsize</span> <span class="o">*</span> <span class="mi">2</span><span class="o">**</span><span class="n">f</span><span class="o">.</span><span class="n">get_max_refinement_level</span><span class="p">(),</span> <span class="n">ysize</span> <span class="o">*</span> <span class="mi">2</span><span class="o">**</span><span class="n">f</span><span class="o">.</span><span class="n">get_max_refinement_level</span><span class="p">(),</span> <span class="n">zsize</span> <span class="o">*</span> <span class="mi">2</span><span class="o">**</span><span class="n">f</span><span class="o">.</span><span class="n">get_max_refinement_level</span><span class="p">()]</span>
            <span class="p">[</span><span class="n">xminfg</span><span class="p">,</span> <span class="n">yminfg</span><span class="p">,</span> <span class="n">zminfg</span><span class="p">,</span> <span class="n">xmaxfg</span><span class="p">,</span> <span class="n">ymaxfg</span><span class="p">,</span> <span class="n">zmaxfg</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">zmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">zmax</span><span class="p">]</span>
            <span class="n">cellsizefg</span> <span class="o">=</span> <span class="n">cellsize</span>
            <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">plot_helpers</span><span class="o">.</span><span class="n">CELLSIZE</span> <span class="o">=</span> <span class="n">cellsize</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Found 2D DCCRG mesh without FSgrid data. Exiting.&quot;</span><span class="p">)</span>


    <span class="c1"># Read Bx data</span>
    <span class="n">sheet_datamap_info</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read_variable_info</span><span class="p">(</span><span class="s2">&quot;vg_b_vol&quot;</span><span class="p">,</span> <span class="n">operator</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>

    <span class="n">sheet_datamap</span> <span class="o">=</span> <span class="n">sheet_datamap_info</span><span class="o">.</span><span class="n">data</span>

    <span class="c1"># Verify data shape</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">sheet_datamap</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Error, read only single Bx value from vlsv file! sheet_datamap.shape being &quot;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sheet_datamap</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

    

    <span class="c1">#Define the box limits</span>
    <span class="n">low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">boxcoords</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">boxcoords</span><span class="p">[</span><span class="mi">4</span><span class="p">]])</span><span class="o">*</span><span class="n">axisunit</span>
    <span class="n">up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">boxcoords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">boxcoords</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">boxcoords</span><span class="p">[</span><span class="mi">5</span><span class="p">]])</span><span class="o">*</span><span class="n">axisunit</span>

    <span class="c1"># Choose CellIDs inside the box</span>
    <span class="n">ids</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">ids3d</span><span class="o">.</span><span class="n">ids3d_box</span><span class="p">(</span><span class="n">cellids</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="n">reflevel</span><span class="p">,</span> <span class="n">xsize</span><span class="p">,</span> <span class="n">ysize</span><span class="p">,</span> <span class="n">zsize</span><span class="p">,</span> <span class="p">[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">zmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">zmax</span><span class="p">])</span>

    <span class="n">sheet_datamap</span> <span class="o">=</span> <span class="n">sheet_datamap</span><span class="p">[</span><span class="n">indexids</span><span class="p">]</span>
    <span class="n">sheet_datamap</span> <span class="o">=</span> <span class="n">sheet_datamap</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

    <span class="c1"># Reshape surface data</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">sheet_datamap</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">sheet_data_in_box</span> <span class="o">=</span> <span class="n">ids3d</span><span class="o">.</span><span class="n">idmesh3d2</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">sheet_datamap</span><span class="p">,</span> <span class="n">reflevel</span><span class="p">,</span> <span class="n">xsize</span><span class="p">,</span> <span class="n">ysize</span><span class="p">,</span> <span class="n">zsize</span><span class="p">,</span>  <span class="kc">None</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Dimension error in constructing sheet!&quot;</span><span class="p">)</span>

    <span class="c1"># Remove empty rows, columns and tubes</span>
    <span class="n">empty_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">sheet_data_in_box</span><span class="o">==</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">empty_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">sheet_data_in_box</span><span class="o">==</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

    <span class="n">boxMaskX</span> <span class="o">=</span> <span class="n">empty_1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">boxMaskY</span> <span class="o">=</span> <span class="n">empty_0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">boxMaskZ</span> <span class="o">=</span> <span class="n">empty_1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">cropped_sheet_data</span> <span class="o">=</span> <span class="n">sheet_data_in_box</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">boxMaskX</span><span class="p">):</span><span class="nb">max</span><span class="p">(</span><span class="n">boxMaskX</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,:,:]</span>
    <span class="n">cropped_sheet_data</span> <span class="o">=</span> <span class="n">cropped_sheet_data</span><span class="p">[:,</span><span class="nb">min</span><span class="p">(</span><span class="n">boxMaskY</span><span class="p">):</span><span class="nb">max</span><span class="p">(</span><span class="n">boxMaskY</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,:]</span>
    <span class="n">cropped_sheet_data</span> <span class="o">=</span> <span class="n">cropped_sheet_data</span><span class="p">[:,:,</span><span class="nb">min</span><span class="p">(</span><span class="n">boxMaskZ</span><span class="p">):</span><span class="nb">max</span><span class="p">(</span><span class="n">boxMaskZ</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>


    <span class="c1"># Keep removing the face of the rectangle with the largest number of invalid values until the surface has only proper values</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">zero_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">zero_counts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">cropped_sheet_data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>  <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># Face 0 (front)</span>
        <span class="n">zero_counts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">cropped_sheet_data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Face 1 (back)</span>
        <span class="n">zero_counts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">cropped_sheet_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>  <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># Face 2 (left)</span>
        <span class="n">zero_counts</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">cropped_sheet_data</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Face 3 (right)</span>
        <span class="n">zero_counts</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">cropped_sheet_data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>  <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># Face 4 (top)</span>
        <span class="n">zero_counts</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">cropped_sheet_data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Face 5 (bottom)</span>

        <span class="n">face_to_be_removed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">zero_counts</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">face_to_be_removed</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">cropped_sheet_data</span> <span class="o">=</span> <span class="n">cropped_sheet_data</span><span class="p">[</span><span class="mi">1</span><span class="p">:,:,:]</span>
        <span class="k">elif</span> <span class="n">face_to_be_removed</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">cropped_sheet_data</span> <span class="o">=</span> <span class="n">cropped_sheet_data</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:,:]</span>
        <span class="k">elif</span> <span class="n">face_to_be_removed</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">cropped_sheet_data</span> <span class="o">=</span> <span class="n">cropped_sheet_data</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:,:]</span>
        <span class="k">elif</span> <span class="n">face_to_be_removed</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
            <span class="n">cropped_sheet_data</span> <span class="o">=</span> <span class="n">cropped_sheet_data</span><span class="p">[:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span>
        <span class="k">elif</span> <span class="n">face_to_be_removed</span><span class="o">==</span><span class="mi">4</span><span class="p">:</span>
            <span class="n">cropped_sheet_data</span> <span class="o">=</span> <span class="n">cropped_sheet_data</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">elif</span> <span class="n">face_to_be_removed</span><span class="o">==</span><span class="mi">5</span><span class="p">:</span>
            <span class="n">cropped_sheet_data</span> <span class="o">=</span> <span class="n">cropped_sheet_data</span><span class="p">[:,:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">counter</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">counter</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>    <span class="c1"># Failsafe</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Error reading sheet variable vg_b_vol! Exiting.&quot;</span><span class="p">)</span>

        
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">zero_counts</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
            <span class="k">break</span> 

    <span class="n">spacing</span> <span class="o">=</span> <span class="p">((</span><span class="n">xmaxfg</span><span class="o">-</span><span class="n">xminfg</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">xsizefg</span><span class="o">*</span><span class="n">axisunit</span><span class="p">),</span> <span class="p">(</span><span class="n">ymaxfg</span><span class="o">-</span><span class="n">yminfg</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">ysizefg</span><span class="o">*</span><span class="n">axisunit</span><span class="p">),</span> <span class="p">(</span><span class="n">zmaxfg</span><span class="o">-</span><span class="n">zminfg</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">zsizefg</span><span class="o">*</span><span class="n">axisunit</span><span class="p">))</span>

    <span class="n">verts</span><span class="p">,</span> <span class="n">faces</span><span class="p">,</span> <span class="n">normals</span><span class="p">,</span> <span class="n">arrays</span> <span class="o">=</span> <span class="n">measure</span><span class="o">.</span><span class="n">marching_cubes</span><span class="p">(</span><span class="n">cropped_sheet_data</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                                                                   <span class="n">spacing</span><span class="o">=</span><span class="n">spacing</span><span class="p">,</span>
                                                                   <span class="n">gradient_direction</span><span class="o">=</span><span class="s1">&#39;descent&#39;</span><span class="p">,</span>
                                                                   <span class="n">step_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                                   <span class="n">allow_degenerate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;lewiner&#39;</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">cropped_sheet_data</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span>
    

    <span class="c1">#offset with respect to simulation domain corner</span>
    <span class="n">verts</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">verts</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">low</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">axisunit</span>
    <span class="n">verts</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">verts</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">low</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">axisunit</span>
    <span class="n">verts</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">verts</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">low</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">axisunit</span>

    <span class="n">nverts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">verts</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">all_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nverts</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nverts</span><span class="p">):</span>            
        <span class="n">coords</span> <span class="o">=</span> <span class="n">verts</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">*</span><span class="n">axisunit</span>
        <span class="n">all_coords</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">coords</span>

    <span class="n">all_x</span> <span class="o">=</span> <span class="n">all_coords</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>     <span class="c1"># Coordinates of the sheet</span>
    <span class="n">all_y</span> <span class="o">=</span> <span class="n">all_coords</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">all_z</span> <span class="o">=</span> <span class="n">all_coords</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">folds</span><span class="o">=</span><span class="p">[]</span>    <span class="c1"># List to hold fold locations</span>
    <span class="n">pointdict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Dictionary to keep track of which xy locations have already been recorded</span>
    <span class="n">flagdict</span> <span class="o">=</span> <span class="p">{}</span>   <span class="c1"># Dictionary to keep track of fold locations</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_x</span><span class="p">)):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">all_x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">cellsizefg</span><span class="p">),</span><span class="nb">round</span><span class="p">(</span><span class="n">all_y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">cellsizefg</span><span class="p">))</span>     <span class="c1"># Key for hashing xy coordinates, precise to one cell</span>
        
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pointdict</span><span class="p">:</span>    <span class="c1"># If no value given to XY coordinate, save sheet coordinates to dictionary</span>
            <span class="n">pointdict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">all_x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">all_y</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">all_z</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
            
        <span class="k">else</span><span class="p">:</span>   <span class="c1"># If the XY coordinate already has a sheet coordinate associated with it, check if the sheet is folded and pick the upper (lower) z value</span>

            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">all_z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">cellsizefg</span><span class="p">)</span> <span class="o">-</span> <span class="nb">round</span><span class="p">(</span><span class="n">pointdict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">cellsizefg</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># If z values differ by more than one fg dx</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">flagdict</span><span class="p">:</span>     <span class="c1"># Only calculate folds if there are three different z values within the same xy location, record the first double instance</span>
                    <span class="n">flagdict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>   <span class="c1"># Three distinct z values for the same xy location: folding has occurred</span>
                    <span class="n">folds</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">all_x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">all_y</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
            
            <span class="k">if</span> <span class="n">sheetlayer</span><span class="o">==</span><span class="s1">&#39;above&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">all_z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">pointdict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">2</span><span class="p">]:</span>
                    <span class="n">pointdict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">all_x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">all_y</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">all_z</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">all_z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">pointdict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">2</span><span class="p">]:</span>
                    <span class="n">pointdict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">all_x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">all_y</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">all_z</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>


    <span class="n">sheet_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">pointdict</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>     <span class="c1"># All sheet coordinates</span>
    <span class="n">xy_points</span> <span class="o">=</span> <span class="n">sheet_points</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>     <span class="c1"># Sheet XY values</span>
    <span class="n">z_points</span> <span class="o">=</span> <span class="n">sheet_points</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>        <span class="c1"># Sheet Z values</span>

    <span class="n">z_interpolation</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">RBFInterpolator</span><span class="p">(</span><span class="n">xy_points</span><span class="p">,</span> <span class="n">z_points</span><span class="p">,</span> <span class="n">neighbors</span><span class="o">=</span><span class="mi">27</span><span class="p">)</span>  <span class="c1"># Function to interpolate the location of the sheet</span>

    <span class="n">x_flat</span> <span class="o">=</span> <span class="n">XmeshPass</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">*</span><span class="n">axisunit</span>
    <span class="n">y_flat</span> <span class="o">=</span> <span class="n">YmeshPass</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">*</span><span class="n">axisunit</span>

    <span class="c1"># Combine the flattened arrays into an array of coordinate pairs</span>
    <span class="n">xy_pairs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">x_flat</span><span class="p">,</span> <span class="n">y_flat</span><span class="p">))</span>

    <span class="n">sheet_zs</span> <span class="o">=</span> <span class="n">z_interpolation</span><span class="p">(</span><span class="n">xy_pairs</span><span class="p">)</span>    <span class="c1"># Interpolated sheet location at grid values</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">xy_pairs</span><span class="p">,</span> <span class="n">sheet_zs</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])),</span> <span class="n">folds</span>    <span class="c1"># Return list of sheet coordinates interpolated to grid values and information of the possible foldings</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, University of Helsinki.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>